{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h3 class="mb-3">Panel mínimo para Caja, Ventas y Movimientos (multi-items)</h3>

  {% if caja %}
  <div class="alert alert-info d-flex align-items-center justify-content-between">
    <div>
      <strong>Caja ABIERTA #{{ caja.id }}</strong> — Apertura: {{ caja.fecha_apertura|date:"d/m H:i" }} ({{ caja.usuario_apertura.username }})<br>
      Saldo inicial efectivo: ${{ caja.saldo_inicial_efectivo|default:"0.00" }}<br>
      Saldo efectivo teórico: <strong>${{ caja.saldo_efectivo_teorico|default:"0.00" }}</strong>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'pos_cerrar_caja' %}?mode=count">Conteo EFECTIVO</a>
      <a class="btn btn-danger" href="{% url 'pos_cerrar_caja' %}">Cerrar caja</a>
    </div>
  </div>

  <div class="row g-3">
    <!-- ===== Registrar venta (multi items) ===== -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Registrar venta (múltiples items)</div>
        <div class="card-body">
          <form id="venta-form" autocomplete="off">
            {% csrf_token %}

            <!-- Items dinámicos -->
            <div id="items-list"></div>
            <div class="mb-2 d-flex gap-2">
              <button type="button" id="btn-add-item" class="btn btn-outline-primary btn-sm">+ Agregar ítem</button>
              <button type="button" id="btn-clear-items" class="btn btn-outline-danger btn-sm">Vaciar</button>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Medio de pago</label>
                <select id="medio-pago" class="form-select" required>
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="QR_MP">QR / MercadoPago</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="OTRO">Otro</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Comprobante</label>
                <select id="tipo-comp" class="form-select" required>
                  <option value="COMANDA">Comanda (sin fiscal)</option>
                  <option value="BISTRO">Bistró (con factura)</option>
                </select>
              </div>
            </div>

            <div class="mt-3 fs-5">
              <strong>Total:</strong> <span id="preview-total">$0.00</span>
            </div>

            <div class="mt-3">
              <button id="btn-vender" class="btn btn-success" type="submit">Cargar venta</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Movimiento de caja ===== -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Movimiento de caja (Ingreso/Egreso/Ajuste/Retiro)</div>
        <div class="card-body">
          <form id="mov-form">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select id="mov-tipo" class="form-select">
                  <option value="INGRESO">INGRESO</option>
                  <option value="EGRESO">EGRESO</option>
                  <option value="AJUSTE">AJUSTE</option>
                  <option value="RETIRO">RETIRO</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Medio</label>
                <select id="mov-medio" class="form-select">
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="QR_MP">QR / MercadoPago</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="OTRO">Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Monto</label>
                <input id="mov-monto" type="number" step="0.01" min="0" class="form-control" value="0.00">
              </div>
            </div>
            <div class="mt-2">
              <input id="mov-desc" class="form-control" placeholder="Detalle (opcional)">
            </div>
            <div class="mt-3">
              <button id="btn-mov" class="btn btn-primary" type="button">Registrar movimiento</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Totales ===== -->
    <div class="col-lg-6">
      <div class="card mt-3">
        <div class="card-header">Totales por medio de pago (VENTAS)</div>
        <div class="card-body">
          {% if tot_mp %}
            {% for k,v in tot_mp.items %}
              <span class="badge text-bg-light me-2">{{ k }} <span class="badge text-bg-primary">${{ v|default:"0.00" }}</span></span>
            {% endfor %}
          {% else %}
            <div class="text-muted">Sin ventas aún.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card mt-3">
        <div class="card-header">Totales por tipo de movimiento</div>
        <div class="card-body">
          {% if tot_tipo %}
            {% for k,v in tot_tipo.items %}
              <span class="badge text-bg-light me-2">{{ k }} <span class="badge text-bg-secondary">${{ v|default:"0.00" }}</span></span>
            {% endfor %}
          {% else %}
            <div class="text-muted">Sin movimientos aún.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ===== Últimas ventas ===== -->
    <div class="col-12">
      <div class="card mt-3">
        <div class="card-header">Últimas ventas</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr><th>#</th><th>Fecha</th><th>Caja</th><th>Usuario</th><th>Comp.</th><th>Medio</th><th>Total</th><th>Estado</th></tr>
              </thead>
              <tbody>
              {% for v in ultimas_ventas %}
                <tr>
                  <td>{{ v.id }}</td>
                  <td>{{ v.fecha|date:"d/m H:i" }}</td>
                  <td>#{{ v.caja_id }}</td>
                  <td>{{ v.usuario.username }}</td>
                  <td>{{ v.tipo_comprobante }}</td>
                  <td>{{ v.medio_pago }}</td>
                  <td>${{ v.total }}</td>
                  <td>{{ v.estado }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="8" class="text-center text-muted">Sin ventas registradas.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!--/row-->

  {% else %}
    <div class="alert alert-warning">
      No hay caja abierta. Abrila desde <a href="{% url 'admin:index' %}">/admin</a> o implemente el flujo de apertura.
    </div>
  {% endif %}
</div>

{% if caja %}
<script>
(function(){
  // ===== CSRF =====
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`); if(v.length===2) return v.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Helpers =====
  const itemsList=document.getElementById('items-list');
  const btnAdd=document.getElementById('btn-add-item');
  const btnClear=document.getElementById('btn-clear-items');
  const previewTotal=document.getElementById('preview-total');
  const formVenta=document.getElementById('venta-form');
  const btnVender=document.getElementById('btn-vender');

  const medioPagoSel=document.getElementById('medio-pago');
  const compSel=document.getElementById('tipo-comp');

  // Plantilla de fila (sin backticks para que no choque con {{ }})
  function rowTemplate(){
    return '' +
      '<div class="row g-2 align-items-end mb-2 item-row">' +
        '<div class="col-8">' +
          '<label class="form-label">Producto</label>' +
          '<select name="item_producto" class="form-select item-producto" required>' +
            '<option value="" hidden>Elegir…</option>' +
            '{% for pr in productos %}' +
              '<option value="{{ pr.id }}" data-precio="{{ pr.precio }}">{{ pr.nombre }} - ${{ pr.precio }}</option>' +
            '{% endfor %}' +
          '</select>' +
        '</div>' +
        '<div class="col-3">' +
          '<label class="form-label">Cant.</label>' +
          '<input type="number" name="item_cantidad" class="form-control item-cantidad" value="1" min="1">' +
        '</div>' +
        '<div class="col-1 text-end">' +
          '<button type="button" class="btn btn-outline-danger btn-sm item-remove" title="Quitar">✖</button>' +
        '</div>' +
      '</div>';
  }

  function addRow(){
    const wrap=document.createElement('div');
    wrap.innerHTML=rowTemplate();
    itemsList.appendChild(wrap.firstChild);
  }

  function recalcTotal(){
    let t=0;
    itemsList.querySelectorAll('.item-row').forEach(row=>{
      const sel=row.querySelector('.item-producto');
      const q=row.querySelector('.item-cantidad');
      if(sel && sel.value){
        const p=parseFloat(sel.selectedOptions[0].dataset.precio||0);
        const c=parseInt(q.value||0,10);
        t += p*c;
      }
    });
    previewTotal.textContent='$'+t.toFixed(2);
    return t;
  }

  // Eventos
  btnAdd.addEventListener('click', ()=>{ addRow(); recalcTotal(); });
  btnClear.addEventListener('click', ()=>{ itemsList.innerHTML=''; recalcTotal(); });

  itemsList.addEventListener('change', ev=>{
    if(ev.target.classList.contains('item-producto') || ev.target.classList.contains('item-cantidad')){
      recalcTotal();
    }
  });
  itemsList.addEventListener('click', ev=>{
    const b=ev.target.closest('.item-remove'); if(!b) return;
    b.closest('.item-row').remove();
    recalcTotal();
  });

  // Envío de venta — evita doble POST
  let sending=false;
  formVenta.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    if(sending) return;
    const rows=itemsList.querySelectorAll('.item-row');
    if(!rows.length){ alert('Agregá al menos un ítem.'); return; }

    const fd=new FormData();
    rows.forEach(r=>{
      const sel=r.querySelector('.item-producto');
      const q=r.querySelector('.item-cantidad');
      if(sel && sel.value && q && q.value){
        fd.append('item_producto', sel.value);
        fd.append('item_cantidad', q.value);
      }
    });
    if(!fd.has('item_producto')){ alert('Elegí al menos un producto.'); return; }

    fd.append('medio_pago', medioPagoSel.value);
    fd.append('tipo_comprobante', compSel.value);

    sending=true;
    btnVender.disabled=true;
    btnVender.textContent='Cargando…';

    try{
      const res=await fetch("{% url 'pos_registrar_venta' %}", {
        method:'POST',
        headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'},
        body:fd
      });
      if(!res.ok){ location.reload(); return; }
      const data=await res.json();
      if(data.ok){ location.reload(); }
      else{ alert(data.error||'No se pudo registrar la venta'); location.reload(); }
    }catch(e){ location.reload(); }
  });

  // Movimiento manual
  document.getElementById('btn-mov').addEventListener('click', async ()=>{
    const fd=new URLSearchParams();
    fd.append('tipo', document.getElementById('mov-tipo').value);
    fd.append('medio', document.getElementById('mov-medio').value);
    fd.append('monto', document.getElementById('mov-monto').value||'0');
    fd.append('descripcion', document.getElementById('mov-desc').value||'');

    try{
      const res=await fetch("{% url 'pos_registrar_mov' %}", {
        method:'POST',
        headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
        body:fd.toString()
      });
      if(!res.ok){ location.reload(); return; }
      const data=await res.json();
      if(data.ok){ location.reload(); } else { alert(data.error||'No se pudo registrar'); }
    }catch(e){ location.reload(); }
  });

  // fila inicial
  addRow();
  recalcTotal();
})();
</script>
{% endif %}
{% endblock %}
