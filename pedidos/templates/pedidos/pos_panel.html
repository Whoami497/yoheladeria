{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div id="pos-root" class="container-fluid py-3">

  <!-- Ocultar barra lateral SOLO en este panel -->
  <style>
    /* intenta varias clases/elementos comunes del sidebar para ocultarlo */
    .sidebar, aside, .left-menu, .app-sidebar, nav.list-group, .col-sidebar { display:none !important; }
    /* expande el área principal */
    #pos-root, .container, .container-fluid, main, .col-main, .col { width:100% !important; max-width:100% !important; }
    /* estética general */
    .pos-cards .card { border:0; box-shadow:0 2px 12px rgba(0,0,0,.08); border-radius:14px; }
    .kpi { display:flex; gap:.5rem; align-items:center; color:#1d2b3a; }
    .kpi .amt { font-weight:700; font-size:1.05rem; }
    .kpi .muted{ color:#6b7280; font-size:.8rem }
    .pill { border-radius:999px; padding:.35rem .8rem; background:#0d1b2a; color:#fff; font-size:.85rem; }
    .tab-btn { border:0; padding:.6rem 1rem; border-radius:12px; background:#f1f5f9; color:#0f172a; font-weight:600; }
    .tab-btn.active { background:#0ea5e9; color:#fff; }
    .catalog-grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(170px,1fr) ); gap:.75rem; }
    .catalog-item { border:0; border-radius:14px; box-shadow:0 2px 10px rgba(0,0,0,.06); cursor:pointer; padding:.85rem; background:#fff; display:flex; flex-direction:column; gap:.35rem; }
    .catalog-item .name{ font-weight:600; line-height:1.15; }
    .catalog-item .price{ color:#0ea5e9; font-weight:700; }
    .ticket { border-radius:14px; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.08); }
    .ticket thead th { font-size:.8rem; color:#64748b; font-weight:600; }
    .ticket tfoot td { font-size:1.2rem; font-weight:800; }
    .btn-icon { border:1px solid #e5e7eb; width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; }
    .stack-sm { display:flex; gap:.5rem; flex-wrap:wrap }
    .stack { display:flex; gap:1rem; align-items:center; flex-wrap:wrap }
    .section-title{ font-weight:700; }
    .divider { height:1px; background:#e5e7eb; margin:.75rem 0; }
    .badge-soft { background:#e2e8f0; color:#0f172a; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; font-weight:600 }
    .floating-cta { position:sticky; bottom:0; background:#fff; border-top:1px solid #e5e7eb; padding:.75rem; display:flex; justify-content:flex-end; gap:.5rem; z-index:5 }
    .btn-wide { min-width:140px }
  </style>

  {% if caja %}

  <!-- HEADER CAJA -->
  <div class="pos-cards row g-3 align-items-center mb-3">
    <div class="col">
      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div class="kpi">
            <div>
              <div class="section-title">Caja <span class="badge-soft">ABIERTA #{{ caja.id }}</span></div>
              <div class="muted">Apertura: {{ caja.fecha_apertura|date:"d/m H:i" }} — {{ caja.usuario_apertura.username }}</div>
              <div class="muted">Saldo inicial efectivo: <b>${{ caja.saldo_inicial_efectivo|default:"0.00" }}</b></div>
            </div>
          </div>
          <div class="stack">
            <button class="btn btn-outline-secondary" id="btn-count-cash">Conteo EFECTIVO</button>
            <form id="close-form" method="post" action="{% url 'pos_cerrar_caja' %}" class="d-none">
              {% csrf_token %}<input type="hidden" name="saldo_cierre_efectivo" id="saldo-cierre-input">
            </form>
            <button class="btn btn-danger" id="btn-close-cash">Cerrar caja</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="d-flex gap-2 mb-3">
    <button class="tab-btn active" data-tab="venta">Venta</button>
    <button class="tab-btn" data-tab="caja">Caja</button>
  </div>

  <!-- ======= TAB: VENTA ======= -->
  <section id="tab-venta" class="tab-pane">
    <div class="row g-3">
      <!-- Ticket / Ítems -->
      <div class="col-lg-5">
        <div class="ticket p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">Ítems</div>
            <div class="stack-sm">
              <button id="btn-clear" type="button" class="btn btn-outline-danger btn-sm">Vaciar</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-2">
              <thead>
                <tr><th>Producto</th><th style="width:120px">Cant.</th><th class="text-end" style="width:120px">Precio</th><th class="text-end" style="width:120px">Subtot.</th><th></th></tr>
              </thead>
              <tbody id="ticket-body"></tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="text-end">TOTAL</td>
                  <td class="text-end" id="ticket-total">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="divider"></div>

          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Comprobante</label>
              <select id="tipo-comp" class="form-select">
                <option value="BISTRO">Bistró (con factura)</option>
                <option value="COMANDA">Comanda (sin fiscal)</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Medio de pago</label>
              <select id="medio-pago" class="form-select">
                <option value="EFECTIVO">Efectivo</option>
                <option value="QR_MP">QR / MercadoPago</option>
                <option value="TARJETA">Tarjeta</option>
                <option value="TRANSFERENCIA">Transferencia</option>
                <option value="OTRO">Otro</option>
              </select>
            </div>
          </div>

          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="pago-dividido">
            <label class="form-check-label" for="pago-dividido">Pago dividido / parcial</label>
          </div>

          <!-- líneas de pago parcial -->
          <div id="pagos-parciales" class="mt-2" style="display:none">
            <div class="stack-sm mb-1">
              <button type="button" id="btn-add-pago" class="btn btn-outline-primary btn-sm">+ Agregar medio</button>
              <span class="badge-soft">Tiene que sumar al total</span>
            </div>
            <div id="pagos-list"></div>
          </div>

          <div class="floating-cta">
            <button id="btn-cobrar" type="button" class="btn btn-success btn-wide">Cobrar</button>
          </div>
        </div>
      </div>

      <!-- Catálogo por categorías -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="section-title">Productos</div>
              <div class="stack-sm" id="cat-pills">
                <!-- se generan con regroup -->
                {% regroup productos by categoria as grupos %}
                {% for g in grupos %}
                  <button type="button" class="pill cat-pill {% if forloop.first %}active{% endif %}" data-cat="cat-{{ forloop.counter }}">{{ g.grouper }}</button>
                {% endfor %}
              </div>
            </div>

            {% regroup productos by categoria as grupos2 %}
            {% for g in grupos2 %}
              <div class="catalog-grid cat-panel {% if not forloop.first %}d-none{% endif %}" id="cat-{{ forloop.counter }}">
                {% for pr in g.list %}
                  <div class="catalog-item" data-id="{{ pr.id }}" data-precio="{{ pr.precio|floatformat:2 }}" data-nombre="{{ pr.nombre|escape }}">
                    <div class="name">{{ pr.nombre }}</div>
                    <div class="price">${{ pr.precio }}</div>
                    <div class="stack-sm">
                      <button type="button" class="btn btn-outline-secondary btn-sm add-1">+1</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm add-2">+2</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% empty %}
              <div class="text-muted">No hay productos.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ======= TAB: CAJA ======= -->
  <section id="tab-caja" class="tab-pane d-none">
    <div class="row g-3">
      <!-- KPIs -->
      <div class="col-12">
        <div class="row row-cols-2 row-cols-md-6 g-2">
          <div class="col">
            <div class="card"><div class="card-body">
              <div class="muted">EFECTIVO</div><div class="amt">${{ totales_medio.EFECTIVO|default:"0.00" }}</div>
            </div></div>
          </div>
          <div class="col"><div class="card"><div class="card-body">
            <div class="muted">TARJETA</div><div class="amt">${{ totales_medio.TARJETA|default:"0.00" }}</div>
          </div></div></div>
          <div class="col"><div class="card"><div class="card-body">
            <div class="muted">QR / MP</div><div class="amt">${{ totales_medio.QR_MP|default:"0.00" }}</div>
          </div></div></div>
          <div class="col"><div class="card"><div class="card-body">
            <div class="muted">TRANSFERENCIA</div><div class="amt">${{ totales_medio.TRANSFERENCIA|default:"0.00" }}</div>
          </div></div></div>
          <div class="col"><div class="card"><div class="card-body">
            <div class="muted">VENTAS (hoy)</div><div class="amt">${{ totales_tipo.VENTA|default:"0.00" }}</div>
          </div></div></div>
          <div class="col"><div class="card"><div class="card-body">
            <div class="muted">EFECTIVO TEÓRICO</div><div class="amt">${{ saldo_teorico|default:"0.00" }}</div>
          </div></div></div>
        </div>
      </div>

      <!-- Movimiento caja -->
      <div class="col-lg-6">
        <div class="card"><div class="card-header">Movimiento de caja</div><div class="card-body">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Tipo</label>
              <select id="mov-tipo" class="form-select">
                <option>INGRESO</option><option>EGRESO</option><option>AJUSTE</option><option>RETIRO</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Medio</label>
              <select id="mov-medio" class="form-select">
                <option>EFECTIVO</option><option>QR_MP</option><option>TARJETA</option><option>TRANSFERENCIA</option><option>OTRO</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Monto</label>
              <input id="mov-monto" type="number" step="0.01" min="0" value="0.00" class="form-control">
            </div>
          </div>
          <input id="mov-desc" class="form-control mt-2" placeholder="Detalle (opcional)">
          <button id="btn-mov" type="button" class="btn btn-primary mt-2">Registrar movimiento</button>
        </div></div>
      </div>

      <!-- Últimas ventas -->
      <div class="col-lg-6">
        <div class="card"><div class="card-header">Últimas ventas</div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0">
                <thead><tr><th>#</th><th>Fecha</th><th>Caja</th><th>Usuario</th><th>Comp.</th><th>Medio</th><th>Total</th><th>Estado</th></tr></thead>
                <tbody>
                  {% for v in ventas %}
                    <tr>
                      <td>{{ v.id }}</td><td>{{ v.fecha|date:"d/m H:i" }}</td><td>#{{ v.caja_id }}</td>
                      <td>{{ v.usuario.username }}</td><td>{{ v.tipo_comprobante }}</td><td>{{ v.medio_pago }}</td>
                      <td>${{ v.total }}</td><td>{{ v.estado }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="8" class="text-center text-muted">Sin ventas.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones rápidas -->
      <div class="col-12">
        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-outline-danger" id="btn-retirar">Retirar</button>
          <button class="btn btn-outline-success" id="btn-depositar">Depositar</button>
          <button class="btn btn-warning" id="btn-close-cash-2">Cerrar caja</button>
          <button class="btn btn-outline-secondary" id="btn-imp-parcial">Impresión parcial</button>
        </div>
      </div>
    </div>
  </section>

  {% else %}
  <!-- CAJA CERRADA: abrir -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Abrir caja</div>
        <div class="card-body">
          <form id="abrir-form" action="{% url 'pos_abrir_caja' %}" method="post" autocomplete="off">
            {% csrf_token %}
            <label class="form-label">Saldo inicial en EFECTIVO</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input class="form-control" type="number" step="0.01" min="0" name="saldo_inicial_efectivo" value="0.00">
            </div>
            <button id="btn-abrir" class="btn btn-success mt-3" type="submit">Abrir caja</button>
          </form>
          <p class="text-muted small mt-2 mb-0">Crea una caja en estado <b>ABIERTA</b> y vuelve a este panel.</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% if caja %}
{% block extra_js %}
<script>
(function(){
  // ===== CSRF =====
  function getCookie(name){
    const m = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
    return m ? m[2] : null;
  }
  const CSRF = getCookie('csrftoken');

  // ===== TABS =====
  const tabBtns = document.querySelectorAll('.tab-btn');
  tabBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      tabBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('d-none'));
      document.getElementById('tab-'+b.dataset.tab).classList.remove('d-none');
    });
  });

  // ===== CATALOGO =====
  const ticketBody = document.getElementById('ticket-body');
  const totalEl    = document.getElementById('ticket-total');
  const map = new Map(); // key: prodId -> {id,nombre,precio,cant}
  function fmt(n){ return '$'+(Number(n)||0).toFixed(2); }

  function renderTicket(){
    ticketBody.innerHTML = '';
    let total = 0;
    for(const [id,item] of map){
      const sub = item.precio*item.cant;
      total += sub;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nombre}</td>
        <td>
          <div class="stack-sm">
            <button class="btn-icon minus">-</button>
            <input class="form-control form-control-sm qty" style="width:56px" type="number" min="1" value="${item.cant}">
            <button class="btn-icon plus">+</button>
          </div>
        </td>
        <td class="text-end">${fmt(item.precio)}</td>
        <td class="text-end">${fmt(sub)}</td>
        <td class="text-end"><button class="btn btn-outline-danger btn-sm del">x</button></td>
      `;
      // bind
      tr.querySelector('.minus').onclick = ()=>{ item.cant=Math.max(1,item.cant-1); renderTicket(); };
      tr.querySelector('.plus').onclick  = ()=>{ item.cant++; renderTicket(); };
      tr.querySelector('.qty').oninput   = (e)=>{ item.cant=Math.max(1,parseInt(e.target.value||'1',10)); renderTicket(); };
      tr.querySelector('.del').onclick   = ()=>{ map.delete(id); renderTicket(); };
      ticketBody.appendChild(tr);
    }
    totalEl.textContent = fmt(total);
    document.getElementById('btn-cobrar').disabled = total<=0;
  }

  // cat pills
  document.querySelectorAll('.cat-pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      document.querySelectorAll('.cat-pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      document.querySelectorAll('.cat-panel').forEach(x=>x.classList.add('d-none'));
      document.getElementById(p.dataset.cat).classList.remove('d-none');
    });
  });

  // add product handlers
  document.querySelectorAll('.catalog-item').forEach(card=>{
    function add(n){
      const id = card.dataset.id;
      const precio = parseFloat(card.dataset.precio);
      const nombre = card.dataset.nombre;
      if(!map.has(id)) map.set(id,{id,nombre,precio,cant:0});
      map.get(id).cant += n;
      renderTicket();
    }
    card.addEventListener('click', (e)=>{
      // evitar doble add al click de botones internos
      if(e.target.classList.contains('add-1')) add(1);
      else if(e.target.classList.contains('add-2')) add(2);
      else add(1);
    });
    card.querySelector('.add-1').onclick = (ev)=>{ ev.stopPropagation(); add(1); };
    card.querySelector('.add-2').onclick = (ev)=>{ ev.stopPropagation(); add(2); };
  });

  document.getElementById('btn-clear').onclick = ()=>{ map.clear(); renderTicket(); };

  // ===== PAGO DIVIDIDO =====
  const chDiv   = document.getElementById('pago-dividido');
  const divWrap = document.getElementById('pagos-parciales');
  const pagosList = document.getElementById('pagos-list');
  chDiv.onchange = ()=>{ divWrap.style.display = chDiv.checked?'block':'none'; if(!chDiv.checked) pagosList.innerHTML=''; };

  function addPagoRow(){
    const row = document.createElement('div');
    row.className='row g-2 align-items-end mb-1';
    row.innerHTML = `
      <div class="col-6">
        <select class="form-select medio">
          <option value="EFECTIVO">Efectivo</option>
          <option value="QR_MP">QR / MercadoPago</option>
          <option value="TARJETA">Tarjeta</option>
          <option value="TRANSFERENCIA">Transferencia</option>
          <option value="OTRO">Otro</option>
        </select>
      </div>
      <div class="col-4">
        <input class="form-control monto" type="number" step="0.01" min="0" placeholder="Monto">
      </div>
      <div class="col-2 text-end">
        <button class="btn btn-outline-danger btn-sm del">x</button>
      </div>
    `;
    row.querySelector('.del').onclick = ()=>{ row.remove(); };
    pagosList.appendChild(row);
  }
  document.getElementById('btn-add-pago').onclick = addPagoRow;

  // ===== COBRAR =====
  document.getElementById('btn-cobrar').onclick = async ()=>{
    if(map.size===0){ alert('Agregá al menos un producto.'); return; }

    const fd = new FormData();
    for(const [,item] of map){
      fd.append('item_producto', item.id);
      fd.append('item_cantidad', String(item.cant));
    }
    fd.append('tipo_comprobante', document.getElementById('tipo-comp').value);

    if(chDiv.checked){
      const pagos=[];
      pagosList.querySelectorAll('.row').forEach(r=>{
        const medio = r.querySelector('.medio').value;
        const monto = parseFloat(r.querySelector('.monto').value||'0');
        if(monto>0) pagos.push({medio, monto});
      });
      if(!pagos.length){ alert('Ingresá al menos un pago.'); return; }
      fd.append('pagos_json', JSON.stringify(pagos));
    }else{
      fd.append('medio_pago', document.getElementById('medio-pago').value);
    }

    const btn = document.getElementById('btn-cobrar');
    btn.disabled = true; btn.textContent = 'Cobrando…';

    try{
      const res = await fetch("{% url 'pos_vender' %}", {
        method:'POST',
        headers:{'X-CSRFToken': CSRF, 'X-Requested-With':'XMLHttpRequest'},
        body: fd
      });
      const data = await res.json().catch(()=>null);
      if(res.ok && data && data.ok){ location.reload(); }
      else{
        // si por algún motivo vino html, mostrar primer trozo
        const msg = (data && (data.error||data.detail)) || 'No se pudo registrar la venta';
        alert(msg);
        location.reload();
      }
    }catch(e){
      location.reload();
    }
  };

  // ===== MOVIMIENTO =====
  document.getElementById('btn-mov').onclick = async ()=>{
    const params = new URLSearchParams();
    params.append('tipo', document.getElementById('mov-tipo').value);
    params.append('medio_pago', document.getElementById('mov-medio').value);
    params.append('monto', document.getElementById('mov-monto').value||'0');
    params.append('descripcion', document.getElementById('mov-desc').value||'');

    try{
      const res = await fetch("{% url 'pos_movimiento' %}", {
        method:'POST',
        headers:{
          'X-CSRFToken': CSRF,
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/x-www-form-urlencoded'
        },
        body: params.toString()
      });
      const data = await res.json().catch(()=>null);
      if(res.ok && data && data.ok){ location.reload(); }
      else{ alert((data && data.error) || 'No se pudo registrar el movimiento'); }
    }catch(e){ location.reload(); }
  };

  // ===== CERRAR / CONTEO =====
  function postCloseWithAmount(){
    const monto = prompt('Ingresá el monto contado en EFECTIVO (puede ser 0):', '0');
    if(monto===null) return;
    document.getElementById('saldo-cierre-input').value = String(monto||'0');
    document.getElementById('close-form').submit();
  }
  document.getElementById('btn-count-cash').onclick = postCloseWithAmount;
  document.getElementById('btn-close-cash').onclick = ()=>{ if(confirm('¿Cerrar caja ahora?')) postCloseWithAmount(); };
  const btn2 = document.getElementById('btn-close-cash-2'); if(btn2) btn2.onclick = ()=>{ if(confirm('¿Cerrar caja ahora?')) postCloseWithAmount(); };

  // accesos rápidos retirar/depositar (rellenan y disparan)
  const btnRet = document.getElementById('btn-retirar'); if(btnRet) btnRet.onclick=()=>{ document.getElementById('mov-tipo').value='RETIRO'; document.getElementById('mov-medio').value='EFECTIVO'; document.getElementById('mov-monto').focus(); };
  const btnDep = document.getElementById('btn-depositar'); if(btnDep) btnDep.onclick=()=>{ document.getElementById('mov-tipo').value='INGRESO'; document.getElementById('mov-medio').value='EFECTIVO'; document.getElementById('mov-monto').focus(); };

  // inicia
  renderTicket();
})();
</script>
{% endblock %}
{% else %}
{% block extra_js %}
<script>
(function(){
  function getCookie(n){const m=document.cookie.match(new RegExp('(^| )'+n+'=([^;]+)'));return m?m[2]:null;}
  const CSRF=getCookie('csrftoken');
  const form=document.getElementById('abrir-form'), btn=document.getElementById('btn-abrir');
  if(form){
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault(); btn.disabled=true; btn.textContent='Abriendo…';
      const body = new URLSearchParams(new FormData(form)).toString();
      try{
        const res = await fetch(form.action,{method:'POST',headers:{'X-CSRFToken':CSRF,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},body});
        const data = await res.json().catch(()=>null);
        if(res.ok && data && data.ok){ location.reload(); } else { alert((data && data.error) || 'No se pudo abrir la caja'); location.reload(); }
      }catch(e){ location.reload(); }
    });
  }
})();
</script>
{% endblock %}
{% endif %}
