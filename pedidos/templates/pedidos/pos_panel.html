{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<style>
  /* ====== Look tipo tablero ====== */
  .pos-wrap{max-width:1200px;margin:auto}
  .tile-grid{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:10px}
  .tile{background:#0f172a;color:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,.2)}
  .tile h6{font-size:.8rem;opacity:.8;margin:0 0 6px}
  .tile .amt{font-weight:700;font-size:1rem;margin:0}
  .tile .icon{font-size:22px;opacity:.85;margin-right:6px}
  .tile.invert{background:#1e293b}
  .tile.cash{background:#0ea5e9}    /* EFECTIVO */
  .tile.card{background:#6366f1}    /* TARJETA */
  .tile.qr{background:#22c55e}      /* QR */
  .tile.transfer{background:#f59e0b}/* TRANSFERENCIA */
  .tile.other{background:#64748b}   /* OTRO */
  .tile.total{background:#334155}
  .pos-header{background:#e2e8f0;border-radius:14px;padding:14px 16px;margin-bottom:12px}

  /* paneles */
  .card{border-radius:14px}
  .card-header{background:#111827;color:#fff;border-top-left-radius:14px;border-top-right-radius:14px}
  .sticky-bar{position:sticky;bottom:0;background:#0b1324;border-radius:16px;padding:10px;margin-top:12px;
              box-shadow:0 -10px 30px rgba(2,6,23,.35)}
  .sticky-bar .btn{min-width:140px}
  .small-hint{font-size:.85rem;color:#6b7280}

  /* items de venta */
  .item-row{border:1px dashed #cbd5e1;border-radius:10px;padding:8px}
  .split-row{display:grid;grid-template-columns:1fr 140px 40px;gap:8px;margin-top:6px}
  .split-row input{text-align:right}
</style>

<div class="pos-wrap my-3">

  {% if caja %}
  <!-- ====== CABECERA CAJA ABIERTA ====== -->
  <div class="pos-header d-flex justify-content-between align-items-center">
    <div>
      <strong>Caja ABIERTA #{{ caja.id }}</strong>
      ‚Äî Apertura: {{ caja.fecha_apertura|date:"d/m H:i" }} ({{ caja.usuario_apertura.username }})<br>
      <span class="small-hint">Saldo inicial efectivo: ${{ caja.saldo_inicial_efectivo|default:"0.00" }}</span>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" id="btn-count-cash">Conteo EFECTIVO</button>
      <button class="btn btn-danger btn-sm" id="btn-close-cash">Cerrar caja</button>
    </div>
  </div>

  <!-- Tiles resumen (medios + total efectivo te√≥rico) -->
  <div class="tile-grid mb-3">
    <div class="tile cash">
      <h6><span class="icon">üíµ</span>EFECTIVO</h6>
      <p class="amt">${{ totales_medio.EFECTIVO|default:"0.00" }}</p>
    </div>
    <div class="tile card">
      <h6><span class="icon">üí≥</span>TARJETA</h6>
      <p class="amt">${{ totales_medio.TARJETA|default:"0.00" }}</p>
    </div>
    <div class="tile qr">
      <h6><span class="icon">üì±</span>QR / MP</h6>
      <p class="amt">${{ totales_medio.QR_MP|default:"0.00" }}</p>
    </div>
    <div class="tile transfer">
      <h6><span class="icon">üí±</span>TRANSFERENCIA</h6>
      <p class="amt">${{ totales_medio.TRANSFERENCIA|default:"0.00" }}</p>
    </div>
    <div class="tile other">
      <h6><span class="icon">üßæ</span>OTRO</h6>
      <p class="amt">${{ totales_medio.OTRO|default:"0.00" }}</p>
    </div>
    <div class="tile invert">
      <h6><span class="icon">üßÆ</span>VENTAS (hoy)</h6>
      <p class="amt">${{ totales_tipo.VENTA|default:"0.00" }}</p>
    </div>
    <div class="tile total">
      <h6><span class="icon">üè¶</span>EFECTIVO TE√ìRICO</h6>
      <p class="amt"><strong>${{ saldo_teorico|default:"0.00" }}</strong></p>
    </div>
  </div>

  <div class="row g-3">
    <!-- ===== Registrar venta ===== -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header">Registrar venta</div>
        <div class="card-body">
          <form id="venta-form" autocomplete="off">
            {% csrf_token %}

            <!-- √çtems -->
            <div id="items-list"></div>
            <div class="mt-2 d-flex gap-2">
              <button type="button" id="btn-add-item" class="btn btn-outline-primary btn-sm">+ √çtem</button>
              <button type="button" id="btn-clear-items" class="btn btn-outline-danger btn-sm">Vaciar</button>
            </div>

            <hr>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Comprobante</label>
                <select id="tipo-comp" class="form-select" required>
                  <option value="COMANDA">Comanda (sin fiscal)</option>
                  <option value="BISTRO">Bistr√≥ (con factura)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Medio de pago</label>
                <select id="medio-pago" class="form-select">
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="QR_MP">QR / MercadoPago</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="OTRO">Otro</option>
                </select>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="split-toggle">
                  <label class="form-check-label" for="split-toggle">Pago dividido / parcial</label>
                </div>
                <div id="split-zone" class="mt-2 d-none">
                  <div id="split-list"></div>
                  <button class="btn btn-outline-secondary btn-sm mt-2" type="button" id="split-add">+ Agregar medio</button>
                  <div class="small-hint mt-2">
                    Suma de pagos: <strong>$<span id="split-suma">0.00</span></strong>
                    ‚Äî Total venta: <strong>$<span id="split-total">0.00</span></strong>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 fs-5">
              <strong>Total:</strong> <span id="preview-total">$0.00</span>
            </div>

            <div class="mt-3">
              <button id="btn-vender" class="btn btn-success" type="button" disabled>Cobrar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Movimiento manual ===== -->
    <div class="col-lg-5">
      <div class="card">
        <div class="card-header">Movimiento de caja</div>
        <div class="card-body">
          <form id="mov-form">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-4">
                <label class="form-label">Tipo</label>
                <select id="mov-tipo" class="form-select">
                  <option value="INGRESO">INGRESO</option>
                  <option value="EGRESO">EGRESO</option>
                  <option value="AJUSTE">AJUSTE</option>
                  <option value="RETIRO">RETIRO</option>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">Medio</label>
                <select id="mov-medio" class="form-select">
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="QR_MP">QR / MercadoPago</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="OTRO">Otro</option>
                </select>
              </div>
              <div class="col-4">
                <label class="form-label">Monto</label>
                <input id="mov-monto" type="number" step="0.01" min="0" class="form-control" value="0.00">
              </div>
            </div>
            <input id="mov-desc" class="form-control mt-2" placeholder="Detalle (opcional)">
            <button id="btn-mov" class="btn btn-primary mt-3" type="button">Registrar movimiento</button>
          </form>
        </div>
      </div>

      <!-- √∫ltimas ventas compactas -->
      <div class="card mt-3">
        <div class="card-header">√öltimas ventas</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead><tr><th>#</th><th>Fecha</th><th>Comp.</th><th>Medio</th><th class="text-end">Total</th></tr></thead>
              <tbody>
              {% for v in ventas %}
                <tr>
                  <td>{{ v.id }}</td>
                  <td>{{ v.fecha|date:"d/m H:i" }}</td>
                  <td>{{ v.tipo_comprobante }}</td>
                  <td>{{ v.medio_pago }}</td>
                  <td class="text-end">${{ v.total }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-center text-muted">Sin ventas.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== Barra fija de acciones r√°pidas ===== -->
  <div class="sticky-bar d-flex flex-wrap gap-2 justify-content-center">
    <button class="btn btn-outline-danger" id="quick-retirar">Retirar</button>
    <button class="btn btn-outline-success" id="quick-depositar">Depositar</button>
    <button class="btn btn-warning text-dark" id="quick-cerrar">Cerrar caja</button>
    <button class="btn btn-outline-light" id="quick-impresion">Impresi√≥n parcial</button>
  </div>

  <!-- form oculto para cierre -->
  <form id="close-form" method="post" action="{% url 'pos_cerrar_caja' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="saldo_cierre_efectivo" id="saldo-cierre-input">
  </form>

  {% else %}
  <!-- ===== PANTALLA PARA ABRIR CAJA ===== -->
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Abrir caja</div>
        <div class="card-body">
          <form id="abrir-form" method="post" action="{% url 'pos_abrir_caja' %}" autocomplete="off">
            {% csrf_token %}
            <label class="form-label">Saldo inicial en EFECTIVO</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" step="0.01" min="0" name="saldo_inicial_efectivo" id="saldo-inicial" class="form-control" value="0.00">
            </div>
            <button class="btn btn-success mt-3" type="submit" id="btn-abrir">Abrir caja</button>
          </form>
          <p class="text-muted small mt-2 mb-0">
            Esto crea una nueva caja en estado <strong>ABIERTA</strong> y te devuelve a este panel.
          </p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if caja %}
<script>
(function(){
  // ===== CSRF =====
  function getCookie(n){const v=`; ${document.cookie}`.split(`; ${n}=`);if(v.length===2)return v.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Helpers DOM =====
  const itemsList  = document.getElementById('items-list');
  const btnAdd     = document.getElementById('btn-add-item');
  const btnClear   = document.getElementById('btn-clear-items');
  const previewTot = document.getElementById('preview-total');
  const btnVender  = document.getElementById('btn-vender');
  const medioSel   = document.getElementById('medio-pago');
  const compSel    = document.getElementById('tipo-comp');

  // ===== Pago dividido =====
  const splitToggle = document.getElementById('split-toggle');
  const splitZone   = document.getElementById('split-zone');
  const splitList   = document.getElementById('split-list');
  const splitAddBtn = document.getElementById('split-add');
  const splitSumaEl = document.getElementById('split-suma');
  const splitTotalEl= document.getElementById('split-total');

  function fmt(n){return Number(n||0).toFixed(2);}
  function mkItemRowHTML(){
    return ''+
      '<div class="item-row row g-2 align-items-end mb-2">'+
        '<div class="col-8">'+
          '<label class="form-label">Producto</label>'+
          '<select class="form-select item-producto" required>'+
            '<option value="" hidden>Elegir‚Ä¶</option>'+
            '{% for pr in productos %}'+
              '<option value="{{ pr.id }}" data-precio="{{ pr.precio }}">{{ pr.nombre }} - ${{ pr.precio }}</option>'+
            '{% endfor %}'+
          '</select>'+
        '</div>'+
        '<div class="col-3">'+
          '<label class="form-label">Cant.</label>'+
          '<input type="number" class="form-control item-cantidad" value="1" min="1">'+
        '</div>'+
        '<div class="col-1 text-end">'+
          '<button type="button" class="btn btn-outline-danger btn-sm btn-remove" title="Quitar">√ó</button>'+
        '</div>'+
      '</div>';
  }
  function bindItemRow(row){
    row.querySelector('.item-producto').addEventListener('change', recalcTotal);
    row.querySelector('.item-cantidad').addEventListener('input', recalcTotal);
    row.querySelector('.btn-remove').addEventListener('click',()=>{ row.remove(); recalcTotal(); updateSplitTarget(); });
  }
  function addItem(){ const w=document.createElement('div'); w.innerHTML=mkItemRowHTML(); const r=w.firstElementChild; itemsList.appendChild(r); bindItemRow(r); }

  function currentTotal(){
    let t=0;
    itemsList.querySelectorAll('.item-row').forEach(r=>{
      const sel=r.querySelector('.item-producto');
      const qty=parseInt(r.querySelector('.item-cantidad').value||'1',10);
      const price=sel && sel.selectedOptions[0] ? parseFloat(sel.selectedOptions[0].dataset.precio||'0') : 0;
      if(sel && sel.value){ t+= price*qty; }
    });
    return t;
  }
  function recalcTotal(){
    const t=currentTotal();
    previewTot.textContent='$'+fmt(t);
    splitTotalEl && (splitTotalEl.textContent=fmt(t));
    btnVender.disabled = (t<=0 || !itemsList.querySelector('.item-row'));
    return t;
  }

  // ===== Split helpers =====
  function mkSplitRow(medio='EFECTIVO', monto=''){
    const row=document.createElement('div');
    row.className='split-row';
    row.innerHTML=
      '<select class="form-select split-medio">'+
        '<option value="EFECTIVO">Efectivo</option>'+
        '<option value="QR_MP">QR / MP</option>'+
        '<option value="TARJETA">Tarjeta</option>'+
        '<option value="TRANSFERENCIA">Transferencia</option>'+
        '<option value="OTRO">Otro</option>'+
      '</select>'+
      '<input class="form-control split-monto" type="number" step="0.01" min="0" placeholder="0.00">'+
      '<button type="button" class="btn btn-outline-danger btn-sm split-del">√ó</button>';
    row.querySelector('.split-medio').value=medio;
    row.querySelector('.split-monto').value=monto;
    row.querySelector('.split-monto').addEventListener('input', updateSplitSum);
    row.querySelector('.split-del').addEventListener('click',()=>{ row.remove(); updateSplitSum(); });
    return row;
  }
  function updateSplitSum(){
    let s=0;
    splitList.querySelectorAll('.split-monto').forEach(i=>{ s+= parseFloat(i.value||'0'); });
    splitSumaEl.textContent=fmt(s);
  }
  function updateSplitTarget(){
    // mantiene la suma visible cuando cambia el total
    splitTotalEl.textContent=fmt(currentTotal());
  }

  splitToggle.addEventListener('change', ()=>{
    if(splitToggle.checked){
      splitZone.classList.remove('d-none');
      if(!splitList.childElementCount){
        // dos filas por defecto
        splitList.appendChild(mkSplitRow('EFECTIVO',''));
        splitList.appendChild(mkSplitRow('QR_MP',''));
      }
      updateSplitTarget(); updateSplitSum();
    }else{
      splitZone.classList.add('d-none');
    }
  });
  splitAddBtn.addEventListener('click', ()=>{ splitList.appendChild(mkSplitRow()); updateSplitSum(); });

  // ===== Eventos items =====
  btnAdd.addEventListener('click', ()=>{ addItem(); recalcTotal(); });
  btnClear.addEventListener('click', ()=>{ itemsList.innerHTML=''; recalcTotal(); updateSplitTarget(); });

  // ===== Enviar venta =====
  btnVender.addEventListener('click', async ()=>{
    const rows = itemsList.querySelectorAll('.item-row');
    if(!rows.length){ alert('Agreg√° al menos un √≠tem.'); return; }
    const fd=new FormData();
    rows.forEach(r=>{
      const sel=r.querySelector('.item-producto');
      const q=r.querySelector('.item-cantidad');
      if(sel && sel.value){ fd.append('item_producto', sel.value); fd.append('item_cantidad', q.value||'1'); }
    });
    fd.append('tipo_comprobante', compSel.value);

    const total = currentTotal();
    if(splitToggle.checked){
      // compilar pagos
      const pagos=[];
      splitList.querySelectorAll('.split-row').forEach(r=>{
        const medio = r.querySelector('.split-medio').value;
        const monto = parseFloat(r.querySelector('.split-monto').value||'0');
        if(monto>0) pagos.push({medio, monto});
      });
      const suma = pagos.reduce((a,p)=>a+p.monto,0);
      if(pagos.length===0){ alert('Carg√° al menos un pago.'); return; }
      if(Math.abs(suma-total)>0.01){ alert('La suma de pagos ($'+fmt(suma)+') debe coincidir con el total ($'+fmt(total)+').'); return; }
      fd.append('pagos_json', JSON.stringify(pagos));
    }else{
      fd.append('medio_pago', medioSel.value); // pago √∫nico por el total
    }

    btnVender.disabled=true; btnVender.textContent='Cobrando‚Ä¶';
    try{
      const res = await fetch("{% url 'pos_vender' %}", {method:'POST', headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}, body:fd});
      const text = await res.text(); // <- para mostrar errores reales si no es JSON
      let data=null; try{ data = JSON.parse(text);}catch(_){}
      if(res.ok && data && data.ok){ location.reload(); }
      else{
        alert((data && data.error) || text || 'No se pudo registrar la venta');
        location.reload();
      }
    }catch(e){
      alert('Error de red'); location.reload();
    }
  });

  // ===== Movimiento manual =====
  document.getElementById('btn-mov').addEventListener('click', async ()=>{
    const params=new URLSearchParams();
    params.append('tipo', document.getElementById('mov-tipo').value);
    params.append('medio_pago', document.getElementById('mov-medio').value);
    params.append('monto', document.getElementById('mov-monto').value||'0');
    params.append('descripcion', document.getElementById('mov-desc').value||'');
    try{
      const res=await fetch("{% url 'pos_movimiento' %}", {
        method:'POST',
        headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
        body:params.toString()
      });
      const d=await res.json().catch(()=>null);
      if(res.ok && d && d.ok){ location.reload(); }
      else{ alert((d && d.error) || 'No se pudo registrar el movimiento'); }
    }catch(e){ alert('Error de red'); }
  });

  // ===== Cierre / conteo =====
  function postCloseWithAmount(){
    const monto = prompt('Ingres√° el monto contado en EFECTIVO (puede ser 0):','0');
    if(monto===null) return;
    document.getElementById('saldo-cierre-input').value = String(monto||'0');
    document.getElementById('close-form').submit();
  }
  document.getElementById('btn-count-cash').addEventListener('click', postCloseWithAmount);
  document.getElementById('btn-close-cash').addEventListener('click', ()=>{ if(confirm('¬øCerrar caja ahora?')) postCloseWithAmount(); });

  // barra r√°pida
  document.getElementById('quick-retirar').addEventListener('click', ()=>{
    document.getElementById('mov-tipo').value='RETIRO';
    document.getElementById('mov-medio').value='EFECTIVO';
    document.getElementById('mov-monto').focus();
  });
  document.getElementById('quick-depositar').addEventListener('click', ()=>{
    document.getElementById('mov-tipo').value='INGRESO';
    document.getElementById('mov-medio').value='EFECTIVO';
    document.getElementById('mov-monto').focus();
  });
  document.getElementById('quick-cerrar').addEventListener('click', ()=>{ if(confirm('¬øCerrar caja ahora?')) postCloseWithAmount(); });
  document.getElementById('quick-impresion').addEventListener('click', ()=>{ window.print(); });

  // fila inicial
  addItem(); recalcTotal();
})();
</script>
{% else %}
<script>
(function(){
  function getCookie(n){const v=`; ${document.cookie}`.split(`; ${n}=`);if(v.length===2)return v.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');
  const form=document.getElementById('abrir-form');
  const btn=document.getElementById('btn-abrir');
  form?.addEventListener('submit', async (ev)=>{
    ev.preventDefault(); btn.disabled=true; btn.textContent='Abriendo‚Ä¶';
    const body=new URLSearchParams(new FormData(form)).toString();
    try{
      const res=await fetch(form.action,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},body});
      const d=await res.json().catch(()=>null);
      if(res.ok && d && d.ok){ location.reload(); } else { alert((d && d.error)||'No se pudo abrir la caja'); location.reload(); }
    }catch(e){ location.reload(); }
  });
})();
</script>
{% endif %}
{% endblock %}
