{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h3 class="mb-3">Panel mínimo para Caja, Ventas y Movimientos (multi-items)</h3>

  {% if caja %}
  <div class="alert alert-info d-flex align-items-center justify-content-between">
    <div>
      <strong>Caja ABIERTA #{{ caja.id }}</strong> — Apertura: {{ caja.fecha_apertura|date:"d/m H:i" }} ({{ caja.usuario_apertura.username }})<br>
      Saldo inicial efectivo: ${{ caja.saldo_inicial_efectivo|default:"0.00" }}<br>
      Saldo efectivo teórico: <strong>${{ saldo_teorico|default:"0.00" }}</strong>
    </div>

    <!-- Form oculto para cerrar caja via POST -->
    <form id="close-form" method="post" action="{% url 'pos_cerrar_caja' %}" class="d-none">
      {% csrf_token %}
      <input type="hidden" name="saldo_cierre_efectivo" id="saldo-cierre-input">
    </form>

    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-secondary" id="btn-count-cash">Conteo EFECTIVO</button>
      <button type="button" class="btn btn-danger" id="btn-close-cash">Cerrar caja</button>
    </div>
  </div>

  <div class="row g-3">
    <!-- ===== Registrar venta (multi items + multi pagos) ===== -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Registrar venta (múltiples items)</div>
        <div class="card-body">
          <form id="venta-form" autocomplete="off">
            {% csrf_token %}

            <!-- Items dinámicos -->
            <div id="items-list"></div>
            <div class="mb-2 d-flex gap-2">
              <button type="button" id="btn-add-item" class="btn btn-outline-primary btn-sm">+ Agregar ítem</button>
              <button type="button" id="btn-clear-items" class="btn btn-outline-danger btn-sm">Vaciar</button>
            </div>

            <!-- Comprobante -->
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Comprobante</label>
                <select id="tipo-comp" class="form-select" required>
                  <option value="COMANDA">Comanda (sin fiscal)</option>
                  <option value="BISTRO">Bistró (con factura)</option>
                </select>
              </div>
            </div>

            <!-- Pagos múltiples -->
            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label mb-0">Pagos (podés mezclar medios)</label>
                <div class="d-flex gap-2">
                  <button type="button" id="btn-add-pago" class="btn btn-outline-primary btn-sm">+ Agregar pago</button>
                  <button type="button" id="btn-clear-pagos" class="btn btn-outline-danger btn-sm">Vaciar</button>
                </div>
              </div>
              <div id="pagos-list" class="mt-2"></div>
              <div class="small text-muted">La suma de los pagos debe ser igual al total de la venta.</div>
            </div>

            <!-- Total y faltante -->
            <div class="mt-3 fs-5">
              <strong>Total:</strong> <span id="preview-total">$0.00</span>
              <span class="ms-3"><strong>Falta cubrir:</strong> <span id="faltante">$0.00</span></span>
            </div>

            <div class="mt-3">
              <!-- Botón NO-submit, todo se envía por fetch -->
              <button id="btn-vender" class="btn btn-success" type="button" disabled>Cargar venta</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Movimiento de caja ===== -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Movimiento de caja (Ingreso/Egreso/Ajuste/Retiro)</div>
        <div class="card-body">
          <form id="mov-form">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Tipo</label>
                <select id="mov-tipo" class="form-select">
                  <option value="INGRESO">INGRESO</option>
                  <option value="EGRESO">EGRESO</option>
                  <option value="AJUSTE">AJUSTE</option>
                  <option value="RETIRO">RETIRO</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Medio</label>
                <select id="mov-medio" class="form-select">
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="QR_MP">QR / MercadoPago</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="OTRO">Otro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Monto</label>
                <input id="mov-monto" type="number" step="0.01" min="0" class="form-control" value="0.00">
              </div>
            </div>
            <div class="mt-2">
              <input id="mov-desc" class="form-control" placeholder="Detalle (opcional)">
            </div>
            <div class="mt-3">
              <button id="btn-mov" class="btn btn-primary" type="button">Registrar movimiento</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ===== Totales ===== -->
    <div class="col-lg-6">
      <div class="card mt-3">
        <div class="card-header">Totales por medio de pago (VENTAS)</div>
        <div class="card-body">
          {% if totales_medio %}
            {% for k,v in totales_medio.items %}
              <span class="badge text-bg-light me-2">{{ k }} <span class="badge text-bg-primary">${{ v|default:"0.00" }}</span></span>
            {% endfor %}
          {% else %}
            <div class="text-muted">Sin ventas aún.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card mt-3">
        <div class="card-header">Totales por tipo de movimiento</div>
        <div class="card-body">
          {% if totales_tipo %}
            {% for k,v in totales_tipo.items %}
              <span class="badge text-bg-light me-2">{{ k }} <span class="badge text-bg-secondary">${{ v|default:"0.00" }}</span></span>
            {% endfor %}
          {% else %}
            <div class="text-muted">Sin movimientos aún.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ===== Últimas ventas ===== -->
    <div class="col-12">
      <div class="card mt-3">
        <div class="card-header">Últimas ventas</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0">
              <thead>
                <tr><th>#</th><th>Fecha</th><th>Caja</th><th>Usuario</th><th>Comp.</th><th>Medio</th><th>Total</th><th>Estado</th></tr>
              </thead>
              <tbody>
              {% for v in ventas %}
                <tr>
                  <td>{{ v.id }}</td>
                  <td>{{ v.fecha|date:"d/m H:i" }}</td>
                  <td>#{{ v.caja_id }}</td>
                  <td>{{ v.usuario.username }}</td>
                  <td>{{ v.tipo_comprobante }}</td>
                  <td>{{ v.medio_pago }}</td>
                  <td>${{ v.total }}</td>
                  <td>{{ v.estado }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="8" class="text-center text-muted">Sin ventas registradas.</td></tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!--/row-->

  {% else %}
<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header">Abrir caja</div>
        <div class="card-body">
          <form id="abrir-form" method="post" action="{% url 'pos_abrir_caja' %}" autocomplete="off">
            {% csrf_token %}
            <label class="form-label">Saldo inicial en EFECTIVO</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" step="0.01" min="0" name="saldo_inicial_efectivo" id="saldo-inicial" class="form-control" value="0.00">
            </div>
            <button class="btn btn-success mt-3" type="submit" id="btn-abrir">Abrir caja</button>
          </form>
          <p class="text-muted small mt-2 mb-0">
            Esto crea una nueva caja en estado <strong>ABIERTA</strong> y te devuelve a este panel.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // CSRF helper
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`); if(v.length===2) return v.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  const abrirForm = document.getElementById('abrir-form');
  if(abrirForm){
    const btn = document.getElementById('btn-abrir');
    abrirForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      btn.disabled = true; btn.textContent = 'Abriendo…';
      try{
        const body = new URLSearchParams(new FormData(abrirForm)).toString();
        const res = await fetch(abrirForm.action, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const data = await res.json().catch(()=>null);
        if(res.ok && data && data.ok){ location.reload(); }
        else { alert((data && data.error) || 'No se pudo abrir la caja'); location.reload(); }
      }catch(e){ location.reload(); }
    });
  }
})();
</script>
{% endif %}

</div>

{% if caja %}
<script>
(function(){
  // ===== CSRF =====
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`);
    if (v.length === 2) return v.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // ===== Helpers =====
  const itemsList     = document.getElementById('items-list');
  const btnAddItem    = document.getElementById('btn-add-item');
  const btnClearItems = document.getElementById('btn-clear-items');

  const pagosList     = document.getElementById('pagos-list');
  const btnAddPago    = document.getElementById('btn-add-pago');
  const btnClearPagos = document.getElementById('btn-clear-pagos');

  const previewTotal  = document.getElementById('preview-total');
  const faltanteEl    = document.getElementById('faltante');

  const btnVender     = document.getElementById('btn-vender');
  const compSel       = document.getElementById('tipo-comp');

  // ===== Templates (sin backticks) =====
  function itemRowTemplate(){
    return '' +
      '<div class="row g-2 align-items-end mb-2 item-row">' +
        '<div class="col-8">' +
          '<label class="form-label">Producto</label>' +
          '<select name="item_producto" class="form-select item-producto" required>' +
            '<option value="" hidden>Elegir…</option>' +
            '{% for pr in productos %}' +
              '<option value="{{ pr.id }}" data-precio="{{ pr.precio }}">{{ pr.nombre }} - ${{ pr.precio }}</option>' +
            '{% endfor %}' +
          '</select>' +
        '</div>' +
        '<div class="col-3">' +
          '<label class="form-label">Cant.</label>' +
          '<input type="number" name="item_cantidad" class="form-control item-cantidad" value="1" min="1">' +
        '</div>' +
        '<div class="col-1 text-end">' +
          '<button type="button" class="btn btn-outline-danger btn-sm btn-remove" title="Quitar">×</button>' +
        '</div>' +
      '</div>';
  }

  function pagoRowTemplate(){
    return '' +
      '<div class="row g-2 align-items-end mb-2 pago-row">' +
        '<div class="col-7">' +
          '<label class="form-label">Medio</label>' +
          '<select name="pago_medio" class="form-select pago-medio" required>' +
            '<option value="EFECTIVO">Efectivo</option>' +
            '<option value="QR_MP">QR / MercadoPago</option>' +
            '<option value="TARJETA">Tarjeta</option>' +
            '<option value="TRANSFERENCIA">Transferencia</option>' +
            '<option value="OTRO">Otro</option>' +
          '</select>' +
        '</div>' +
        '<div class="col-4">' +
          '<label class="form-label">Monto</label>' +
          '<input type="number" step="0.01" min="0" name="pago_monto" class="form-control pago-monto" value="0.00">' +
        '</div>' +
        '<div class="col-1 text-end">' +
          '<button type="button" class="btn btn-outline-danger btn-sm pago-remove" title="Quitar">×</button>' +
        '</div>' +
      '</div>';
  }

  // ===== Items =====
  function bindItemRow(row){
    row.querySelector('.item-producto').addEventListener('change', recalcAll);
    row.querySelector('.item-cantidad').addEventListener('input', recalcAll);
    row.querySelector('.btn-remove').addEventListener('click', ()=>{ row.remove(); recalcAll(); });
  }
  function addItemRow(){
    const wrap = document.createElement('div');
    wrap.innerHTML = itemRowTemplate();
    const row = wrap.firstElementChild;
    itemsList.appendChild(row);
    bindItemRow(row);
  }

  // ===== Pagos =====
  function bindPagoRow(row){
    row.querySelector('.pago-medio').addEventListener('change', recalcAll);
    row.querySelector('.pago-monto').addEventListener('input', recalcAll);
    row.querySelector('.pago-remove').addEventListener('click', ()=>{ row.remove(); recalcAll(); });
  }
  function addPagoRow(medio, monto){
    const wrap = document.createElement('div');
    wrap.innerHTML = pagoRowTemplate();
    const row = wrap.firstElementChild;
    pagosList.appendChild(row);
    if(medio){ row.querySelector('.pago-medio').value = medio; }
    if(monto!=null){ row.querySelector('.pago-monto').value = monto; }
    bindPagoRow(row);
  }

  // ===== Cálculos =====
  function totalItems(){
    let t = 0;
    itemsList.querySelectorAll('.item-row').forEach(row=>{
      const sel  = row.querySelector('.item-producto');
      const qty  = parseInt(row.querySelector('.item-cantidad').value||'1',10);
      const opt  = sel ? sel.selectedOptions[0] : null;
      const price= opt ? parseFloat(opt.dataset.precio || '0') : 0;
      if(sel && sel.value) t += price * qty;
    });
    return t;
  }
  function sumaPagos(){
    let s=0;
    pagosList.querySelectorAll('.pago-row').forEach(row=>{
      const m=parseFloat(row.querySelector('.pago-monto').value||'0');
      s += isNaN(m)?0:m;
    });
    return s;
  }
  function recalcAll(){
    const total = totalItems();
    previewTotal.textContent = '$' + total.toFixed(2);
    const falt = +(total - sumaPagos()).toFixed(2);
    faltanteEl.textContent = '$' + falt.toFixed(2);

    const okItems  = !!itemsList.querySelector('.item-row');
    const okPagos  = !!pagosList.querySelector('.pago-row');
    const okFalt   = Math.abs(falt) <= 0.01;

    btnVender.disabled = !(okItems && okPagos && okFalt);
  }

  // ===== Eventos Items =====
  btnAddItem.addEventListener('click', ()=>{ addItemRow(); recalcAll(); });
  btnClearItems.addEventListener('click', ()=>{ itemsList.innerHTML=''; recalcAll(); });

  // ===== Eventos Pagos =====
  btnAddPago.addEventListener('click', ()=>{ addPagoRow('EFECTIVO','0.00'); recalcAll(); });
  btnClearPagos.addEventListener('click', ()=>{ pagosList.innerHTML=''; recalcAll(); });

  // ===== Envío de venta (multi-pago) =====
  let sending = false;
  btnVender.addEventListener('click', async ()=>{
    if(sending) return;

    if(!itemsList.querySelector('.item-row')){ alert('Agregá al menos un ítem.'); return; }
    if(!pagosList.querySelector('.pago-row')){ alert('Agregá al menos un pago.'); return; }

    const total = totalItems();
    const suma  = sumaPagos();
    if(Math.abs(total - suma) > 0.01){ alert('La suma de pagos debe ser igual al total.'); return; }

    const fd = new FormData();
    // Ítems
    itemsList.querySelectorAll('.item-row').forEach(r=>{
      const sel=r.querySelector('.item-producto');
      const q=r.querySelector('.item-cantidad');
      if(sel && sel.value){
        fd.append('item_producto', sel.value);
        fd.append('item_cantidad', q.value||'1');
      }
    });
    // Comprobante
    fd.append('tipo_comprobante', compSel.value);
    // Pagos
    pagosList.querySelectorAll('.pago-row').forEach(r=>{
      const medio=r.querySelector('.pago-medio').value;
      const monto=r.querySelector('.pago-monto').value||'0';
      if(parseFloat(monto)>0){
        fd.append('pago_medio', medio);
        fd.append('pago_monto', monto);
      }
    });

    sending = true;
    btnVender.disabled = true;
    btnVender.textContent = 'Cargando…';

    try{
      const res = await fetch("{% url 'pos_vender' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: fd
      });
      const data = await res.json().catch(()=>null);
      if(res.ok && data && data.ok){ location.reload(); }
      else { alert((data && data.error) || 'No se pudo registrar la venta'); location.reload(); }
    }catch(e){
      location.reload();
    }
  });

  // ===== Movimiento manual (igual que antes) =====
  document.getElementById('btn-mov').addEventListener('click', async ()=>{
    const params = new URLSearchParams();
    params.append('tipo', document.getElementById('mov-tipo').value);
    params.append('medio_pago', document.getElementById('mov-medio').value);
    params.append('monto', document.getElementById('mov-monto').value||'0');
    params.append('descripcion', document.getElementById('mov-desc').value||'');

    try{
      const res = await fetch("{% url 'pos_movimiento' %}", {
        method:'POST',
        headers:{
          'X-CSRFToken': csrftoken,
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/x-www-form-urlencoded'
        },
        body: params.toString()
      });
      const data = await res.json().catch(()=>null);
      if(res.ok && data && data.ok){ location.reload(); }
      else { alert((data && data.error) || 'No se pudo registrar el movimiento'); }
    }catch(e){
      location.reload();
    }
  });

  // ===== Cerrar caja (igual que antes) =====
  function postCloseWithAmount(){
    const monto = prompt('Ingresá el monto contado en EFECTIVO (puede ser 0):', '0');
    if(monto===null) return;
    document.getElementById('saldo-cierre-input').value = String(monto||'0');
    document.getElementById('close-form').submit();
  }
  document.getElementById('btn-count-cash').addEventListener('click', postCloseWithAmount);
  document.getElementById('btn-close-cash').addEventListener('click', ()=>{
    if(confirm('¿Cerrar caja ahora?')) postCloseWithAmount();
  });

  // ===== Inicial =====
  addItemRow();           // un ítem vacío
  addPagoRow('EFECTIVO'); // un pago por defecto
  recalcAll();
})();
</script>
{% endif %}
{% endblock %}
