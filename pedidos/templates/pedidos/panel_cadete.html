{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Panel del Cadete</h2>

  <!-- Pedidos en curso del cadete -->
  {% if pedidos_en_curso %}
    <div class="mb-4">
      <h5>Tu pedido en curso</h5>
      {% for p in pedidos_en_curso %}
        <div class="card mb-2" id="curso-{{ p.id }}">
          <div class="card-body d-flex justify-content-between align-items-start gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2">
                <strong>#{{ p.id }}</strong>
                <span class="badge bg-secondary">{{ p.estado }}</span>
              </div>
              <div class="small text-muted mt-1">
                {{ p.cliente_nombre|default:"" }} · {{ p.cliente_direccion|default:"" }} · {{ p.cliente_telefono|default:"" }}
              </div>
              <ul class="mb-1 small mt-2">
                {% for d in p.detalles.all %}
                  <li>
                    {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                    {% with sab=d.sabores.all %}
                      {% if sab %}<br><span class="text-muted">Sabores: {{ sab|join:", " }}</span>{% endif %}
                    {% endwith %}
                  </li>
                {% endfor %}
              </ul>
              <div class="fw-bold">Total: $ {{ p.total_pedido|default_if_none:"0.00" }}</div>
            </div>
            <div class="text-end">
              {% if p.estado == 'ASIGNADO' %}
                <button class="btn btn-primary btn-sm cadete-set" data-id="{{ p.id }}" data-next="EN_CAMINO">Marcar EN CAMINO</button>
              {% elif p.estado == 'EN_CAMINO' %}
                <button class="btn btn-success btn-sm cadete-set" data-id="{{ p.id }}" data-next="ENTREGADO">Marcar ENTREGADO</button>
              {% else %}
                <span class="text-muted small">Estado: {{ p.estado }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No tenés pedidos en curso.</div>
  {% endif %}

  <!-- Feed de pedidos disponibles (aparecen solo si la tienda los confirmó) -->
  <div class="mb-2 d-flex align-items-center gap-2">
    <h5 class="mb-0">Pedidos disponibles</h5>
    <span class="text-muted small"> (se actualiza solo)</span>
  </div>
  <div id="cadete-feed"></div>

  <div class="mt-4">
    <button id="refresh-feed" class="btn btn-outline-secondary btn-sm">Actualizar ahora</button>
  </div>
</div>

<script>
(function(){
  // ===== CSRF
  function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2) return v.pop().split(';').shift();}
  const csrftoken = getCookie('csrftoken');

  const feedRoot = document.getElementById('cadete-feed');
  const btnRefresh = document.getElementById('refresh-feed');

  async function loadFeed(){
    try{
      const res = await fetch("{% url 'cadete_feed' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const j = await res.json().catch(()=>({}));
      const items = (j && j.ok && Array.isArray(j.pedidos)) ? j.pedidos : [];
      if(!items.length){
        feedRoot.innerHTML = '<div class="alert alert-light border">No hay pedidos disponibles por ahora.</div>';
        return;
      }
      feedRoot.innerHTML = items.map(p=>{
        const det = (p.detalles||[]).map(d=>`
          <li>${d.product}${d.opcion?` - ${d.opcion}`:''} (x${d.cant})${(d.sabores&&d.sabores.length)?`<br><span class="text-muted">Sabores: ${d.sabores.join(', ')}</span>`:''}</li>
        `.replace('product','producto')).join('');

        return `
          <div class="card mb-2" data-id="${p.id}">
            <div class="card-body d-flex justify-content-between align-items-start gap-3 flex-wrap">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2">
                  <strong>#${p.id}</strong>
                  <span class="badge bg-info text-dark">EN_PREPARACION</span>
                </div>
                <div class="small text-muted mt-1">${p.cliente_nombre||''} · ${p.cliente_direccion||''} · ${p.cliente_telefono||''}</div>
                <ul class="mb-1 small mt-2">${det}</ul>
                <div class="fw-bold">Total: $ ${p.total}</div>
              </div>
              <div class="text-end">
                <button class="btn btn-primary btn-sm btn-aceptar" data-id="${p.id}">Aceptar pedido</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }catch(e){
      feedRoot.innerHTML = '<div class="alert alert-danger">Error cargando el feed.</div>';
    }
  }

  // aceptar pedido (delegación)
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.btn-aceptar'); if(!btn) return;
    ev.preventDefault();
    const id = btn.dataset.id;
    btn.disabled = true; btn.textContent = 'Aceptando...';
    try{
      const res = await fetch(`/aceptar-pedido/${id}/`, {
        method:'POST',
        headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}
      });
      if(res.ok){
        await loadFeed();
        // recargamos para refrescar “Tu pedido en curso”
        location.reload();
      }else{
        location.href = `/aceptar-pedido/${id}/`;
      }
    }catch(e){
      location.href = `/aceptar-pedido/${id}/`;
    }
  });

  // cambiar estado del pedido en curso (ASIGNADO -> EN_CAMINO -> ENTREGADO)
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.cadete-set'); if(!btn) return;
    ev.preventDefault();
    const id = btn.dataset.id;
    const next = btn.dataset.next;
    btn.disabled = true; const old = btn.textContent; btn.textContent = 'Guardando...';
    try{
      const res = await fetch(`/cadete/pedido/${id}/estado/`, {
        method:'POST',
        headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
        body: `estado=${encodeURIComponent(next)}`
      });
      const j = await res.json().catch(()=>({}));
      if(res.ok && j.ok){
        // si se entregó, recargamos todo (vuelve disponible)
        if(next === 'ENTREGADO'){ location.reload(); return; }
        // si pasó a EN_CAMINO, actualizamos badge y botón
        const card = document.getElementById(`curso-${id}`);
        const badge = card && card.querySelector('.badge');
        if(badge){ badge.textContent = next; }
        btn.textContent = 'Marcar ENTREGADO';
        btn.dataset.next = 'ENTREGADO';
        btn.classList.remove('btn-primary'); btn.classList.add('btn-success');
        btn.disabled = false;
      }else{
        btn.textContent = old; btn.disabled = false;
      }
    }catch(e){
      btn.textContent = old; btn.disabled = false;
    }
  });

  // primera carga + polling suave
  loadFeed();
  setInterval(loadFeed, 8000);
  btnRefresh.addEventListener('click', loadFeed);
})();
</script>

<style>
.badge{font-weight:600}
</style>
{% endblock %}
