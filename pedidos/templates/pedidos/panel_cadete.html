{% extends 'pedidos/base.html' %}
{% block content %}
<div class="container">
  <h1 class="mb-3">Panel del Cadete</h1>

  {% if pedidos_en_curso %}
    <div class="row g-3">
      {% for p in pedidos_en_curso %}
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="card-title mb-1">Pedido #{{ p.id }}</h5>
                  <div class="text-muted small mb-2">
                    {{ p.cliente_nombre }} — {{ p.cliente_direccion }} — {{ p.cliente_telefono }}
                  </div>
                  <ul class="mb-2">
                    {% for d in p.detalles.all %}
                      <li>
                        {{ d.cantidad }}× {{ d.producto.nombre }}
                        {% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %}
                        {% if d.sabores.all %} — Sabores: {{ d.sabores.all|join:", " }}{% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                  <span class="badge bg-info text-dark">Estado: <span id="estado-{{ p.id }}">{{ p.estado }}</span></span>
                </div>
                <div class="text-end">
                  <button class="btn btn-outline-primary btn-sm mb-2 cadete-accion" data-id="{{ p.id }}" data-estado="EN_CAMINO">
                    Marcar en camino
                  </button>
                  <br>
                  <button class="btn btn-success btn-sm cadete-accion" data-id="{{ p.id }}" data-estado="ENTREGADO">
                    Marcar entregado
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No tenés pedidos en curso por ahora.</div>
  {% endif %}
</div>

<script>
(function(){
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`); 
    if (v.length === 2) return v.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.cadete-accion').forEach(btn=>{
    btn.addEventListener('click', async function(){
      const id = this.dataset.id, estado = this.dataset.estado;
      const fd = new FormData(); fd.append('estado', estado);
      const res = await fetch(`/cadete/estado/${id}/`, {method:'POST', headers:{'X-CSRFToken': csrftoken}, body: fd}).catch(()=>null);
      if(!res) return;
      const j = await res.json().catch(()=>({}));
      if(j.ok){
        document.getElementById(`estado-${id}`).textContent = j.estado;
      } else {
        alert('No se pudo actualizar el estado.');
      }
    });
  });
})();
</script>
{% endblock %}
