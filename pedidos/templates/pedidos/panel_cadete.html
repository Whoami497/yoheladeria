{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="text-center mb-3">Panel del Cadete</h2>
  <p class="text-muted text-center">Acept√° pedidos disponibles y actualiz√° el estado de tus entregas.</p>
  <hr>

  <!-- Estado / sonido / notificaciones -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span id="avail-badge" class="badge bg-secondary">Estado: No disponible</span>
    <span class="text-muted small">La disponibilidad se cambia desde el bot√≥n <strong>‚ÄúDisponible‚Äù</strong> de la barra inferior.</span>

    <div class="ms-auto"></div>
    <button id="enable-sound" class="btn btn-outline-primary">üîî Habilitar sonido</button>
    <span id="sound-warning" class="badge bg-warning text-dark d-none">Toc√° ‚ÄúHabilitar sonido‚Äù para o√≠r alertas</span>

    <!-- Notificaciones push -->
    <button id="enable-push" class="btn btn-outline-success">üõéÔ∏è Activar notificaciones</button>
    <span id="push-status" class="badge bg-secondary">Push: sin configurar</span>
  </div>

  <!-- Mis pedidos en curso -->
  <h5 class="mt-4">Mis pedidos en curso</h5>
  <div id="en-curso">
    {% if pedidos_en_curso %}
      <div id="en-curso-list">
        {% for p in pedidos_en_curso %}
          <div class="card mb-2"
               data-order-id="{{ p.id }}"
               data-estado="{{ p.estado }}"
               data-ts-pedido="{{ p.fecha_pedido|date:'c' }}"
               data-ts-pago="{{ p.fecha_pago_aprobado|date:'c' }}"
               data-ts-preparacion="{{ p.fecha_en_preparacion|date:'c' }}"
               data-ts-asignado="{{ p.fecha_asignado|date:'c' }}"
               data-ts-camino="{{ p.fecha_en_camino|date:'c' }}"
               data-ts-entregado="{{ p.fecha_entregado|date:'c' }}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="flex-grow-1">
                  <span class="fw-bold">#{{ p.id }}</span>
                  <span class="badge bg-primary badge-estado">{{ p.estado }}</span>
                  <div class="text-muted small mt-1">
                    {{ p.cliente_nombre }} ‚Äî
                    <span class="addr-ellipsis" title="{{ p.direccion_legible|default:p.cliente_direccion|default:'‚Äî' }}">
                      {{ p.direccion_legible|default:p.cliente_direccion|default:"‚Äî" }}
                    </span>
                    {% if p.map_url %} ‚Äî <a href="{{ p.map_url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver mapa</a>{% endif %}
                  </div>
                  <div class="text-muted small">Total aprox: ${{ p.total_pedido|default_if_none:"0.00"|floatformat:2 }}</div>

                  <!-- L√≠nea de tiempo -->
                  <details class="mt-2 timeline-details">
                    <summary>Ver tiempos</summary>
                    <div class="mt-2 small timeline-box" id="timeline-{{ p.id }}"></div>
                  </details>
                </div>

                <div class="text-end">
                  <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline cadete-state-form">
                    {% csrf_token %}
                    <input type="hidden" name="estado" value="EN_CAMINO">
                    <button class="btn btn-outline-warning me-1">Marcar EN CAMINO</button>
                  </form>
                  <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline cadete-state-form">
                    {% csrf_token %}
                    <input type="hidden" name="estado" value="ENTREGADO">
                    <button class="btn btn-success">Marcar ENTREGADO</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div id="en-curso-empty" class="alert alert-light border">No ten√©s pedidos en curso.</div>
      <div id="en-curso-list"></div>
    {% endif %}
  </div>

  <!-- Pedidos disponibles -->
  <h5 class="mt-4">Pedidos disponibles</h5>
  <div id="feed-list">
    <div class="text-muted">Cargando‚Ä¶</div>
  </div>

  <div class="text-center my-4">
    <a href="{% url 'cadete_historial' %}">Ver mi historial</a>
  </div>
</div>

<!-- Barra inferior: disponibilidad -->
<div class="cadete-bottom fixed-bottom py-2 border-top bg-white">
  <div class="container d-flex justify-content-between align-items-center">
    <div class="small text-muted">Disponibilidad</div>
    <button id="btn-available" class="btn btn-outline-success">Ponerse disponible</button>
  </div>
</div>

<script>
  // ===== CSRF =====
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Sonido =====
  const orderSoundUrl = "{% static 'pedidos/sounds/new-order.mp3' %}";
  const enableBtn   = document.getElementById('enable-sound');
  const soundWarn   = document.getElementById('sound-warning');
  const audioEl     = new Audio(orderSoundUrl);
  audioEl.preload   = 'auto';

  let soundEnabled  = localStorage.getItem('cadete_sound_enabled') === '1';
  let audioReady    = false;

  function tryUnlockAudio(){
    audioEl.play().then(()=>{
      audioEl.pause(); audioEl.currentTime=0;
      audioReady=true;
      enableBtn.classList.replace('btn-outline-primary','btn-outline-success');
      enableBtn.textContent='üîî Sonido habilitado';
      soundWarn.classList.add('d-none');
    }).catch(()=>{
      audioReady=false;
      soundWarn.classList.remove('d-none');
    });
  }
  function playSound(){
    if(!soundEnabled) return;
    if(!audioReady){ soundWarn.classList.remove('d-none'); return; }
    try{ audioEl.currentTime=0; audioEl.play().catch(()=>{});}catch(e){}
  }
  enableBtn.addEventListener('click', ()=>{
    soundEnabled = true;
    localStorage.setItem('cadete_sound_enabled','1');
    tryUnlockAudio();
  });
  ['touchstart','click','keydown'].forEach(evt=>{
    document.addEventListener(evt, function once(){
      if(soundEnabled && !audioReady) tryUnlockAudio();
      document.removeEventListener(evt, once, {passive:true});
    }, {passive:true});
  });
  if(!soundEnabled){ soundWarn.classList.remove('d-none'); }

  // ===== Push =====
  const VAPID_PUBLIC_KEY = '{{ vapid_public_key|default:""|escapejs }}';
  const btnPush   = document.getElementById('enable-push');
  const pushBadge = document.getElementById('push-status');

  function setPushBadge(text, ok){
    pushBadge.textContent = text;
    pushBadge.className = 'badge ' + (ok ? 'bg-success' : 'bg-secondary');
  }
  function urlBase64ToUint8Array(base64String){
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64  = (base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for(let i=0;i<rawData.length;i++){ outputArray[i]=rawData.charCodeAt(i); }
    return outputArray;
  }
  async function saveSubscription(sub){
    const res = await fetch("{% url 'save_subscription' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
      body: JSON.stringify(sub)
    });
    return res.ok;
  }
  async function ensureServiceWorker(){
    if(!('serviceWorker' in navigator)){ throw new Error('SW no soportado'); }
    const reg = await navigator.serviceWorker.register('/sw.js');
    return reg;
  }
  async function getOrCreateSubscription(reg){
    const existing = await reg.pushManager.getSubscription();
    if(existing) return existing;
    const appKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
    return await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey: appKey});
  }
  async function activatePush(){
    if(!VAPID_PUBLIC_KEY){ setPushBadge('Push: sin VAPID', false); alert('No hay VAPID_PUBLIC_KEY configurada.'); return; }
    if(!('Notification' in window)){ setPushBadge('Push no disponible', false); return; }
    let perm = Notification.permission;
    if(perm === 'default'){ perm = await Notification.requestPermission(); }
    if(perm !== 'granted'){ setPushBadge('Push: permiso denegado', false); return; }
    try{
      const reg  = await ensureServiceWorker();
      const sub  = await getOrCreateSubscription(reg);
      const ok   = await saveSubscription(sub.toJSON ? sub.toJSON() : sub);
      if(ok){
        setPushBadge('Push: activo', true);
        btnPush.classList.replace('btn-outline-success','btn-success');
        btnPush.textContent = 'üõéÔ∏è Notificaciones activas';
      }else{
        setPushBadge('Push: error al guardar', false);
      }
    }catch(e){
      setPushBadge('Push: error', false);
    }
  }
  (async ()=>{
    try{
      if(!VAPID_PUBLIC_KEY){ setPushBadge('Push: sin VAPID', false); return; }
      if(!('serviceWorker' in navigator) || !('Notification' in window)){ setPushBadge('Push no disponible', false); return; }
      if(Notification.permission === 'granted'){
        const reg = await ensureServiceWorker();
        const sub = await getOrCreateSubscription(reg);
        const ok  = await saveSubscription(sub.toJSON ? sub.toJSON() : sub);
        setPushBadge(ok ? 'Push: activo' : 'Push: error al guardar', !!ok);
        if(ok){
          btnPush.classList.replace('btn-outline-success','btn-success');
          btnPush.textContent = 'üõéÔ∏è Notificaciones activas';
        }
      }else{
        setPushBadge('Push: requiere permiso', false);
      }
    }catch(e){
      setPushBadge('Push: error', false);
    }
  })();
  btnPush.addEventListener('click', activatePush);

  // ===== Disponibilidad & Feed =====
  const availBadge   = document.getElementById('avail-badge');
  const btnAvail     = document.getElementById('btn-available');
  const feedList     = document.getElementById('feed-list');
  const enCursoList  = document.getElementById('en-curso-list');
  const enCursoEmpty = document.getElementById('en-curso-empty');

  let disponible = false;
  let lastOfferIds = new Set();
  let initializedFeed = false;

  function setAvailUI(val){
    disponible = !!val;
    availBadge.className = 'badge ' + (disponible ? 'bg-success' : 'bg-secondary');
    availBadge.textContent = 'Estado: ' + (disponible ? 'Disponible' : 'No disponible');
    if(disponible){
      btnAvail.classList.remove('btn-outline-success');
      btnAvail.classList.add('btn-success');
      btnAvail.textContent = 'Disponible (pausar)';
    }else{
      btnAvail.classList.add('btn-outline-success');
      btnAvail.classList.remove('btn-success');
      btnAvail.textContent = 'Ponerse disponible';
    }
  }

  async function toggleAvailability(){
    const desired = disponible ? '0' : '1';
    const original = btnAvail.textContent;
    btnAvail.disabled = true;
    btnAvail.textContent = 'Actualizando‚Ä¶';
    try{
      const res = await fetch("{% url 'cadete_toggle_disponible' %}", {
        method:'POST',
        headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'},
        body: `disponible=${desired}`
      });
      if(!res.ok){
        const data = await res.json().catch(()=>({}));
        if(data && data.error === 'ocupado'){
          alert('No pod√©s ponerte disponible porque ten√©s un pedido en curso.');
        }
      }else{
        const data = await res.json();
        if(data.ok){ setAvailUI(!!data.disponible); if(disponible){ fetchFeed(); } }
      }
    }catch(e){
      // fallback: nada
    }finally{
      btnAvail.disabled = false;
      btnAvail.textContent = original.includes('Actualizando') ? (disponible ? 'Disponible (pausar)' : 'Ponerse disponible') : original;
    }
  }
  btnAvail.addEventListener('click', toggleAvailability);

  // ===== Timeline helpers =====
  const fmt = n => (n==null || Number.isNaN(n)) ? '‚Äî' : `${n.toFixed(2)} min`;
  const toDate = s => s ? new Date(s) : null;
  const diffMin = (a,b) => (a && b) ? Math.round(((b - a) / 60000) * 100) / 100 : null;

  function computeMetricasFromTs(ts){
    const recibido = toDate(ts.fecha_pago_aprobado || ts.fecha_pedido);
    const prep     = toDate(ts.fecha_en_preparacion);
    const asign    = toDate(ts.fecha_asignado);
    const camino   = toDate(ts.fecha_en_camino);
    const entr     = toDate(ts.fecha_entregado);
    return {
      m_recibido_a_preparacion: diffMin(recibido, prep),
      m_preparacion_a_asignado: diffMin(prep, asign),
      m_asignado_a_en_camino:   diffMin(asign, camino),
      m_en_camino_a_entregado:  diffMin(camino, entr),
      m_total:                  diffMin(recibido, entr),
    };
  }
  function renderTimelineHTML(ts, metricas){
    const m = metricas || computeMetricasFromTs(ts);
    return `
      <table class="timeline-table">
        <tr><th>Recibido ‚Üí Preparaci√≥n</th><td>${fmt(m.m_recibido_a_preparacion)}</td><td class="muted">${ts.fecha_en_preparacion || '‚Äî'}</td></tr>
        <tr><th>Preparaci√≥n ‚Üí Asignado</th><td>${fmt(m.m_preparacion_a_asignado)}</td><td class="muted">${ts.fecha_asignado || '‚Äî'}</td></tr>
        <tr><th>Asignado ‚Üí En camino</th><td>${fmt(m.m_asignado_a_en_camino)}</td><td class="muted">${ts.fecha_en_camino || '‚Äî'}</td></tr>
        <tr><th>En camino ‚Üí Entregado</th><td>${fmt(m.m_en_camino_a_entregado)}</td><td class="muted">${ts.fecha_entregado || '‚Äî'}</td></tr>
        <tr class="sep"><td colspan="3"></td></tr>
        <tr class="total"><th>Total</th><td>${fmt(m.m_total)}</td><td></td></tr>
      </table>`;
  }
  function readTsFromCard(card){
    return {
      fecha_pedido: card.dataset.tsPedido || null,
      fecha_pago_aprobado: card.dataset.tsPago || null,
      fecha_en_preparacion: card.dataset.tsPreparacion || null,
      fecha_asignado: card.dataset.tsAsignado || null,
      fecha_en_camino: card.dataset.tsCamino || null,
      fecha_entregado: card.dataset.tsEntregado || null,
    };
  }
  function renderTimelineForCard(card){
    const id = card.dataset.orderId;
    const box = card.querySelector(`#timeline-${id}`);
    if(!box) return;
    const ts = readTsFromCard(card);
    box.innerHTML = renderTimelineHTML(ts, null);
  }
  // Render inicial timelines
  document.querySelectorAll('#en-curso-list .card[data-order-id]').forEach(renderTimelineForCard);

  // Crear card ‚Äúen curso‚Äù (cuando el cadete acepta)
  function buildEnCursoCard({id, estado, cliente, direccion, total, map_url}){
    const div = document.createElement('div');
    div.className = 'card mb-2';
    div.dataset.orderId = id;
    div.dataset.estado = estado || 'ASIGNADO';
    div.dataset.tsAsignado = new Date().toISOString();
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="flex-grow-1">
            <span class="fw-bold">#${id}</span>
            <span class="badge bg-primary badge-estado">${estado||'ASIGNADO'}</span>
            <div class="text-muted small mt-1">
              ${cliente||''} ‚Äî
              <span class="addr-ellipsis" title="${(direccion||'').replace(/"/g,'&quot;')}">${direccion||'‚Äî'}</span>
              ${map_url ? ` ‚Äî <a href="${map_url}" target="_blank" class="btn btn-sm btn-outline-primary">Ver mapa</a>` : ``}
            </div>
            <div class="text-muted small">Total aprox: $${parseFloat(total||0).toFixed(2)}</div>
            <details class="mt-2 timeline-details"><summary>Ver tiempos</summary><div class="mt-2 small timeline-box" id="timeline-${id}"></div></details>
          </div>
          <div class="text-end">
            <form method="post" action="/cadete/estado/${id}/" class="d-inline cadete-state-form">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
              <input type="hidden" name="estado" value="EN_CAMINO">
              <button class="btn btn-outline-warning me-1">Marcar EN CAMINO</button>
            </form>
            <form method="post" action="/cadete/estado/${id}/" class="d-inline cadete-state-form">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
              <input type="hidden" name="estado" value="ENTREGADO">
              <button class="btn btn-success">Marcar ENTREGADO</button>
            </form>
          </div>
        </div>
      </div>`;
    renderTimelineForCard(div);
    return div;
  }

  async function fetchFeed(){
    try{
      const res = await fetch("{% url 'cadete_feed' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await res.json();

      setAvailUI(!!data.disponible);

      const pedidos = data.pedidos || [];
      if(!pedidos.length){
        feedList.innerHTML = '<div class="alert alert-light border">No hay pedidos disponibles.</div>';
      }else{
        feedList.innerHTML = pedidos.map(p=>{
          const dirRaw = (p.direccion_legible||p.cliente_direccion||'').trim();
          const dir = dirRaw;
          const tel = (p.cliente_telefono||'').trim();
          const detalleHtml = (p.detalles||[]).map(d=>{
            const opt = d.opcion ? ` - ${d.opcion}` : '';
            const sab = (d.sabores&&d.sabores.length) ? d.sabores.join(', ') : 'Sin especificar';
            return `<li>${d.producto}${opt} (x${d.cant})<br><span class="text-muted small">Sabores: ${sab}</span></li>`;
          }).join('');
          const mapBtn = p.map_url ? `<a href="${p.map_url}" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Ver mapa</a>` : '';
          return `
            <div class="card mb-2" id="offer-${p.id}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <span class="fw-bold">#${p.id}</span>
                    <span class="badge bg-info text-dark">EN_PREPARACION</span>
                    <div class="text-muted small">
                      Cliente: <span class="fw-semibold">${p.cliente_nombre||''}</span> ¬∑ ${tel||'‚Äî'} ¬∑
                      <span class="addr-ellipsis" title="${dir.replace(/"/g,'&quot;')}">${dir||'‚Äî'}</span>
                    </div>
                    <div class="text-muted small">Total aprox: $${parseFloat(p.total||0).toFixed(2)}</div>
                    <details class="mt-2"><summary>Ver productos</summary><ul class="small mt-2 mb-0">${detalleHtml}</ul></details>
                  </div>
                  <div>
                    ${mapBtn}
                    <button class="btn btn-primary btn-accept"
                            data-url="/cadete/aceptar-pedido/${p.id}/"
                            data-id="${p.id}"
                            data-cliente="${(p.cliente_nombre||'').replace(/"/g,'&quot;')}"
                            data-dir="${dir.replace(/"/g,'&quot;')}"
                            data-map="${(p.map_url||'').replace(/"/g,'&quot;')}"
                            data-total="${p.total||0}">
                      ‚úÖ Aceptar pedido
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      // Sonar si hay nuevas ofertas (no en la primera carga)
      const currentIds = new Set(pedidos.map(p => String(p.id)));
      if(initializedFeed){
        let hasNew = false;
        for(const id of currentIds){ if(!lastOfferIds.has(id)){ hasNew = true; break; } }
        if(disponible && hasNew){ playSound(); }
      }
      initializedFeed = true;
      lastOfferIds = currentIds;

    }catch(e){
      feedList.innerHTML = '<div class="alert alert-warning">No se pudo cargar el feed.</div>';
    }
  }

  // Aceptar pedido (POST + a√±adir a ‚Äúen curso‚Äù)
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.btn-accept'); if(!btn) return;
    const url = btn.dataset.url;
    const id = btn.dataset.id;
    const cliente = btn.dataset.cliente || '';
    const direccion = btn.dataset.dir || '';
    const total = btn.dataset.total || '0';
    const map_url = btn.dataset.map || '';

    btn.disabled = true; btn.textContent = 'Aceptando‚Ä¶';
    try{
      const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken':csrftoken, 'X-Requested-With':'XMLHttpRequest'}});
      const ct = (res.headers.get('content-type')||'').toLowerCase();

      if(res.ok && ct.includes('application/json')){
        const data = await res.json();
        if(data.ok){
          if(enCursoEmpty) enCursoEmpty.remove();
          const card = buildEnCursoCard({id, estado: data.estado || 'ASIGNADO', cliente, direccion, total, map_url});
          enCursoList.prepend(card);
          const offer = document.getElementById(`offer-${id}`); if(offer) offer.remove();
          setAvailUI(false);
          return;
        }
      }
      location.href = url;
    }catch(e){
      location.href = url;
    }
  });

  // Interceptar cambio de estado (EN_CAMINO / ENTREGADO)
  document.addEventListener('submit', async (ev)=>{
    const form = ev.target.closest('.cadete-state-form'); if(!form) return;
    ev.preventDefault();
    const card = form.closest('.card[data-order-id]');
    const id = card.dataset.orderId;
    const estado = form.querySelector('input[name="estado"]').value;

    try{
      const res = await fetch(form.action, {
        method:'POST',
        headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'},
        body: `estado=${encodeURIComponent(estado)}`
      });
      const data = await res.json();
      if(!data.ok){ location.href=form.action; return; }

      // Cambiar badge
      const b = card.querySelector('.badge-estado');
      if(b){ b.textContent = data.estado || estado; }

      // Timestamps optimistas
      const nowIso = new Date().toISOString();
      if(estado==='EN_CAMINO'){ card.dataset.tsCamino = nowIso; }
      if(estado==='ENTREGADO'){ card.dataset.tsEntregado = nowIso; }

      renderTimelineForCard(card);

      // Si finaliz√≥, sacar card y actualizar disponibilidad si viene en payload
      if(data.finalizado){
        card.remove();
        if(typeof data.disponible !== 'undefined'){ setAvailUI(!!data.disponible); }
        if(!enCursoList.querySelector('.card')){
          if(enCursoEmpty){ enCursoEmpty.classList.remove('d-none'); }
          else { document.getElementById('en-curso').innerHTML = '<div class="alert alert-light border">No ten√©s pedidos en curso.</div>'; }
        }
      }
    }catch(e){
      location.href=form.action;
    }
  });

  // init + refresco peri√≥dico (feed)
  fetchFeed();
  setInterval(()=>{ fetchFeed(); }, 7000);

  // ===== WebSocket para ofertas en vivo (grupo cadetes_disponibles) ‚Äî opcional
  const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  const cadeteWsUrl = wsProtocol + window.location.host + '/ws/cadetes/notifications/';
  try{
    const cadeteSocket = new WebSocket(cadeteWsUrl);
    cadeteSocket.onmessage = (e)=>{
      const payload = JSON.parse(e.data||'{}');
      if(payload && payload.order_data){
        if(disponible){ playSound(); }
        fetchFeed(); // refrescamos la lista de ofertas
      }
    };
  }catch(e){}
</script>

<style>
  /* Timeline */
  .timeline-table{width:100%; border-collapse:collapse}
  .timeline-table th{font-weight:600; padding:.15rem .35rem 0 0}
  .timeline-table td{padding:.15rem .35rem}
  .timeline-table tr.sep td{border-top:1px solid #ddd; padding-top:.4rem}
  .timeline-table tr.total th{font-size:.95rem}
  .timeline-table .muted{color:#6c757d; font-weight:400}

  /* Direcci√≥n truncada elegante */
  .addr-ellipsis{
    max-width: min(46vw, 460px);
    display:inline-block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    vertical-align:bottom;
  }

  /* Barra inferior */
  .cadete-bottom{box-shadow:0 -4px 14px rgba(0,0,0,.05)}
</style>
{% endblock %}
