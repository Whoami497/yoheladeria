{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="text-center mb-3">Panel del Cadete</h2>
  <p class="text-muted text-center">Acept√° pedidos disponibles y actualiz√° el estado de tus entregas.</p>
  <hr>

  <!-- Estado / sonido / notificaciones -->
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span id="avail-badge" class="badge bg-secondary">Estado: No disponible</span>
    <span class="text-muted small">La disponibilidad se cambia desde el bot√≥n <strong>‚ÄúDisponible‚Äù</strong> de la barra inferior.</span>

    <div class="ms-auto"></div>
    <button id="enable-sound" class="btn btn-outline-primary">üîî Habilitar sonido</button>
    <span id="sound-warning" class="badge bg-warning text-dark d-none">Toc√° ‚ÄúHabilitar sonido‚Äù para o√≠r alertas</span>

    <!-- NUEVO: Notificaciones push -->
    <button id="enable-push" class="btn btn-outline-success">üõéÔ∏è Activar notificaciones</button>
    <span id="push-status" class="badge bg-secondary">Push: sin configurar</span>
  </div>

  <!-- Mis pedidos en curso -->
  <h5 class="mt-4">Mis pedidos en curso</h5>
  <div id="en-curso">
    {% if pedidos_en_curso %}
      <div id="en-curso-list">
        {% for p in pedidos_en_curso %}
          <div class="card mb-2" data-order-id="{{ p.id }}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <span class="fw-bold">#{{ p.id }}</span>
                  <span class="badge bg-primary">{{ p.estado }}</span>
                  <div class="text-muted small">{{ p.cliente_nombre }} ‚Äî {{ p.cliente_direccion|default:"" }}</div>
                  <div class="text-muted small">Total aprox: ${{ p.total_pedido|default_if_none:"0.00" }}</div>
                </div>
                <div>
                  <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="estado" value="EN_CAMINO">
                    <button class="btn btn-outline-warning me-1">Marcar EN CAMINO</button>
                  </form>
                  <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="estado" value="ENTREGADO">
                    <button class="btn btn-success">Marcar ENTREGADO</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div id="en-curso-empty" class="alert alert-light border">No ten√©s pedidos en curso.</div>
      <div id="en-curso-list"></div>
    {% endif %}
  </div>

  <!-- Pedidos disponibles -->
  <h5 class="mt-4">Pedidos disponibles</h5>
  <div id="feed-list">
    <div class="text-muted">Cargando‚Ä¶</div>
  </div>

  <div class="text-center my-4">
    <a href="{% url 'cadete_historial' %}">Ver mi historial</a>
  </div>
</div>

<script>
  // ===== CSRF =====
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Sonido (un bot√≥n para habilitar/probar) =====
  const orderSoundUrl = "{% static 'pedidos/sounds/new-order.mp3' %}";
  const enableBtn   = document.getElementById('enable-sound');
  const soundWarn   = document.getElementById('sound-warning');
  const audioEl     = new Audio(orderSoundUrl);
  audioEl.preload   = 'auto';

  let soundEnabled  = localStorage.getItem('cadete_sound_enabled') === '1';
  let audioReady    = false;

  function tryUnlockAudio(){
    audioEl.play().then(()=>{
      audioEl.pause(); audioEl.currentTime=0;
      audioReady=true;
      enableBtn.classList.replace('btn-outline-primary','btn-outline-success');
      enableBtn.textContent='üîî Sonido habilitado';
      soundWarn.classList.add('d-none');
    }).catch(()=>{
      audioReady=false;
      soundWarn.classList.remove('d-none');
    });
  }
  function playSound(){
    if(!soundEnabled) return;
    if(!audioReady){ soundWarn.classList.remove('d-none'); return; }
    try{ audioEl.currentTime=0; audioEl.play().catch(()=>{});}catch(e){}
  }
  enableBtn.addEventListener('click', ()=>{
    soundEnabled = true;
    localStorage.setItem('cadete_sound_enabled','1');
    tryUnlockAudio();
  });
  ['touchstart','click','keydown'].forEach(evt=>{
    document.addEventListener(evt, function once(){
      if(soundEnabled && !audioReady) tryUnlockAudio();
      document.removeEventListener(evt, once, {passive:true});
    }, {passive:true});
  });
  if(!soundEnabled){ soundWarn.classList.remove('d-none'); }

  // ===== NUEVO: Notificaciones Push =====
  const VAPID_PUBLIC_KEY = '{{ vapid_public_key|default:""|escapejs }}'; // viene del contexto de la vista
  const btnPush   = document.getElementById('enable-push');
  const pushBadge = document.getElementById('push-status');

  function setPushBadge(text, ok){
    pushBadge.textContent = text;
    pushBadge.className = 'badge ' + (ok ? 'bg-success' : 'bg-secondary');
  }

  function urlBase64ToUint8Array(base64String){
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64  = (base64String + padding).replace(/-/g,'+').replace(/_/g,'/');
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for(let i=0;i<rawData.length;i++){ outputArray[i]=rawData.charCodeAt(i); }
    return outputArray;
  }

  async function saveSubscription(sub){
    const res = await fetch("{% url 'save_subscription' %}", {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
      body: JSON.stringify(sub)
    });
    return res.ok;
  }

  async function ensureServiceWorker(){
    if(!('serviceWorker' in navigator)){ throw new Error('SW no soportado'); }
    // Registramos /sw.js que ya sirve el backend con scope ra√≠z
    const reg = await navigator.serviceWorker.register('/sw.js');
    return reg;
  }

  async function getOrCreateSubscription(reg){
    const existing = await reg.pushManager.getSubscription();
    if(existing) return existing;
    const appKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);
    return await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey: appKey});
  }

  async function activatePush(){
    if(!VAPID_PUBLIC_KEY){
      setPushBadge('Push: sin VAPID', false);
      alert('No hay VAPID_PUBLIC_KEY configurada en el servidor.');
      return;
    }
    if(!('Notification' in window)){
      setPushBadge('Push no disponible', false);
      return;
    }

    // permiso
    let perm = Notification.permission; // 'default' | 'granted' | 'denied'
    if(perm === 'default'){ perm = await Notification.requestPermission(); }
    if(perm !== 'granted'){
      setPushBadge('Push: permiso denegado', false);
      return;
    }

    try{
      const reg  = await ensureServiceWorker();
      const sub  = await getOrCreateSubscription(reg);
      const ok   = await saveSubscription(sub.toJSON ? sub.toJSON() : sub);
      if(ok){
        setPushBadge('Push: activo', true);
        btnPush.classList.replace('btn-outline-success','btn-success');
        btnPush.textContent = 'üõéÔ∏è Notificaciones activas';
      }else{
        setPushBadge('Push: error al guardar', false);
      }
    }catch(e){
      console.error(e);
      setPushBadge('Push: error', false);
    }
  }

  // Estado inicial de push
  (async ()=>{
    try{
      if(!VAPID_PUBLIC_KEY){ setPushBadge('Push: sin VAPID', false); return; }
      if(!('serviceWorker' in navigator) || !('Notification' in window)){
        setPushBadge('Push no disponible', false); return;
      }
      // Si ya est√° concedido, intentamos suscribir silenciosamente
      if(Notification.permission === 'granted'){
        const reg = await ensureServiceWorker();
        const sub = await getOrCreateSubscription(reg);
        const ok  = await saveSubscription(sub.toJSON ? sub.toJSON() : sub);
        setPushBadge(ok ? 'Push: activo' : 'Push: error al guardar', !!ok);
        if(ok){
          btnPush.classList.replace('btn-outline-success','btn-success');
          btnPush.textContent = 'üõéÔ∏è Notificaciones activas';
        }
      }else{
        setPushBadge('Push: requiere permiso', false);
      }
    }catch(e){
      setPushBadge('Push: error', false);
    }
  })();

  btnPush.addEventListener('click', activatePush);

  // ===== Disponibilidad (solo visualizar) & Feed =====
  const availBadge   = document.getElementById('avail-badge');
  const feedList     = document.getElementById('feed-list');
  const enCursoList  = document.getElementById('en-curso-list');
  const enCursoEmpty = document.getElementById('en-curso-empty');

  let disponible = false;
  let lastOfferIds = new Set();
  let initializedFeed = false;

  function setAvailUI(val){
    disponible = !!val;
    availBadge.className = 'badge ' + (disponible ? 'bg-success' : 'bg-secondary');
    availBadge.textContent = 'Estado: ' + (disponible ? 'Disponible' : 'No disponible');
  }

  function buildEnCursoCard({id, estado, cliente, direccion, total}){
    const div = document.createElement('div');
    div.className = 'card mb-2';
    div.dataset.orderId = id;
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <span class="fw-bold">#${id}</span>
            <span class="badge bg-primary">${estado}</span>
            <div class="text-muted small">${cliente||''} ‚Äî ${direccion||''}</div>
            <div class="text-muted small">Total aprox: $${parseFloat(total||0).toFixed(2)}</div>
          </div>
          <div>
            <form method="post" action="/cadete/estado/${id}/" class="d-inline">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
              <input type="hidden" name="estado" value="EN_CAMINO">
              <button class="btn btn-outline-warning me-1">Marcar EN CAMINO</button>
            </form>
            <form method="post" action="/cadete/estado/${id}/" class="d-inline">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
              <input type="hidden" name="estado" value="ENTREGADO">
              <button class="btn btn-success">Marcar ENTREGADO</button>
            </form>
          </div>
        </div>
      </div>`;
    return div;
  }

  async function fetchFeed(){
    try{
      const res = await fetch("{% url 'cadete_feed' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await res.json();

      setAvailUI(!!data.disponible);

      const pedidos = data.pedidos || [];
      if(!pedidos.length){
        feedList.innerHTML = '<div class="alert alert-light border">No hay pedidos disponibles.</div>';
      }else{
        feedList.innerHTML = pedidos.map(p=>{
          const dir = (p.cliente_direccion||'').trim();
          const tel = (p.cliente_telefono||'').trim();
          const detalleHtml = (p.detalles||[]).map(d=>{
            const opt = d.opcion ? ` - ${d.opcion}` : '';
            const sab = (d.sabores&&d.sabores.length) ? d.sabores.join(', ') : 'Sin especificar';
            return `<li>${d.producto}${opt} (x${d.cant})<br><span class="text-muted small">Sabores: ${sab}</span></li>`;
          }).join('');
          return `
            <div class="card mb-2" id="offer-${p.id}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <span class="fw-bold">#${p.id}</span>
                    <span class="badge bg-info text-dark">EN_PREPARACION</span>
                    <div class="text-muted small">Cliente: <span class="fw-semibold">${p.cliente_nombre||''}</span> ¬∑ ${tel||'‚Äî'} ¬∑ ${dir||'‚Äî'}</div>
                    <div class="text-muted small">Total aprox: $${parseFloat(p.total||0).toFixed(2)}</div>
                    <details class="mt-2"><summary>Ver productos</summary><ul class="small mt-2 mb-0">${detalleHtml}</ul></details>
                  </div>
                  <div>
                    <button class="btn btn-primary btn-accept"
                            data-url="/cadete/aceptar-pedido/${p.id}/"
                            data-id="${p.id}"
                            data-cliente="${(p.cliente_nombre||'').replace(/"/g,'&quot;')}"
                            data-dir="${(p.cliente_direccion||'').replace(/"/g,'&quot;')}"
                            data-total="${p.total||0}">
                      ‚úÖ Aceptar pedido
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        }).join('');
      }

      // Sonar si hay nuevas ofertas (no en la primera carga)
      const currentIds = new Set(pedidos.map(p => String(p.id)));
      if(initializedFeed){
        let hasNew = false;
        for(const id of currentIds){ if(!lastOfferIds.has(id)){ hasNew = true; break; } }
        if(disponible && hasNew){ playSound(); }
      }
      initializedFeed = true;
      lastOfferIds = currentIds;

    }catch(e){
      feedList.innerHTML = '<div class="alert alert-warning">No se pudo cargar el feed.</div>';
    }
  }

  // Aceptar pedido (POST a /cadete/aceptar-pedido/ID/, y a√±adir a ‚Äúen curso‚Äù sin refrescar)
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.btn-accept'); if(!btn) return;
    const url = btn.dataset.url;
    const id = btn.dataset.id;
    const cliente = btn.dataset.cliente || '';
    const direccion = btn.dataset.dir || '';
    const total = btn.dataset.total || '0';

    btn.disabled = true; btn.textContent = 'Aceptando‚Ä¶';
    try{
      const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken':csrftoken, 'X-Requested-With':'XMLHttpRequest'}});
      const ct = (res.headers.get('content-type')||'').toLowerCase();

      if(res.ok && ct.includes('application/json')){
        const data = await res.json();
        if(data.ok){
          // a√±adir card a "en curso"
          if(enCursoEmpty) enCursoEmpty.remove();
          const card = buildEnCursoCard({id, estado: data.estado || 'ASIGNADO', cliente, direccion, total});
          enCursoList.prepend(card);
          // sacar oferta de la lista
          const offer = document.getElementById(`offer-${id}`); if(offer) offer.remove();
          // al aceptar, backend deja no disponible -> reflejar
          setAvailUI(false);
          return;
        }
      }
      // fallback navegaci√≥n normal
      location.href = url;
    }catch(e){
      location.href = url;
    }
  });

  // init + refresco peri√≥dico
  fetchFeed();
  setInterval(()=>{ fetchFeed(); }, 7000);
</script>
{% endblock %}
