{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-2">Panel del Cadete</h2>

  {% if pedidos_en_curso %}
    <div class="alert alert-info">Tenés pedidos en curso.</div>
    {% for p in pedidos_en_curso %}
      <div class="card mb-3" id="pedido-{{ p.id }}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <h6 class="mb-1">
                #{{ p.id }} <span class="badge bg-secondary js-badge">{{ p.estado }}</span>
              </h6>
              <div class="small text-muted">
                {{ p.cliente_nombre|default:"" }} · {{ p.cliente_telefono|default:"" }} · {{ p.cliente_direccion|default:"" }}
              </div>
              <ul class="small mb-2 mt-2">
                {% for d in p.detalles.all %}
                  <li>
                    {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                  </li>
                {% endfor %}
              </ul>
              <div class="fw-bold">Total: ${{ p.total_pedido|default_if_none:"0.00" }}</div>
            </div>
            <div class="text-end">
              <form action="{% url 'cadete_set_estado' p.id %}" method="post" class="d-inline js-state-form">
                {% csrf_token %}
                <input type="hidden" name="estado" value="EN_CAMINO">
                <button class="btn btn-outline-primary btn-sm" {% if p.estado != 'ASIGNADO' %}disabled{% endif %}>Pasar a EN CAMINO</button>
              </form>
              <form action="{% url 'cadete_set_estado' p.id %}" method="post" class="d-inline js-state-form">
                {% csrf_token %}
                <input type="hidden" name="estado" value="ENTREGADO">
                <button class="btn btn-success btn-sm">Marcar ENTREGADO</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info">No tenés pedidos en curso.</div>
  {% endif %}

  <h5 class="mt-4">Pedidos disponibles <small class="text-muted">(se actualiza solo)</small></h5>
  <div id="feed-list">
    <div class="text-muted">Cargando…</div>
  </div>

  <div class="mt-3">
    <button id="btn-refresh" class="btn btn-sm btn-outline-secondary">Actualizar ahora</button>
  </div>
</div>

<script>
  // === CSRF desde cookie para formularios creados por JS ===
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`); 
    if (v.length === 2) return v.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // === Sonido al llegar nuevos pedidos al feed (si "Disponible" está ON)
  const ORDER_SOUND_URL = "{% static 'pedidos/sounds/new-order.mp3' %}";
  function playSound(){ try{ new Audio(ORDER_SOUND_URL).play().catch(()=>{});}catch(e){} }

  // Estado “Disponible” leído desde el botón global de la barra inferior (base.html)
  function disponibleON(){
    const btn = document.getElementById('btn-cadete-dispo');
    return btn && btn.dataset.on === '1';
  }

  // === FEED dinámico ===
  const FEED_URL = "{% url 'cadete_feed' %}";
  const feedList = document.getElementById('feed-list');
  const knownIds = new Set();

  function buildAcceptCard(o){
    const li = document.createElement('div');
    li.className = 'card mb-3';
    li.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <h6 class="mb-1">#${o.id} <span class="badge bg-info text-dark">EN_PREPARACION</span></h6>
            <div class="small text-muted">${o.cliente_nombre || ''} · ${o.cliente_telefono || ''} · ${o.cliente_direccion || ''}</div>
            <ul class="small mb-2 mt-2">
              ${(o.detalles||[]).map(d=>{
                const name = d.opcion ? `${d.producto} - ${d.opcion}` : d.producto;
                return `<li>${name} (x${d.cant})</li>`;
              }).join('')}
            </ul>
            <div class="fw-bold">Total: $${o.total}</div>
          </div>
          <div class="text-end">
            <form method="post" action="/cadete/aceptar-pedido/${o.id}/">
              <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
              <button class="btn btn-primary">Aceptar pedido</button>
            </form>
          </div>
        </div>
      </div>
    `;
    return li;
  }

  async function loadFeed(){
    try{
      const res = await fetch(FEED_URL, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const j = await res.json().catch(()=>({ok:false,pedidos:[]}));
      feedList.innerHTML = '';
      if(!j.ok || !j.pedidos || !j.pedidos.length){
        feedList.innerHTML = '<div class="text-muted">No hay pedidos disponibles por ahora.</div>';
        return;
      }
      const nuevos = [];
      j.pedidos.forEach(p => {
        if(!knownIds.has(p.id)){ nuevos.push(p.id); knownIds.add(p.id); }
        feedList.appendChild(buildAcceptCard(p));
      });
      if (nuevos.length && disponibleON()) playSound();
    }catch(e){
      console.error(e);
      feedList.innerHTML = '<div class="text-danger">No se pudo cargar el feed.</div>';
    }
  }

  document.getElementById('btn-refresh').addEventListener('click', loadFeed);
  loadFeed();
  setInterval(loadFeed, 12000);

  // === Cambios de estado EN_CAMINO / ENTREGADO vía AJAX (sin salir de la página)
  function badgeClass(estado){
    const e = (estado || '').toUpperCase();
    if (e === 'EN_CAMINO') return 'bg-warning text-dark';
    if (e === 'ENTREGADO') return 'bg-success';
    return 'bg-secondary';
  }

  document.addEventListener('submit', async (ev)=>{
    const form = ev.target.closest('.js-state-form');
    if(!form) return;
    ev.preventDefault();

    const btn = form.querySelector('button');
    const url = form.getAttribute('action');
    const fd = new FormData(form);

    btn.disabled = true;
    const btnHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Enviando…';

    try{
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: fd
      });
      const j = await res.json().catch(()=>null);
      if (j && j.ok){
        const card = form.closest('.card');
        const badge = card.querySelector('.js-badge');
        if (badge){
          badge.className = 'badge js-badge ' + badgeClass(j.estado);
          badge.textContent = j.estado;
        }
        // Si entregó, refrescamos para sacar el pedido de “en curso”
        if (j.estado === 'ENTREGADO') {
          location.reload();
          return;
        }
      } else {
        // Fallback: recargar
        location.reload();
      }
    }catch(e){
      console.error(e);
      location.reload();
    }finally{
      btn.disabled = false;
      btn.innerHTML = btnHtml;
    }
  });
</script>
{% endblock %}
