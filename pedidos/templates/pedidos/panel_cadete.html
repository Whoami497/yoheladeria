{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="text-center mb-3">Panel del Cadete</h2>
  <p class="text-muted text-center">Aceptá pedidos disponibles y actualizá el estado de tus entregas.</p>
  <hr>

  <!-- Estado / disponibilidad -->
  <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
    <span id="avail-badge" class="badge bg-secondary">Estado: —</span>
    <button id="toggle-available" class="btn btn-success">
      Ponerme Disponible
    </button>
    <small id="avail-help" class="text-muted">Vas a recibir ofertas nuevas automáticamente.</small>
  </div>

  <!-- Mis pedidos en curso -->
  <h5 class="mt-4">Mis pedidos en curso</h5>
  {% if pedidos_en_curso %}
    {% for p in pedidos_en_curso %}
      <div class="card mb-2">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <span class="fw-bold">#{{ p.id }}</span>
              <span class="badge bg-primary">{{ p.estado }}</span>
              <div class="text-muted small">{{ p.cliente_nombre }} — {{ p.cliente_direccion|default:"" }}</div>
              <div class="text-muted small">Total aprox: ${{ p.total_pedido|default_if_none:"0.00" }}</div>
            </div>
            <div>
              <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="estado" value="EN_CAMINO">
                <button class="btn btn-outline-warning me-1">Marcar EN CAMINO</button>
              </form>
              <form method="post" action="{% url 'cadete_set_estado' p.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="estado" value="ENTREGADO">
                <button class="btn btn-success">Marcar ENTREGADO</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-light border">No tenés pedidos en curso.</div>
  {% endif %}

  <!-- Pedidos disponibles -->
  <h5 class="mt-4">Pedidos disponibles</h5>
  <div id="feed-list">
    <div class="text-muted">Cargando…</div>
  </div>

  <div class="text-center my-4">
    <a href="{% url 'cadete_historial' %}">Ver mi historial</a>
  </div>
</div>

<script>
  // ===== Helpers =====
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  const availBadge = document.getElementById('avail-badge');
  const toggleBtn  = document.getElementById('toggle-available');
  const feedList   = document.getElementById('feed-list');

  let disponible = false;

  function setAvailUI(val){
    disponible = !!val;
    availBadge.className = 'badge ' + (disponible ? 'bg-success' : 'bg-secondary');
    availBadge.textContent = 'Estado: ' + (disponible ? 'Disponible' : 'No disponible');
    toggleBtn.className = 'btn ' + (disponible ? 'btn-outline-danger' : 'btn-success');
    toggleBtn.textContent = disponible ? 'Ponerme NO disponible' : 'Ponerme Disponible';
  }

  async function fetchFeed(){
    try{
      const res = await fetch("{% url 'cadete_feed' %}", {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await res.json();
      setAvailUI(!!data.disponible);

      const pedidos = data.pedidos || [];
      if(!pedidos.length){
        feedList.innerHTML = '<div class="alert alert-light border">No hay pedidos disponibles.</div>';
        return;
      }
      feedList.innerHTML = pedidos.map(p => {
        const dir = (p.cliente_direccion||'').trim();
        const tel = (p.cliente_telefono||'').trim();
        const detalleHtml = (p.detalles||[]).map(d=>{
          const opt = d.opcion ? ` - ${d.opcion}` : '';
          const sab = (d.sabores&&d.sabores.length) ? d.sabores.join(', ') : 'Sin especificar';
          return `<li>${d.producto}${opt} (x${d.cant})<br><span class="text-muted small">Sabores: ${sab}</span></li>`;
        }).join('');
        return `
          <div class="card mb-2" id="offer-${p.id}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                  <span class="fw-bold">#${p.id}</span>
                  <span class="badge bg-info text-dark">EN_PREPARACION</span>
                  <div class="text-muted small">Cliente: <span class="fw-semibold">${p.cliente_nombre||''}</span> · ${tel||'—'} · ${dir||'—'}</div>
                  <div class="text-muted small">Total aprox: $${parseFloat(p.total||0).toFixed(2)}</div>
                  <details class="mt-2"><summary>Ver productos</summary><ul class="small mt-2 mb-0">${detalleHtml}</ul></details>
                </div>
                <div>
                  <button class="btn btn-primary btn-accept" data-id="${p.id}">✅ Aceptar pedido</button>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');
    }catch(e){
      feedList.innerHTML = '<div class="alert alert-warning">No se pudo cargar el feed.</div>';
    }
  }

  // Toggle único
  toggleBtn.addEventListener('click', async ()=>{
    try{
      const form = new URLSearchParams();
      form.append('disponible', disponible ? '0' : '1');
      const res = await fetch("{% url 'cadete_toggle_disponible' %}", {
        method: 'POST',
        headers: {'X-CSRFToken':csrftoken, 'X-Requested-With':'XMLHttpRequest', 'Content-Type':'application/x-www-form-urlencoded'},
        body: form.toString()
      });
      const data = await res.json();
      if(data.ok){
        setAvailUI(data.disponible);
        // si quedó no disponible, vaciamos feed
        if(!data.disponible) feedList.innerHTML = '<div class="alert alert-light border">No hay pedidos disponibles.</div>';
        else fetchFeed();
      }else if(data.error==='ocupado'){
        alert('Primero tenés que finalizar tu pedido en curso.');
      }else{
        alert('No se pudo actualizar la disponibilidad.');
      }
    }catch(e){ alert('Error de red.'); }
  });

  // Aceptar pedido
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('.btn-accept'); if(!btn) return;
    btn.disabled = true; btn.textContent = 'Aceptando…';
    const id = btn.dataset.id;
    try{
      const res = await fetch(`/aceptar-pedido/${id}/`, {method:'POST', headers:{'X-CSRFToken':csrftoken, 'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        document.getElementById(`offer-${id}`)?.remove();
        fetchFeed();
        setAvailUI(false); // al aceptar, el backend deja el cadete NO disponible
      }else{
        location.href = `/aceptar-pedido/${id}/`;
      }
    }catch(e){ location.href = `/aceptar-pedido/${id}/`; }
  });

  // init
  fetchFeed();
  // refresco liviano cada 20s sólo si sigue disponible
  setInterval(()=>{ if(disponible) fetchFeed(); }, 20000);
</script>
{% endblock %}
