{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">

  <h2 class="section-title mb-3 text-center">Tu Carrito de Compras</h2>

  {# ==================== LISTA DE ÍTEMS ==================== #}
  {% if carrito_items %}
    <div class="vstack gap-3 mb-4">
      {% for i in carrito_items %}
        <div class="card shadow-sm cart-item">
          <div class="card-body d-flex gap-3 align-items-start">
            <div class="item-thumb">
              {% if i.imagen_mostrada %}
                <img src="{% static i.imagen_mostrada %}" alt="{{ i.producto_nombre }}">
              {% else %}
                <div class="thumb-placeholder">Sin<br>Imagen</div>
              {% endif %}
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
                <h6 class="mb-1 item-title">{{ i.producto_nombre }}</h6>
                <a href="{% url 'eliminar_del_carrito' i.key %}" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i> Eliminar
                </a>
              </div>

              {% if i.opcion_nombre %}
                <span class="badge bg-light text-dark border me-1">Opción: {{ i.opcion_nombre }}</span>
              {% endif %}
              {% if i.sabores_nombres %}
                <span class="badge bg-light text-dark border">Sabores: {{ i.sabores_nombres|join:", " }}</span>
              {% else %}
                <span class="text-muted small d-block mt-1">Sabores: N/A</span>
              {% endif %}

              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="text-muted">Cantidad: <span class="fw-semibold">{{ i.cantidad }}</span></div>
                <div class="text-end">
                  <div class="small text-muted">Precio unidad</div>
                  <div class="fw-semibold">${{ i.precio_unidad|floatformat:2 }}</div>
                </div>
                <div class="text-end">
                  <div class="small text-muted">Subtotal</div>
                  <div class="fw-bold">${{ i.subtotal|floatformat:2 }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center">Tu carrito está vacío.</div>
  {% endif %}

  {# ==================== DATOS + RESUMEN ==================== #}
  <form method="post" class="vstack gap-3">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Datos de Envío y Contacto</h5>

        <div class="mb-3">
          <label class="form-label">Nombre Completo:</label>
          <input type="text" name="cliente_nombre" class="form-control" placeholder="Ej: Juan Pérez" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Dirección de Envío:</label>
          <input id="direccion-envio" type="text" name="cliente_direccion" class="form-control" placeholder="Calle, número, barrio…" required>
          <div class="form-text">Ingresá la dirección. Podés estimar el envío con el selector de zona.</div>
        </div>

        <div class="mb-0">
          <label class="form-label">Teléfono:</label>
          <input type="tel" name="cliente_telefono" class="form-control" placeholder="Ej: 3834 123456" required>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Método de Pago</h5>
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-6">
            <label class="form-label">Selecciona el método de pago:</label>
            <select name="metodo_pago" class="form-select">
              <option value="EFECTIVO">Efectivo</option>
              <option value="MERCADOPAGO">Mercado Pago</option>
            </select>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label">Zona de Envío (estimación):</label>
            <select id="envio-zona" class="form-select">
              <option value="0">Retiro en local (sin envío)</option>
              <option value="1500">Cercana (≈ hasta 1 km) — $1.500</option>
              <option value="2500">Media (≈ 1–3 km) — $2.500</option>
              <option value="3500">Lejana (≈ 3–5 km) — $3.500</option>
            </select>
            <div class="form-text">
              Estimación orientativa. El total final se actualiza abajo. (Luego la podemos reemplazar por Google Maps).
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm order-summary">
      <div class="card-body">
        <h5 class="mb-3">Resumen</h5>

        <div class="d-flex justify-content-between">
          <span>Subtotal productos</span>
          <span id="subtotal">${{ total|floatformat:2 }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span>Envío estimado</span>
          <span id="envio">$0.00</span>
        </div>
        <hr class="my-2">
        <div class="d-flex justify-content-between fs-5 fw-semibold">
          <span>Total a pagar</span>
          <span id="total-final">${{ total|floatformat:2 }}</span>
        </div>

        <button id="checkout-submit" type="submit" class="btn btn-primary w-100 mt-3 btn-lg">
          Finalizar Pedido
        </button>
      </div>
    </div>
  </form>

  <div class="text-center mt-3">
    <a href="{% url 'index' %}" class="btn btn-link">← Volver al inicio</a>
  </div>

</div>

<style>
  /* Tarjeta de ítem */
  .cart-item .item-thumb{width:92px;height:92px;flex:0 0 92px;border-radius:12px;overflow:hidden;background:#f6f7fb}
  .cart-item .item-thumb img{width:100%;height:100%;object-fit:cover}
  .thumb-placeholder{width:100%;height:100%;display:grid;place-items:center;font-size:.75rem;color:#6c757d}
  .item-title{max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Resumen pegajoso en pantallas chicas (no tapa el botón) */
  @media (max-width: 576px){
    .order-summary{position:sticky;bottom:0;z-index:5;border-radius:16px 16px 0 0}
  }
</style>

<script>
  // === Estimación simple de envío (sin Maps por ahora) ===
  (function(){
    const subtotal = parseFloat("{{ total|floatformat:2 }}".replace(",", "")) || 0;
    const envioSel = document.getElementById('envio-zona');
    const envioEl  = document.getElementById('envio');
    const totalEl  = document.getElementById('total-final');

    function fmt(n){ return '$' + n.toFixed(2); }

    function recalc(){
      const envio = parseFloat(envioSel.value || '0') || 0;
      envioEl.textContent = fmt(envio);
      totalEl.textContent = fmt(subtotal + envio);
    }
    envioSel.addEventListener('change', recalc);
    recalc();
  })();
</script>
{% endblock %}
