{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Tu Carrito</h2>

  <!-- √çtems -->
  <div id="cart-list" class="mb-4">
    {% for item in carrito_items %}
      <div class="card cart-item mb-3 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex align-items-start gap-3">
            <div class="thumb-wrap">
              {% if item.imagen_mostrada %}
                <img class="thumb" src="{% static item.imagen_mostrada %}" alt="{{ item.producto_nombre }}">
              {% else %}
                <div class="thumb thumb-placeholder">IMG</div>
              {% endif %}
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <h6 class="mb-1">{{ item.producto_nombre }}</h6>
                <div class="text-end">
                  <div class="fw-semibold">${{ item.subtotal|floatformat:2 }}</div>
                  <div class="text-muted small">x{{ item.cantidad }} ¬∑ ${{ item.precio_unidad|floatformat:2 }}</div>
                </div>
              </div>

              <div class="small text-muted">
                {% if item.opcion_nombre %}<span class="me-1">Opci√≥n: {{ item.opcion_nombre }}</span>¬∑{% endif %}
                Sabores:
                {% if item.sabores_nombres %}
                  {{ item.sabores_nombres|join:", " }}
                {% else %}N/A{% endif %}
              </div>

              <div class="mt-2 d-flex justify-content-end">
                <a href="{% url 'eliminar_del_carrito' item.key %}" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash"></i> Eliminar
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-info">Tu carrito est√° vac√≠o.</div>
    {% endfor %}
  </div>

  <!-- Entrega, pago y totales (abajo) -->
  <div class="card shadow-sm">
    <div class="card-body p-3">
      <h5 class="mb-3">Entrega y pago</h5>

      <!-- Banner: Env√≠o gratis -->
      <div id="free-ship-banner" class="alert py-2 px-3 d-none"></div>

      <form id="checkout-form" method="post">
        {% csrf_token %}

        <!-- Campos que espera la vista -->
        <input type="hidden" name="modo_envio" id="modo_envio" value="pickup">
        <input type="hidden" name="geo_latlng" id="geo-latlng" value="">
        <input type="hidden" name="cliente_direccion" id="cliente_direccion" value="">
        <!-- Confirmaci√≥n de transferencia (se setea con el checkbox) -->
        <input type="hidden" name="transfer_confirmed" id="transfer_confirmed" value="0">

        <!-- Env√≠o -->
        <div class="mb-3">
          <label class="form-label">Env√≠o</label>
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <select id="envio" class="form-select form-select-sm w-auto envio-select">
              <option value="0" selected>Retiro en local</option>
              <!-- La opci√≥n ‚Äú‚âà X km‚Äù la agrega JS -->
            </select>
            <div class="text-end">
              <div class="small text-muted lh-1">Costo</div>
              <div class="fw-semibold fs-6" id="envio-amount">$0.00</div>
            </div>
          </div>

          <!-- Vista previa de direcci√≥n (solo texto, sin link ni coords) -->
          <div id="addrPreview" class="addr d-none mt-2">
            <div class="addr-text text-truncate" id="addrText">‚Äî</div>
          </div>

          <div class="mt-2">
            <button type="button" class="btn btn-outline-success btn-sm" id="btn-map">üìç Elegir ubicaci√≥n</button>
          </div>
        </div>

        <!-- Datos de contacto -->
        <div class="mb-3">
          <label class="form-label">Nombre completo</label>
          <input type="text" class="form-control" name="cliente_nombre"
                  value="{{ request.user.get_full_name|default:request.user.username }}" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Tel√©fono</label>
          <input type="tel" class="form-control" name="cliente_telefono" placeholder="Ej: 3834 123456"
                 autocomplete="tel" inputmode="tel" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Referencias (opcional)</label>
          <input class="form-control" name="nota_pedido" placeholder="Ej: Timbre negro; torre B; dpto 2">
        </div>

        <!-- Pago -->
        <div class="mb-3">
          <label class="form-label">M√©todo de pago</label>
          <select class="form-select" name="metodo_pago" id="metodo_pago" required>
            <option value="EFECTIVO">Efectivo</option>
            <option value="MERCADOPAGO">Mercado Pago</option>
            <option value="TRANSFERENCIA">Transferencia bancaria</option>
          </select>

          <!-- Bloque visible SOLO para TRANSFERENCIA -->
          <div id="transfer-box" class="alert alert-warning mt-2 d-none">
            <div class="fw-semibold mb-1">Datos para transferir</div>
            <!-- üîß EDITAR ESTOS DATOS -->
            <div><strong>Alias:</strong> ritaregalado.mp</div>
            <div><strong>Titular:</strong> rita virginia regalado</div>
            <!-- opcionales: -->
            <!-- <div><strong>CBU:</strong> 0000003100081218774622</div> -->
            <!-- <div><strong>CUIT/CUIL:</strong> 27-24776697-4</div> -->

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="chk-transfer">
              <label class="form-check-label" for="chk-transfer">
                Ya hice la transferencia (tengo el comprobante).
              </label>
            </div>
            <div class="small text-muted mt-1">
              *  hacerlo ahora y marcar la casilla.
            </div>
          </div>
        </div>

        <!-- Totales -->
        <div class="card summary border-0 bg-light">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="text-muted">Subtotal</span>
              <strong id="subtotal-amount">${{ total|floatformat:2 }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-muted">Env√≠o</span>
              <strong id="envio-amount-inline">$0.00</strong>
            </div>
            <hr class="my-2">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fs-6 fw-semibold">Total</span>
              <span class="fs-4 fw-bold" id="total-final">${{ total|floatformat:2 }}</span>
            </div>
          </div>
        </div>

        <button id="btn-submit" type="submit" class="btn btn-primary w-100 py-2 mt-3" disabled>
          Finalizar Pedido
        </button>
        <div class="small text-danger mt-2" id="submit-warn" style="display:none;">
          Seleccion√° una ubicaci√≥n en el mapa o eleg√≠ ‚ÄúRetiro en local‚Äù.
        </div>
        <div class="small text-danger mt-1 d-none" id="transfer-warn">
          Para pagar por transferencia, marc√° ‚ÄúYa hice la transferencia‚Äù.
        </div>
      </form>

      <div class="text-center mt-3">
        <a href="{% url 'index' %}" class="btn btn-link">‚Üê Volver al inicio</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal del mapa (Leaflet) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Eleg√≠ tu ubicaci√≥n</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="map" style="height:420px;"></div>
        <div class="small mt-2">
          <span id="map-status" class="text-muted">Arrastr√° el pin para ajustar.</span><br>
          <span id="map-outside" class="text-danger" style="display:none;">‚ö†Ô∏è Fuera del radio de servicio.</span>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto small" id="map-coords">‚Äì</div>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="map-use" disabled>Usar esta ubicaci√≥n</button>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- JS: mapa + c√°lculo autom√°tico + persistencia + TRANSFERENCIA + BANNER FREE SHIPPING -->
<script>
(function(){
  // ---------- CONFIG ----------
  const STORE = { lat: -28.4705234, lng: -65.7937524 };
  const SERVICE_RADIUS_M = 3500; // 0 = sin l√≠mite visual

  // Umbral env√≠o gratis (viene del backend)
  const FREE_SHIP_THRESHOLD = Number('{{ free_shipping_threshold|default:"0" }}') || 0;

  // ---------- LocalStorage ----------
  const LS_GEO  = 'yl_geo_latlng';
  const LS_COST = 'yl_envio_cost';
  const LS_KM   = 'yl_envio_km';

  const fmtMoney = (n) => '$' + Number(n).toFixed(2);
  const subtotal = parseFloat('{{ total|floatformat:2 }}') || 0;

  const envioSel   = document.getElementById('envio');
  const envioEl    = document.getElementById('envio-amount');         // costo en bloque env√≠o
  const envioInline= document.getElementById('envio-amount-inline');  // costo en resumen
  const totalEl    = document.getElementById('total-final');
  const subEl      = document.getElementById('subtotal-amount');

  const geoHidden  = document.getElementById('geo-latlng');
  const modoHidden = document.getElementById('modo_envio');
  const clienteDirHidden = document.getElementById('cliente_direccion');

  const addrWrap = document.getElementById('addrPreview');
  const addrText = document.getElementById('addrText');

  const btnMap   = document.getElementById('btn-map');
  const btnSubmit= document.getElementById('btn-submit');
  const submitWarn = document.getElementById('submit-warn');
  const transferWarn = document.getElementById('transfer-warn');
  const form     = document.getElementById('checkout-form');

  // pago/transferencia
  const paySel         = document.getElementById('metodo_pago');
  const transferBox    = document.getElementById('transfer-box');
  const chkTransfer    = document.getElementById('chk-transfer');
  const transferHidden = document.getElementById('transfer_confirmed');

  // Banner env√≠o gratis
  const freeBanner = document.getElementById('free-ship-banner');

  function setSubmitEnabled(v){
    btnSubmit.disabled = !v;
    submitWarn.style.display = v ? 'none' : '';
    transferWarn.classList.toggle('d-none', true);
  }

  function hideAddr(){
    addrWrap.classList.add('d-none');
    addrText.textContent = '‚Äî';
    clienteDirHidden.value = '';
  }
  function showAddr(data, latlng){
    const legible = (data && (data.direccion_corta || data.direccion_legible)) || 'Ubicaci√≥n seleccionada';
    addrText.textContent = 'üìç ' + legible;
    addrWrap.classList.remove('d-none');
    if (data && data.direccion_legible) {
      clienteDirHidden.value = data.direccion_legible;
    }
  }

  // Si es delivery, ahora aceptamos env√≠o $0 (env√≠o gratis).
  function envioOkCond(){
    const isPickup = envioSel.value === '0';
    const hasPoint = !!geoHidden.value;
    return isPickup || hasPoint; // antes ped√≠a costo > 0; ahora permitimos 0 por env√≠o gratis
  }

  function pagoOkCond(){
    const metodo = paySel.value;
    if (metodo === 'TRANSFERENCIA') {
      return !!chkTransfer && chkTransfer.checked === true;
    }
    return true;
  }

  function recomputeSubmitAllowed(){
    const ok = envioOkCond() && pagoOkCond();
    setSubmitEnabled(ok);
    if (paySel.value === 'TRANSFERENCIA' && !chkTransfer.checked) {
      transferWarn.classList.toggle('d-none', false);
    } else {
      transferWarn.classList.toggle('d-none', true);
    }
  }

  function updateFreeShipBanner(){
    if (!freeBanner) return;
    if (FREE_SHIP_THRESHOLD > 0) {
      if (subtotal >= FREE_SHIP_THRESHOLD) {
        freeBanner.className = 'alert alert-success py-2 px-3';
        freeBanner.textContent = 'üéâ ¬°Ten√©s env√≠o gratis en esta compra!';
        freeBanner.classList.remove('d-none');
      } else {
        const faltan = FREE_SHIP_THRESHOLD - subtotal;
        freeBanner.className = 'alert alert-info py-2 px-3';
        freeBanner.textContent = 'üöö Te faltan ' + fmtMoney(faltan) + ' para obtener env√≠o gratis.';
        freeBanner.classList.remove('d-none');
      }
    } else {
      freeBanner.classList.add('d-none');
    }
  }

  function recalc(){
    const isPickup = envioSel.value === '0';
    const rawEnvioCost = parseFloat(envioSel.value || '0') || 0;
    const qualifiesFree = (FREE_SHIP_THRESHOLD > 0 && subtotal >= FREE_SHIP_THRESHOLD);

    // Si es retiro, costo 0. Si es delivery y califica, costo 0. Sino, el costo calculado.
    const finalEnvioCost = isPickup ? 0 : (qualifiesFree ? 0 : rawEnvioCost);

    envioEl.textContent     = fmtMoney(finalEnvioCost);
    envioInline.textContent = fmtMoney(finalEnvioCost);
    totalEl.textContent     = fmtMoney(subtotal + finalEnvioCost);
    subEl.textContent       = fmtMoney(subtotal);

    modoHidden.value = isPickup ? 'pickup' : 'delivery';
    if (isPickup) hideAddr();

    updateFreeShipBanner();
    recomputeSubmitAllowed();
  }
  envioSel.addEventListener('change', recalc);

  // Mostrar/ocultar bloque de transferencia
  function updatePayUI(){
    const metodo = paySel.value;
    if (metodo === 'TRANSFERENCIA') {
      transferBox.classList.remove('d-none');
    } else {
      transferBox.classList.add('d-none');
      chkTransfer && (chkTransfer.checked = false);
      transferHidden.value = '0';
    }
    recomputeSubmitAllowed();
  }
  paySel.addEventListener('change', updatePayUI);
  if (chkTransfer) {
    chkTransfer.addEventListener('change', ()=>{
      transferHidden.value = chkTransfer.checked ? '1' : '0';
      recomputeSubmitAllowed();
    });
  }

  // Opci√≥n autom√°tica: SOLO mostrar los km (sin ‚ÄúAuto‚Äù)
  function setAutoOption(costo, km){
    let opt = document.getElementById('opt-auto-envio');
    const label = `‚âà ${Number(km||0).toFixed(2)} km`;
    if(!opt){
      opt = document.createElement('option');
      opt.id = 'opt-auto-envio';
      envioSel.appendChild(opt);
    }
    opt.value = String(Number(costo).toFixed(2));
    opt.textContent = label;
    envioSel.value = opt.value;
    recalc();
  }
  function removeAutoOption(){
    const opt = document.getElementById('opt-auto-envio');
    if(opt) opt.remove();
    if (envioSel.value !== '0') envioSel.value = '0';
    hideAddr();
    recalc();
  }

  async function getJSON(url){
    const r = await fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  // --------- MAPA ----------
  let map, marker, circle, mapReady = false;
  const DEFAULT_CENTER = [STORE.lat, STORE.lng];

  const elMapModal  = document.getElementById('mapModal');
  const elMapCoords = document.getElementById('map-coords');
  const elMapStatus = document.getElementById('map-status');
  const elMapOutside= document.getElementById('map-outside');
  const btnMapUse   = document.getElementById('map-use');

  function haversineKm(a, b){
    const R = 6371e3; const toRad = x => x*Math.PI/180;
    const dLat = toRad(b.lat - a.lat), dLng = toRad(b.lng - a.lng);
    const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
    const A = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
    const c = 2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
    return (R*c)/1000.0;
  }
  function withinRadius(p){
    if(!SERVICE_RADIUS_M) return true;
    const km = haversineKm({lat:STORE.lat,lng:STORE.lng}, {lat:p.lat,lng:p.lng});
    const outside = (km*1000) > SERVICE_RADIUS_M;
    elMapOutside.style.display = outside ? '' : 'none';
    return !outside;
  }

  function ensureMap(){
    if(mapReady){ setTimeout(()=>map.invalidateSize(), 250); return; }

    map = L.map('map').setView(DEFAULT_CENTER, 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    marker = L.marker(DEFAULT_CENTER, {draggable:true}).addTo(map);
    if(SERVICE_RADIUS_M){
      circle = L.circle([STORE.lat, STORE.lng], {radius: SERVICE_RADIUS_M}).addTo(map);
    }

    function updateUI(latlng){
      elMapCoords.textContent = `Lat: ${latlng.lat.toFixed(6)}  Lng: ${latlng.lng.toFixed(6)}`;
      btnMapUse.disabled = !withinRadius(latlng);
    }
    updateUI(marker.getLatLng());

    const debounced = debounce(async (latlng)=>{
      try{
        elMapStatus.textContent = 'Calculando costo...';
        const q = `${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`;
        const data = await getJSON(`/api/costo-envio/?direccion=${q}`);
        if(data && data.ok){
          setAutoOption(Number(data.costo_envio||0), Number(data.distancia_km||0));
          localStorage.setItem(LS_COST, String(Number(data.costo_envio||0).toFixed(2)));
          localStorage.setItem(LS_KM,   String(Number(data.distancia_km||0).toFixed(3)));
          elMapStatus.textContent = `Distancia ‚âà ${Number(data.distancia_km||0).toFixed(2)} km`;
          showAddr(data, q);
        }else{
          elMapStatus.textContent = 'No se pudo calcular. Prob√° mover el pin.';
          hideAddr();
        }
      }catch(e){
        elMapStatus.textContent = 'Error al calcular. Reintent√°.';
        hideAddr();
      }
    }, 500);

    marker.on('drag', (e)=>{
      const p = e.target.getLatLng();
      updateUI(p);
      debounced(p);
    });

    if(navigator.geolocation){
      elMapStatus.textContent = 'Buscando tu ubicaci√≥n...';
      navigator.geolocation.getCurrentPosition((pos)=>{
        const here = {lat:pos.coords.latitude, lng:pos.coords.longitude};
        map.setView(here, 16);
        marker.setLatLng(here);
        updateUI(here);
        setTimeout(()=>map.invalidateSize(), 250);
        elMapStatus.textContent = 'Arrastr√° el pin para ajustar.';
        debounced(here);
      }, ()=>{
        elMapStatus.textContent = 'No pudimos obtener tu ubicaci√≥n.';
      }, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    }

    mapReady = true;
    setTimeout(()=>map.invalidateSize(), 250);
  }

  function debounce(fn, wait){
    let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); };
  }

  // Abrir mapa
  btnMap.addEventListener('click', ()=>{
    const modal = new bootstrap.Modal(elMapModal);
    modal.show();
    ensureMap();
  });

  // Confirmar punto
  document.getElementById('map-use').addEventListener('click', async ()=>{
    const p = marker.getLatLng();
    const lat = p.lat.toFixed(6), lng = p.lng.toFixed(6);
    const latlng = `${lat},${lng}`;

    geoHidden.value = latlng;
    localStorage.setItem(LS_GEO, latlng);

    try{
      const data = await getJSON(`/api/costo-envio/?direccion=${latlng}`);
      if(data && data.ok){
        setAutoOption(Number(data.costo_envio||0), Number(data.distancia_km||0));
        localStorage.setItem(LS_COST, String(Number(data.costo_envio||0).toFixed(2)));
        localStorage.setItem(LS_KM,   String(Number(data.distancia_km||0).toFixed(3)));
        showAddr(data, latlng);
      }else{
        removeAutoOption();
      }
    }catch(e){ removeAutoOption(); }

    const modal = bootstrap.Modal.getInstance(elMapModal);
    if(modal) modal.hide();
    recalc();
  });

  // Submit: validar env√≠o y transferencia (si aplica)
  form.addEventListener('submit', (e)=>{
    if (!envioOkCond()) {
      e.preventDefault();
      submitWarn.style.display = '';
      const modal = new bootstrap.Modal(document.getElementById('mapModal'));
      modal.show();
      ensureMap();
      return;
    }
    if (paySel.value === 'TRANSFERENCIA' && !chkTransfer.checked) {
      e.preventDefault();
      transferWarn.classList.remove('d-none');
      return;
    }
  });

  // Restaurar estado
  async function restore(){
    const saved = localStorage.getItem(LS_GEO);
    if(saved){
      geoHidden.value = saved;

      const savedCost = localStorage.getItem(LS_COST);
      const savedKm   = localStorage.getItem(LS_KM);
      if(savedCost){ setAutoOption(Number(savedCost), Number(savedKm||0)); }

      try{
        const data = await getJSON(`/api/costo-envio/?direccion=${saved}`);
        if(data && data.ok){
          setAutoOption(Number(data.costo_envio||0), Number(data.distancia_km||0));
          localStorage.setItem(LS_COST, String(Number(data.costo_envio||0).toFixed(2)));
          localStorage.setItem(LS_KM,   String(Number(data.distancia_km||0).toFixed(3)));
          showAddr(data, saved);
        }
      }catch(e){}
    }
    // inicializar UI de pago y banner
    updatePayUI();
    updateFreeShipBanner();
    recalc();
  }
  restore();
})();
</script>

<style>
  h2{ letter-spacing:.2px; }
  .card{ border-radius:14px; }
  .card-body{ padding:1rem 1.1rem; }

  .cart-item .thumb-wrap{ width:84px; flex:0 0 84px; }
  .cart-item .thumb{ width:84px;height:84px;object-fit:cover;border-radius:12px;background:#f2f2f2; }
  .thumb-placeholder{
    display:flex;align-items:center;justify-content:center;color:#999;
    background:#f3f6fa;border:1px dashed #c9d4e5;border-radius:12px;
    width:84px;height:84px;font-size:.8rem;
  }

  .envio-select{ max-width: 220px; }
  @media (max-width: 400px){ .envio-select{ max-width: 180px; } }

  #btn-map{ padding:.35rem .6rem;font-weight:600; }

  /* L√≠nea de direcci√≥n compacta (sin link/coords) */
  .addr{ margin:.35rem 0 .25rem; }
  .addr-text{ max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>

{% endblock %}
