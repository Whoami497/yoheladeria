{% load static %}
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Ticket #{{ pedido.id }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Estilos optimizados para térmica 58mm -->
<style>
  @page { size: 58mm auto; margin: 0 }
  @media print { html, body { width: 58mm } }
  html, body {
    width: 58mm; margin: 0; padding: 0 2mm;
    font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    font-size: 12.5px; line-height: 1.25; color: #000;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .h1 { text-align:center; font-weight: 800; margin: 2mm 0 0.5mm }
  .muted { color:#000 } /* sin grises para más contraste */
  .line { display:flex; justify-content:space-between; gap:4mm }
  .cut { border-top:1px dashed #000; margin: 2mm 0 }
  .small { font-size: 11px }
  .btns { display: none }        /* ocultar botones al imprimir */
  @media screen { .btns { display:block; margin-top:6mm } }
  a { color:#000; text-decoration:none }
</style>

<!-- QZ Tray opcional: si no está, se ignora -->
<script src="{% static 'qz-tray/qz-tray.js' %}" defer></script>
</head>
<body>
  <div class="h1"><strong>YO HELADERÍAS</strong></div>
  <div class="small" style="text-align:center">PEDIDO A COCINA</div>
  <div class="small" style="text-align:center">#{{ pedido.id }} · {{ pedido.fecha_pedido|date:"d/m H:i" }}</div>

  <div class="cut"></div>

  <div class="small"><strong>Cliente:</strong> {{ pedido.cliente_nombre|default:"—" }}</div>
  <div class="small"><strong>Entrega:</strong> {{ direccion_legible|default:"Retiro en local" }}</div>
  <div class="small"><strong>Tel:</strong> {{ pedido.cliente_telefono|default:"—" }}</div>
  <div class="small"><strong>Pago:</strong> {{ pedido.metodo_pago|default:"—" }}</div>

  <div class="cut"></div>

  <div class="small"><strong>Items</strong></div>
  <div style="margin-top:2mm">
    {% for d in detalles %}
      <div class="line">
        <span>{{ d.cantidad }} x {{ d.producto_nombre }}{% if d.opcion_nombre %} ({{ d.opcion_nombre }}){% endif %}</span>
      </div>
      {% if d.sabores_nombres %}
        <div class="small">• Sabores: {{ d.sabores_nombres|join:", " }}</div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="cut"></div>

  <div class="line">
    <strong>TOTAL</strong>
    <strong>${{ total }}</strong>
  </div>

  <div style="text-align:center; margin-top:2mm">¡Gracias!</div>

  <div class="btns" style="text-align:center">
    <button onclick="printTicket()" style="margin-right:6mm">Imprimir</button>
    <button onclick="window.close()">Cerrar</button>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const AUTO  = /^(1|true)$/i.test(params.get('auto') || '');
  const USE_QZ= /^(1|true)$/i.test(params.get('qz')   || '');
  const CLOSE = /^(1|true)$/i.test(params.get('close')|| '');

  // imprime con QZ si está disponible; si no, usa window.print()
  async function printViaQZ(){
    if(!USE_QZ || typeof qz === 'undefined') return false;
    try{
      if(!qz.websocket.isActive()) await qz.websocket.connect();

      // impresora predeterminada
      const printer = await qz.printers.getDefault();
      const cfg = qz.configs.create(printer, { rasterize: false, encoding: 'CP437' });

      // Texto simple (se arma desde el DOM)
      function textFromDom(){
        const sections = [];
        function line(s=''){ sections.push(s + '\n'); }
        line('================================');
        line('YO HELADERÍAS'.padStart(18 + 6)); // centrado aproximado
        line('PEDIDO A COCINA'.padStart(20 + 2));
        line('#{{ pedido.id }}  {{ pedido.fecha_pedido|date:"d/m H:i" }}'.padStart(20 + 6));
        line('================================');
        line('');
        line('Cliente : {{ pedido.cliente_nombre|default:"-" }}');
        line('Entrega : {{ direccion_legible|default:"Retiro en local" }}');
        line('Tel     : {{ pedido.cliente_telefono|default:"-" }}');
        line('Pago    : {{ pedido.metodo_pago|default:"-" }}');
        line('------------------------------');
        {% for d in detalles %}
          line('{{ d.cantidad }} x {{ d.producto_nombre|escapejs }}{% if d.opcion_nombre %} ({{ d.opcion_nombre|escapejs }}){% endif %}');
          {% if d.sabores_nombres %}
            line('  Sabores: {{ d.sabores_nombres|join:", "|escapejs }}');
          {% endif %}
        {% endfor %}
        line('------------------------------');
        line('TOTAL:   ${{ total }}');
        line('');
        line('¡Gracias!');
        line('\n');
        return sections.join('');
      }

      const cmds = [
        '\x1B\x40',                 // init
        { type: 'raw', format: 'command', data: textFromDom() },
        '\x1D\x56\x01'              // corte parcial
      ];

      await qz.print(cfg, cmds.map(c => (typeof c === 'string') ? { type:'raw', format:'command', data:c } : c));
      return true;
    }catch(e){
      // si algo falla, fallback
      try{ if(qz.websocket.isActive()) await qz.websocket.disconnect(); }catch(_){}
      return false;
    }
  }

  window.printTicket = async function(){
    const okQZ = await printViaQZ();
    if(!okQZ){
      window.print();
    }
  };

  // auto-print
  if(AUTO){
    // afterprint → cerrar si se pidió
    function tryClose(){ if(CLOSE) { setTimeout(()=>{ try{ window.close(); }catch(_){ } }, 150); } }
    window.addEventListener('afterprint', tryClose);
    // fallback por si el evento no dispara (algunas versiones)
    setTimeout(tryClose, 2500);

    // dispara
    printTicket();
  }
})();
</script>
</body>
</html>
