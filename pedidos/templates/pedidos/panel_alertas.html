{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h2 class="section-title text-center mb-1">Panel de Alertas de Pedidos</h2>
  <p class="text-center text-muted mb-4">Llegan en tiempo real y quedan visibles aun si recargÃ¡s la pÃ¡gina.</p>
  <hr>

  <!-- ===== HOY (ACTIVOS) ===== -->
  <h5 class="mb-3">Pedidos de <span class="fw-bold">HOY</span> (activos)</h5>
  <div id="alerts-hoy">
    {% if pedidos_hoy %}
      {% for p in pedidos_hoy %}
        <div class="order-card alert alert-primary alert-dismissible fade show mb-3 p-3" id="order-{{ p.id }}" data-order-id="{{ p.id }}">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <h6 class="mb-0">#{{ p.id }}</h6>
                <span class="badge bg-status-{{ p.estado|lower }}">{{ p.estado }}</span>
                <small class="text-muted">Total: ${{ p.total_pedido|default_if_none:"0.00" }}</small>
              </div>

              <div class="small text-muted mb-1">
                Cliente: <span class="fw-semibold">{{ p.cliente_nombre|default:"N/A" }}</span>
                Â· {{ p.cliente_telefono|default:"â€”" }} Â· {{ p.cliente_direccion|default:"â€”" }}
              </div>
              <div class="small">
                Cadete:
                <span class="fw-semibold">
                  {% if p.cadete_asignado %}
                    {{ p.cadete_asignado.user.get_full_name|default:p.cadete_asignado.user.username }}
                  {% else %}â€”{% endif %}
                </span>
              </div>

              <details class="mt-2">
                <summary class="cursor-pointer">Ver productos</summary>
                <ul class="mb-0 small mt-2">
                  {% for d in p.detalles.all %}
                    <li>
                      {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                      <br><span class="text-muted">Sabores:
                        {% with sab=d.sabores.all %}{% if sab %}{{ sab|join:", " }}{% else %}Sin especificar{% endif %}{% endwith %}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            </div>

            <div class="text-end min-btn-col">
              {% if p.estado == 'RECIBIDO' %}
                <button class="btn btn-success fw-bold btn-confirm"
                        data-confirm-url="{% url 'confirmar_pedido' p.id %}"
                        data-order-id="{{ p.id }}">
                  <i class="bi bi-check-circle-fill"></i> Confirmar
                </button>
                <div class="text-muted small mt-1">Notifica a cadetes</div>
              {% else %}
                <div class="dropdown">
                  <button class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">
                    Estado
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item btn-set-state" data-state="EN_PREPARACION" data-url="{% url 'panel_alertas_set_estado' p.id %}">En preparaciÃ³n</button></li>
                    <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Asignado</button></li>
                    <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="{% url 'panel_alertas_set_estado' p.id %}">En camino</button></li>
                    <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Entregado</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Cancelar</button></li>
                  </ul>
                </div>
              {% endif %}
            </div>
          </div>

          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info text-center" role="alert">No hay pedidos activos de hoy.</div>
    {% endif %}
  </div>

  <!-- ===== HOY â€” FINALIZADOS (ENTREGADO/CANCELADO) ===== -->
  <details class="mt-4" open>
    <summary class="h6">Pedidos de HOY â€” Finalizados</summary>
    <div id="alerts-hoy-finalizados" class="mt-3">
      {% if entregados_hoy %}
        {% for p in entregados_hoy %}
          <div class="order-chip d-flex align-items-center justify-content-between" id="chip-hoy-{{ p.id }}" data-order-id="{{ p.id }}">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="chip-id">#{{ p.id }}</span>
              <span class="badge bg-status-{{ p.estado|lower }}">{{ p.estado }}</span>
              <span class="text-muted small">$ {{ p.total_pedido|default_if_none:"0.00" }}</span>
              <span class="small text-truncate chip-client">{{ p.cliente_nombre|default:"N/A" }}</span>
              <span class="small text-muted">
                Â· Cadete:
                {% if p.cadete_asignado %}
                  {{ p.cadete_asignado.user.get_full_name|default:p.cadete_asignado.user.username }}
                {% else %}â€”{% endif %}
              </span>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">Estado</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item btn-set-state" data-state="EN_PREPARACION" data-url="{% url 'panel_alertas_set_estado' p.id %}">En preparaciÃ³n</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Asignado</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="{% url 'panel_alertas_set_estado' p.id %}">En camino</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Entregado</button></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Cancelar</button></li>
              </ul>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-light border text-center">Sin pedidos finalizados de hoy.</div>
      {% endif %}
    </div>
  </details>

  <!-- ===== AYER ===== -->
  <details class="mt-4">
    <summary class="h6">Pedidos de AYER</summary>
    <div id="alerts-ayer" class="mt-3">
      {% if pedidos_ayer %}
        {% for p in pedidos_ayer %}
          <div class="order-chip d-flex align-items-center justify-content-between" id="chip-{{ p.id }}" data-order-id="{{ p.id }}">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="chip-id">#{{ p.id }}</span>
              <span class="badge bg-status-{{ p.estado|lower }}">{{ p.estado }}</span>
              <span class="text-muted small">$ {{ p.total_pedido|default_if_none:"0.00" }}</span>
              <span class="small text-truncate chip-client">{{ p.cliente_nombre|default:"N/A" }}</span>
              <span class="small text-muted">
                Â· Cadete:
                {% if p.cadete_asignado %}
                  {{ p.cadete_asignado.user.get_full_name|default:p.cadete_asignado.user.username }}
                {% else %}â€”{% endif %}
              </span>
            </div>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">Estado</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item btn-set-state" data-state="EN_PREPARACION" data-url="{% url 'panel_alertas_set_estado' p.id %}">En preparaciÃ³n</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Asignado</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="{% url 'panel_alertas_set_estado' p.id %}">En camino</button></li>
                <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Entregado</button></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="{% url 'panel_alertas_set_estado' p.id %}">Cancelar</button></li>
              </ul>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-light border text-center">Sin pedidos de ayer.</div>
      {% endif %}
    </div>
  </details>

  <div class="text-center mt-4">
    <a href="{% url 'panel_alertas_anteriores' %}" class="btn btn-link">Ver pedidos anteriores</a>
  </div>

  <!-- controles -->
  <div class="text-center mt-4 d-flex gap-2 justify-content-center flex-wrap">
    <span id="ws-status" class="badge bg-secondary align-self-center">Conectandoâ€¦</span>
    <button id="toggle-sound" class="btn btn-outline-primary">ðŸ”” Sonido: ON</button>
    <button id="clear-alerts" class="btn btn-secondary">Limpiar Pedidos Mostrados</button>
  </div>
</div>

<script>
  // ===== CSRF =====
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Sonido (archivo) =====
  const orderSoundUrl = "{% static 'pedidos/sounds/new-order.mp3' %}";
  let soundEnabled=(localStorage.getItem('panel_sound') ?? 'on')!=='off';
  const toggleSoundBtn=document.getElementById('toggle-sound');
  function updateSoundBtn(){
    toggleSoundBtn.textContent=soundEnabled?'ðŸ”” Sonido: ON':'ðŸ”• Sonido: OFF';
    toggleSoundBtn.classList.toggle('btn-outline-primary', soundEnabled);
    toggleSoundBtn.classList.toggle('btn-outline-secondary', !soundEnabled);
  }
  function playSound(){ if(!soundEnabled) return; try{const a=new Audio(orderSoundUrl); a.play().catch(()=>{});}catch(e){} }
  toggleSoundBtn.addEventListener('click',()=>{soundEnabled=!soundEnabled;localStorage.setItem('panel_sound',soundEnabled?'on':'off');updateSoundBtn(); if(soundEnabled) playSound();});
  updateSoundBtn();

  // ===== Helpers =====
  const alertsHoy=document.getElementById('alerts-hoy');
  const alertsHoyFinalizados=document.getElementById('alerts-hoy-finalizados');
  const alertsAyer=document.getElementById('alerts-ayer');
  const wsStatus=document.getElementById('ws-status');

  function badgeClass(estado){return `bg-status-${(estado||'').toLowerCase()}`}
  function orderExists(id){
    return document.getElementById(`order-${id}`) || document.getElementById(`chip-${id}`) || document.getElementById(`chip-hoy-${id}`);
  }

  // Construye tarjeta (HOY activos)
  function buildCard(order){
    const wrapper=document.createElement('div');
    wrapper.className='order-card alert alert-primary alert-dismissible fade show mb-3 p-3';
    wrapper.id=`order-${order.id}`;
    wrapper.dataset.orderId=order.id;

    const cadeteTxt = order.cadete || 'â€”';
    const total = parseFloat(order.total_pedido||0).toFixed(2);
    const estado = order.estado||'RECIBIDO';

    const detailsHtml = (order.detalles||[]).map(d=>{
      const name=d.opcion_nombre ? `${d.producto_nombre} - ${d.opcion_nombre}` : d.producto_nombre;
      const sabores=(d.sabores_nombres && d.sabores_nombres.length)? d.sabores_nombres.join(', ') : 'Sin especificar';
      return `<li>${name} (x${d.cantidad})<br><span class="text-muted">Sabores: ${sabores}</span></li>`;
    }).join('');

    const rightControls = estado==='RECIBIDO'
      ? `<button class="btn btn-success fw-bold btn-confirm"
                 data-confirm-url="/confirmar-pedido/${order.id}/"
                 data-order-id="${order.id}">
           <i class="bi bi-check-circle-fill"></i> Confirmar
         </button>
         <div class="text-muted small mt-1">Notifica a cadetes</div>`
      : `<div class="dropdown">
           <button class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">Estado</button>
           <ul class="dropdown-menu dropdown-menu-end">
             <li><button class="dropdown-item btn-set-state" data-state="EN_PREPARACION" data-url="/panel-alertas/estado/${order.id}/">En preparaciÃ³n</button></li>
             <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="/panel-alertas/estado/${order.id}/">Asignado</button></li>
             <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="/panel-alertas/estado/${order.id}/">En camino</button></li>
             <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="/panel-alertas/estado/${order.id}/">Entregado</button></li>
             <li><hr class="dropdown-divider"></li>
             <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="/panel-alertas/estado/${order.id}/">Cancelar</button></li>
           </ul>
         </div>`;

    wrapper.innerHTML = `
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-1">
            <h6 class="mb-0">#${order.id}</h6>
            <span class="badge ${badgeClass(estado)}">${estado}</span>
            <small class="text-muted">Total: $${total}</small>
          </div>
          <div class="small text-muted mb-1">
            Cliente: <span class="fw-semibold">${order.cliente_nombre||'N/A'}</span>
            Â· ${order.cliente_telefono||'â€”'} Â· ${order.cliente_direccion||'â€”'}
          </div>
          <div class="small">Cadete: <span class="fw-semibold">${cadeteTxt}</span></div>
          <details class="mt-2"><summary>Ver productos</summary><ul class="mb-0 small mt-2">${detailsHtml}</ul></details>
        </div>
        <div class="text-end min-btn-col">
          ${rightControls}
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    return wrapper;
  }

  // Construye chip (finalizados HOY o AYER)
  function buildChip(order, inTodayFinalizados=false){
    const chip=document.createElement('div');
    chip.className='order-chip d-flex align-items-center justify-content-between';
    chip.id= inTodayFinalizados ? `chip-hoy-${order.id}` : `chip-${order.id}`;
    chip.dataset.orderId=order.id;
    chip.innerHTML=`
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="chip-id">#${order.id}</span>
        <span class="badge ${badgeClass(order.estado)}">${order.estado}</span>
        <span class="text-muted small">$${parseFloat(order.total_pedido||0).toFixed(2)}</span>
        <span class="small text-truncate chip-client">${order.cliente_nombre||'N/A'}</span>
        <span class="small text-muted">Â· Cadete: ${order.cadete||'â€”'}</span>
      </div>
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">Estado</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item btn-set-state" data-state="EN_PREPARACION" data-url="/panel-alertas/estado/${order.id}/">En preparaciÃ³n</button></li>
          <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="/panel-alertas/estado/${order.id}/">Asignado</button></li>
          <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="/panel-alertas/estado/${order.id}/">En camino</button></li>
          <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="/panel-alertas/estado/${order.id}/">Entregado</button></li>
          <li><hr class="dropdown-divider"></li>
          <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="/panel-alertas/estado/${order.id}/">Cancelar</button></li>
        </ul>
      </div>
    `;
    return chip;
  }

  // DelegaciÃ³n: confirmar pedido (AJAX)
  document.addEventListener('click', async (ev)=>{
    const btn=ev.target.closest('.btn-confirm'); if(!btn) return;
    ev.preventDefault();
    const url=btn.dataset.confirmUrl;
    const card=btn.closest('.order-card');
    btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Confirmando...';
    try{
      const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        const badge=card.querySelector('.badge'); badge.className='badge '+badgeClass('EN_PREPARACION'); badge.textContent='EN_PREPARACION';
        btn.parentElement.innerHTML = `
          <div class="dropdown">
            <button class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">Estado</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><button class="dropdown-item btn-set-state" data-state="ASIGNADO" data-url="${url.replace('/confirmar-pedido','/panel-alertas/estado')}">Asignado</button></li>
              <li><button class="dropdown-item btn-set-state" data-state="EN_CAMINO" data-url="${url.replace('/confirmar-pedido','/panel-alertas/estado')}">En camino</button></li>
              <li><button class="dropdown-item btn-set-state" data-state="ENTREGADO" data-url="${url.replace('/confirmar-pedido','/panel-alertas/estado')}">Entregado</button></li>
              <li><hr class="dropdown-divider"></li>
              <li><button class="dropdown-item text-danger btn-set-state" data-state="CANCELADO" data-url="${url.replace('/confirmar-pedido','/panel-alertas/estado')}">Cancelar</button></li>
            </ul>
          </div>`;
      }else{
        window.location.href=url;
      }
    }catch(e){ window.location.href=url; }
  });

  // DelegaciÃ³n: cambio de estado (AJAX)
  document.addEventListener('click', async (ev)=>{
    const item=ev.target.closest('.btn-set-state'); if(!item) return;
    const url=item.dataset.url, estado=item.dataset.state;
    const root = ev.target.closest('.order-card, .order-chip');
    try{
      const res=await fetch(url,{
        method:'POST',
        headers:{
          'X-CSRFToken':csrftoken,
          'X-Requested-With':'XMLHttpRequest',
          'Content-Type':'application/x-www-form-urlencoded'
        },
        body:`estado=${encodeURIComponent(estado)}`
      });
      const data = await res.json();
      if(data.ok){
        // actualizar badge visual
        const badge = root.querySelector('.badge');
        if(badge){ badge.className='badge '+badgeClass(estado); badge.textContent=estado; }

        // si pasÃ³ a ENTREGADO o CANCELADO: mover de "HOY (activos)" a "HOY â€” Finalizados"
        if((estado==='ENTREGADO' || estado==='CANCELADO') && root.classList.contains('order-card')){
          const id = root.dataset.orderId;
          const total = root.querySelector('small.text-muted')?.textContent.replace('Total: $','') || '0.00';
          const cliente = root.querySelector('.small.text-muted .fw-semibold')?.textContent || 'N/A';
          const cadeteNode = root.querySelector('.small .fw-semibold');
          const cadete = (data.cadete) || (cadeteNode ? cadeteNode.textContent.trim() : 'â€”');

          const order = { id, estado, total_pedido: total, cliente_nombre: cliente, cadete };
          const chip = buildChip(order, true);
          // si habÃ­a mensaje de "vacÃ­o", lo removemos
          const empty = alertsHoyFinalizados.querySelector('.alert');
          if(empty) empty.remove();
          alertsHoyFinalizados.prepend(chip);

          root.remove();
          if(!alertsHoy.querySelector('.order-card')){
            alertsHoy.innerHTML='<div class="alert alert-info text-center" role="alert">No hay pedidos activos de hoy.</div>';
          }
        }
      }
    }catch(e){ console.error(e); }
  });

  // Limpiar
  document.getElementById('clear-alerts').addEventListener('click',()=>{
    alertsHoy.innerHTML='<div class="alert alert-info text-center" role="alert">No hay pedidos activos de hoy.</div>';
    alertsHoyFinalizados.innerHTML='<div class="alert alert-light border text-center">Sin pedidos finalizados de hoy.</div>';
    alertsAyer.innerHTML='';
  });

  // ===== WebSocket (nuevos pedidos) =====
  const wsProtocol=window.location.protocol==='https:'?'wss://':'ws://';
  const websocketUrl=wsProtocol + window.location.host + '/ws/pedidos/notifications/';
  const chatSocket=new WebSocket(websocketUrl);

  chatSocket.onopen=function(){ wsStatus.classList.remove('bg-secondary','bg-danger'); wsStatus.classList.add('bg-success'); wsStatus.textContent='Conectado'; };
  chatSocket.onclose=function(){ wsStatus.classList.remove('bg-success','bg-secondary'); wsStatus.classList.add('bg-danger'); wsStatus.textContent='Desconectado'; };
  chatSocket.onerror=function(){ wsStatus.classList.remove('bg-success','bg-secondary'); wsStatus.classList.add('bg-danger'); wsStatus.textContent='Error'; };

  chatSocket.onmessage=function(e){
    const data=JSON.parse(e.data);
    const orderId=data.order_id;
    const orderData=data.order_data||{};
    if(orderExists(orderId)) return;
    // Nuevos pedidos -> HOY (activos)
    orderData.id = orderId;
    const card=buildCard(orderData);
    alertsHoy.prepend(card);
    playSound();
  };
</script>

<style>
  .order-chip{
    border:1px solid var(--bs-primary);
    background:rgba(13,110,253,.08);
    border-radius:.75rem;
    padding:.5rem .75rem;
    margin-bottom:.6rem;
  }
  .chip-id{font-weight:700}
  .chip-client{max-width:260px}

  .order-card h6{font-size:1rem}
  .compact-line{font-size:.95rem}
  .min-btn-col{min-width:190px}

  .bg-status-recibido{background:#0d6efd !important}
  .bg-status-en_preparacion{background:#0dcaf0 !important}
  .bg-status-asignado{background:#6f42c1 !important}
  .bg-status-en_camino{background:#ffc107 !important; color:#212529 !important}
  .bg-status-entregado{background:#198754 !important}
  .bg-status-cancelado{background:#dc3545 !important}
</style>
{% endblock %}
