{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h2 class="section-title text-center mb-4">Panel de Alertas de Pedidos</h2>
  <p class="text-center text-muted">Llegan en tiempo real y quedan visibles aun si recargÃ¡s la pÃ¡gina.</p>
  <hr>

  <div id="alerts-container" class="mt-4">
    {% if pedidos_iniciales %}
      {% for p in pedidos_iniciales %}
        <div
          class="order-card alert alert-primary alert-dismissible fade show mb-3 p-3"
          id="order-{{ p.id }}"
          data-order-id="{{ p.id }}"
          data-estado="{{ p.estado }}">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <h5 class="mb-0">#{{ p.id }}</h5>
                <span class="badge bg-status-{{ p.estado|lower }}">{{ p.estado }}</span>
                <small class="text-muted">Total: ${{ p.total_pedido|default_if_none:"0.00" }}</small>
              </div>
              <div class="compact-line">
                <span class="fw-semibold">{{ p.cliente_nombre|default:"N/A" }}</span>
                <span class="text-muted">Â· {{ p.cliente_telefono|default:"â€”" }}</span>
                <span class="text-muted">Â· {{ p.cliente_direccion|default:"â€”" }}</span>
              </div>

              <details class="mt-2">
                <summary class="cursor-pointer">Ver productos</summary>
                <ul class="mb-0 small mt-2">
                  {% for d in p.detalles.all %}
                    <li>
                      {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                      <br><span class="text-muted">
                        Sabores:
                        {% with sab=d.sabores.all %}{% if sab %}{{ sab|join:", " }}{% else %}Sin especificar{% endif %}{% endwith %}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            </div>

            <div class="text-end min-btn-col">
              {% if p.estado == 'RECIBIDO' %}
              <button
                class="btn btn-success fw-bold btn-confirm"
                data-confirm-url="{% url 'confirmar_pedido' p.id %}"
                data-order-id="{{ p.id }}">
                <i class="bi bi-check-circle-fill"></i> Confirmar
              </button>
              {% else %}
              <button class="btn btn-outline-secondary" disabled>Confirmado</button>
              {% endif %}
            </div>
          </div>

          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info text-center placeholder" role="alert">
        Esperando nuevos pedidos...
      </div>
    {% endif %}
  </div>

  <div class="text-center mt-4 d-flex gap-2 justify-content-center flex-wrap">
    <span id="ws-status" class="badge bg-secondary align-self-center">Conectandoâ€¦</span>
    <button id="toggle-sound" class="btn btn-outline-primary">ðŸ”” Sonido: ON</button>
    <button id="clear-alerts" class="btn btn-secondary">Limpiar Pedidos Mostrados</button>
  </div>
</div>

<script>
  // ====== CSRF ======
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ====== Sonido ======
  let audioCtx=null;
  let soundEnabled=(localStorage.getItem('panel_sound') ?? 'on')!=='off';
  function ensureAudio(){try{if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext;if(!AC) return;audioCtx=new AC();}if(audioCtx.state==='suspended'){audioCtx.resume();}}catch(e){}}
  function playDing(){ if(!soundEnabled) return; ensureAudio(); if(!audioCtx) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(880,audioCtx.currentTime);
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.05,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.35);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.36);
    if(navigator.vibrate){navigator.vibrate([120,40,120]);}
  }
  function unlockOnFirstInteraction(){const once=()=>{ensureAudio();document.removeEventListener('click',once);document.removeEventListener('keydown',once);document.removeEventListener('touchstart',once);};document.addEventListener('click',once,{once:true});document.addEventListener('keydown',once,{once:true});document.addEventListener('touchstart',once,{once:true});}

  // ====== UI helpers ======
  const alertsContainer=document.getElementById('alerts-container');
  const wsStatus=document.getElementById('ws-status');
  const toggleSoundBtn=document.getElementById('toggle-sound');
  const clearAlertsButton=document.getElementById('clear-alerts');

  function updateSoundBtn(){
    toggleSoundBtn.textContent = soundEnabled ? 'ðŸ”” Sonido: ON' : 'ðŸ”• Sonido: OFF';
    toggleSoundBtn.classList.toggle('btn-outline-primary', soundEnabled);
    toggleSoundBtn.classList.toggle('btn-outline-secondary', !soundEnabled);
  }
  toggleSoundBtn.addEventListener('click',()=>{soundEnabled=!soundEnabled;localStorage.setItem('panel_sound',soundEnabled?'on':'off');updateSoundBtn();ensureAudio(); if(soundEnabled) playDing();});
  updateSoundBtn(); unlockOnFirstInteraction();

  function ensurePlaceholder(){
    const hasItems = alertsContainer.querySelector('.order-card, .order-chip');
    const ph = alertsContainer.querySelector('.placeholder');
    if(!hasItems && !ph){
      alertsContainer.insertAdjacentHTML('beforeend','<div class="alert alert-info text-center placeholder" role="alert">Esperando nuevos pedidos...</div>');
    }
    if(hasItems && ph){ ph.remove(); }
  }

  function orderExists(id){return document.getElementById(`order-${id}`) || document.getElementById(`chip-${id}`);}

  // ====== CHIP ======
  function chipBadgeClass(est){
    const e=(est||'RECIBIDO').toLowerCase();
    return `badge bg-status-${e}`;
  }
  function renderChip(order){
    const chip=document.createElement('div');
    chip.className='order-chip d-flex align-items-center justify-content-between';
    chip.id=`chip-${order.id}`;
    chip.dataset.orderId=order.id;
    chip.dataset.estado=order.estado || 'RECIBIDO';
    chip.innerHTML=`
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="chip-id">#${order.id}</span>
        <span class="${chipBadgeClass(order.estado)}">${order.estado || 'RECIBIDO'}</span>
        <span class="text-muted small">$${parseFloat(order.total_pedido||0).toFixed(2)}</span>
        <span class="small text-truncate chip-client" title="${order.cliente_nombre||''}">${order.cliente_nombre||'N/A'}</span>
      </div>
      <div class="chip-actions d-flex gap-1">
        <button class="btn btn-sm btn-outline-primary btn-estado" data-estado="EN_CAMINO">En camino</button>
        <button class="btn btn-sm btn-outline-success btn-estado" data-estado="ENTREGADO">Entregado</button>
        <button class="btn btn-sm btn-outline-danger btn-estado" data-estado="CANCELADO">Cancelar</button>
      </div>
    `;
    return chip;
  }

  function collapseToChip(cardEl, estadoNuevo){
    const id = cardEl.dataset.orderId;
    const totalTxt = cardEl.querySelector('.text-muted')?.textContent || 'Total: $0';
    const total = (totalTxt.match(/(\d+(?:[\.,]\d+)?)/)||[])[1]?.replace(',','.') || '0';
    const name = cardEl.querySelector('.compact-line .fw-semibold')?.textContent || '';
    const estado = estadoNuevo || cardEl.dataset.estado || 'RECIBIDO';
    const chip = renderChip({id, estado, total_pedido: total, cliente_nombre: name});
    cardEl.remove();
    alertsContainer.prepend(chip);
    ensurePlaceholder();
  }

  // ====== Tarjeta (para nuevos pedidos) ======
  function buildOrderCardFromWS(orderId, orderData){
    if(orderExists(orderId)) return;

    const estado = orderData.estado || 'RECIBIDO';
    if(estado !== 'RECIBIDO'){
      // si llega con otro estado, lo mostramos directo como chip
      alertsContainer.prepend(renderChip({
        id: orderId,
        estado,
        total_pedido: orderData.total_pedido,
        cliente_nombre: orderData.cliente_nombre
      }));
      ensurePlaceholder();
      return;
    }

    const wrapper=document.createElement('div');
    wrapper.className='order-card alert alert-primary alert-dismissible fade show mb-3 p-3';
    wrapper.id=`order-${orderId}`;
    wrapper.dataset.orderId=orderId;
    wrapper.dataset.estado=estado;

    const total  = parseFloat(orderData.total_pedido||0).toFixed(2);
    let detailsHtml='';
    if(orderData.detalles && orderData.detalles.length){
      detailsHtml = `<ul class="mb-0 small mt-2">` + orderData.detalles.map(d=>{
        const name = d.opcion_nombre ? `${d.producto_nombre} - ${d.opcion_nombre}` : d.producto_nombre;
        const sabores = (d.sabores_nombres && d.sabores_nombres.length) ? d.sabores_nombres.join(', ') : 'Sin especificar';
        return `<li>${name} (x${d.cantidad})<br><span class="text-muted">Sabores: ${sabores}</span></li>`;
      }).join('') + `</ul>`;
    } else {
      detailsHtml = `<div class="small text-muted">Sin productos</div>`;
    }

    const confirmBtn = `
      <button class="btn btn-success fw-bold btn-confirm"
              data-confirm-url="/confirmar-pedido/${orderId}/"
              data-order-id="${orderId}">
        <i class="bi bi-check-circle-fill"></i> Confirmar
      </button>`;

    wrapper.innerHTML=`
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-2">
            <h5 class="mb-0">#${orderId}</h5>
            <span class="${chipBadgeClass(estado)}">${estado}</span>
            <small class="text-muted">Total: $${total}</small>
          </div>
          <div class="compact-line">
            <span class="fw-semibold">${orderData.cliente_nombre || 'N/A'}</span>
            <span class="text-muted">Â· ${orderData.cliente_telefono || 'â€”'}</span>
            <span class="text-muted">Â· ${orderData.cliente_direccion || 'â€”'}</span>
          </div>
          <details class="mt-2"><summary>Ver productos</summary>${detailsHtml}</details>
        </div>
        <div class="text-end min-btn-col">
          ${confirmBtn}
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alertsContainer.prepend(wrapper);
    ensurePlaceholder();
  }

  // ====== Delegaciones ======
  // Confirmar -> colapsar a chip
  alertsContainer.addEventListener('click', async (ev)=>{
    const btn=ev.target.closest('.btn-confirm'); if(!btn) return;
    ev.preventDefault();
    const url=btn.dataset.confirmUrl;
    const card=btn.closest('.order-card');
    btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Confirmando...';
    try{
      const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        collapseToChip(card,'EN_PREPARACION');
      }else{
        window.location.href=url;
      }
    }catch(e){
      console.error('Error confirmando:',e);
      window.location.href=url;
    }
  });

  // Cambiar estado desde un chip
  alertsContainer.addEventListener('click', async (ev)=>{
    const btn=ev.target.closest('.btn-estado'); if(!btn) return;
    const chip = btn.closest('.order-chip');
    const orderId = chip.dataset.orderId;
    const nuevo = btn.dataset.estado;

    btn.disabled = true;

    try{
      const res = await fetch(`/panel-alertas/estado/${orderId}/`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'},
        body: JSON.stringify({estado: nuevo})
      });
      const data = await res.json();
      if(!res.ok || !data.ok) throw new Error(data.error||'Error cambiando estado');

      // actualizar badge y dataset
      chip.dataset.estado = data.estado;
      const badge = chip.querySelector('.badge');
      badge.className = chipBadgeClass(data.estado);
      badge.textContent = data.estado;

      // si se marcÃ³ ENTREGADO o CANCELADO, lo sacamos del panel
      if(data.estado === 'ENTREGADO' || data.estado === 'CANCELADO'){
        chip.remove();
        ensurePlaceholder();
      }
    }catch(e){
      console.error(e);
      alert('No se pudo cambiar el estado.');
    }finally{
      btn.disabled = false;
    }
  });

  // Limpiar mostrados
  document.getElementById('clear-alerts').addEventListener('click',()=>{
    alertsContainer.innerHTML='<div class="alert alert-info text-center placeholder" role="alert">Esperando nuevos pedidos...</div>';
  });

  // ====== WebSocket ======
  const wsProtocol=window.location.protocol==='https:'?'wss://':'ws://';
  const websocketUrl=wsProtocol + window.location.host + '/ws/pedidos/notifications/';
  const chatSocket=new WebSocket(websocketUrl);

  chatSocket.onopen=function(){wsStatus.classList.remove('bg-secondary','bg-danger');wsStatus.classList.add('bg-success');wsStatus.textContent='Conectado';};
  chatSocket.onclose=function(){wsStatus.classList.remove('bg-success','bg-secondary');wsStatus.classList.add('bg-danger');wsStatus.textContent='Desconectado';};
  chatSocket.onerror=function(){wsStatus.classList.remove('bg-success','bg-secondary');wsStatus.classList.add('bg-danger');wsStatus.textContent='Error';};

  chatSocket.onmessage=function(e){
    const data=JSON.parse(e.data);
    const orderId=data.order_id;
    const orderData=data.order_data||{};
    buildOrderCardFromWS(orderId, orderData);
    playDing();
  };

  // ====== Al cargar: colapsar automÃ¡ticamente todo lo que NO estÃ© recibido ======
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.order-card').forEach(card=>{
      const est = (card.dataset.estado || '').toUpperCase();
      if(est && est !== 'RECIBIDO'){
        collapseToChip(card, est);
      }
    });
    ensurePlaceholder();
  });
</script>

<style>
  /* chips compactos */
  .order-chip{
    border:1px solid var(--bs-primary);
    background:rgba(13,110,253,.08);
    border-radius:.75rem;
    padding:.5rem .75rem;
    margin-bottom:.6rem;
  }
  .chip-id{font-weight:700}
  .chip-client{max-width:240px}
  .chip-actions .btn{padding:.15rem .5rem}

  /* tarjetas mÃ¡s compactas */
  .order-card h5{font-size:1.05rem}
  .compact-line{font-size:.95rem}
  .min-btn-col{min-width:180px}

  /* colores por estado */
  .bg-status-recibido{background:#0d6efd !important}
  .bg-status-en_preparacion{background:#0dcaf0 !important}
  .bg-status-asignado{background:#6f42c1 !important}
  .bg-status-en_camino{background:#ffc107 !important; color:#212529 !important}
  .bg-status-entregado{background:#198754 !important}
  .bg-status-cancelado{background:#dc3545 !important}
</style>
{% endblock %}
