{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h2 class="section-title text-center mb-4">Panel de Alertas de Pedidos</h2>
  <p class="text-center text-muted">Esta pantalla recibir√° notificaciones de nuevos pedidos en tiempo real.</p>
  <hr>

  <div id="alerts-container" class="mt-4">
    {% if pedidos_iniciales %}
      {% for p in pedidos_iniciales %}
        <div class="alert alert-primary alert-dismissible fade show new-order-alert order-card" role="alert" id="order-{{ p.id }}" data-order-id="{{ p.id }}">
          <h4 class="alert-heading">¬°Nuevo Pedido #{{ p.id }}!</h4>
          <p class="mb-1"><strong>Cliente:</strong> {{ p.cliente_nombre|default:"N/A" }}</p>
          <p class="mb-1"><strong>Direcci√≥n:</strong> {{ p.cliente_direccion|default:"N/A" }}</p>
          <p class="mb-1"><strong>Tel√©fono:</strong> {{ p.cliente_telefono|default:"N/A" }}</p>
          <p class="mb-1"><strong>Total:</strong> ${{ p.total_pedido|default_if_none:"0.00" }}</p>
          <p class="mb-1"><strong>M√©todo de Pago:</strong> {{ p.metodo_pago|default:"N/A" }}</p>
          <hr>
          {% with detalles=p.detalles.all %}
            {% if detalles %}
              <strong>Productos:</strong>
              <ul class="mb-0">
                {% for d in detalles %}
                  <li>
                    {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                    <br>
                    <small class="text-muted">
                      Sabores:
                      {% with sab=d.sabores.all %}
                        {% if sab %}{{ sab|join:", " }}{% else %}Sin sabores especificados{% endif %}
                      {% endwith %}
                    </small>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              No hay detalles de productos para este pedido.<br>
            {% endif %}
          {% endwith %}
          <div class="mt-3 pt-3 border-top">
            <button
              class="btn btn-success w-100 fw-bold btn-confirm"
              data-confirm-url="{% url 'confirmar_pedido' p.id %}"
              data-order-id="{{ p.id }}">
              <i class="bi bi-check-circle-fill"></i> Confirmar y Buscar Cadete
            </button>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info text-center" role="alert">
        Esperando nuevos pedidos...
      </div>
    {% endif %}
  </div>

  <div class="text-center mt-5 d-flex gap-2 justify-content-center flex-wrap">
    <span id="ws-status" class="badge bg-secondary align-self-center">Conectando‚Ä¶</span>
    <button id="toggle-sound" class="btn btn-outline-primary">üîî Sonido: ON</button>
    <button id="clear-alerts" class="btn btn-secondary">Limpiar Pedidos Mostrados</button>
  </div>
</div>

<script>
  // ====== CSRF util (Django) ======
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // ====== Sonido de alerta (Web Audio) ======
  let audioCtx = null;
  let soundEnabled = (localStorage.getItem('panel_sound') ?? 'on') !== 'off';

  function ensureAudio() {
    try {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return; // navegador muy viejo
        audioCtx = new AC();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    } catch (e) {
      console.warn('AudioContext no disponible:', e);
    }
  }

  function playDing() {
    if (!soundEnabled) return;
    ensureAudio();
    if (!audioCtx) return;

    // Sencillo "ding" de ~300ms
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(880, audioCtx.currentTime);          // A5
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.35);

    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.36);

    // Vibraci√≥n sutil en m√≥viles
    if (navigator.vibrate) {
      navigator.vibrate([120, 40, 120]);
    }
  }

  // Desbloquear audio con la primera interacci√≥n del usuario (pol√≠ticas de autoplay)
  function unlockOnFirstInteraction() {
    const once = () => {
      ensureAudio();
      document.removeEventListener('click', once);
      document.removeEventListener('keydown', once);
      document.removeEventListener('touchstart', once);
    };
    document.addEventListener('click', once, { once: true });
    document.addEventListener('keydown', once, { once: true });
    document.addEventListener('touchstart', once, { once: true });
  }

  // ====== Crear tarjeta desde datos WS ======
  function buildOrderCard(orderId, orderData) {
    const div = document.createElement('div');
    div.className = 'alert alert-primary alert-dismissible fade show new-order-alert order-card';
    div.setAttribute('role', 'alert');
    div.id = `order-${orderId}`;
    div.dataset.orderId = orderId;

    let detailsHtml = '';
    if (orderData.detalles && orderData.detalles.length > 0) {
      detailsHtml += `<strong>Productos:</strong><ul class="mb-0">`;
      orderData.detalles.forEach(d => {
        const name = d.opcion_nombre ? `${d.producto_nombre} - ${d.opcion_nombre}` : d.producto_nombre;
        const flavors = (d.sabores_nombres && d.sabores_nombres.length) ? d.sabores_nombres.join(', ') : 'Sin sabores especificados';
        detailsHtml += `<li>${name} (x${d.cantidad})<br><small class="text-muted">Sabores: ${flavors}</small></li>`;
      });
      detailsHtml += `</ul>`;
    } else {
      detailsHtml = `No hay detalles de productos para este pedido.<br>`;
    }

    const confirmUrl = `/confirmar-pedido/${orderId}/`;

    div.innerHTML = `
      <h4 class="alert-heading">¬°Nuevo Pedido #${orderId}!</h4>
      <p class="mb-1"><strong>Cliente:</strong> ${orderData.cliente_nombre || 'N/A'}</p>
      <p class="mb-1"><strong>Direcci√≥n:</strong> ${orderData.cliente_direccion || 'N/A'}</p>
      <p class="mb-1"><strong>Tel√©fono:</strong> ${orderData.cliente_telefono || 'N/A'}</p>
      <p class="mb-1"><strong>Total:</strong> $${parseFloat(orderData.total_pedido || 0).toFixed(2)}</p>
      <p class="mb-1"><strong>M√©todo de Pago:</strong> ${orderData.metodo_pago || 'N/A'}</p>
      <hr>
      ${detailsHtml}
      <div class="mt-3 pt-3 border-top">
        <button class="btn btn-success w-100 fw-bold btn-confirm"
                data-confirm-url="${confirmUrl}"
                data-order-id="${orderId}">
          <i class="bi bi-check-circle-fill"></i> Confirmar y Buscar Cadete
        </button>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    return div;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const alertsContainer = document.getElementById('alerts-container');
    const clearAlertsButton = document.getElementById('clear-alerts');
    const wsStatus = document.getElementById('ws-status');
    const toggleSoundBtn = document.getElementById('toggle-sound');

    // Estado inicial del bot√≥n de sonido
    const updateSoundBtn = () => {
      toggleSoundBtn.textContent = soundEnabled ? 'üîî Sonido: ON' : 'üîï Sonido: OFF';
      toggleSoundBtn.classList.toggle('btn-outline-primary', soundEnabled);
      toggleSoundBtn.classList.toggle('btn-outline-secondary', !soundEnabled);
    };
    updateSoundBtn();

    toggleSoundBtn.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      localStorage.setItem('panel_sound', soundEnabled ? 'on' : 'off');
      updateSoundBtn();
      ensureAudio(); // crea/reanuda el contexto al tocar el toggle
      if (soundEnabled) playDing(); // feedback corto
    });

    unlockOnFirstInteraction();

    // ---- Confirmar pedido por AJAX (delegaci√≥n) ----
    alertsContainer.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.btn-confirm');
      if (!btn) return;

      ev.preventDefault();
      const url = btn.dataset.confirmUrl;
      const card = btn.closest('.order-card');

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Confirmando...';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (res.ok) {
          // Si el view no devuelve JSON (redirect), esto no rompe:
          await res.clone().json().catch(() => ({}));
          if (card) card.remove();
        } else {
          // Fallback a navegaci√≥n tradicional
          window.location.href = url;
          return;
        }
      } catch (err) {
        console.error('Error confirmando pedido:', err);
        window.location.href = url; // fallback
        return;
      } finally {
        if (document.body.contains(btn)) {
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Confirmar y Buscar Cadete';
        }
      }

      if (!alertsContainer.querySelector('.order-card')) {
        alertsContainer.innerHTML = '<div class="alert alert-info text-center" role="alert">Esperando nuevos pedidos...</div>';
      }
    });

    // ---- WebSocket ----
    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const websocketUrl = wsProtocol + window.location.host + '/ws/pedidos/notifications/';
    console.log("Intentando conectar a WebSocket:", websocketUrl);
    const chatSocket = new WebSocket(websocketUrl);

    chatSocket.onopen = function(e) {
      console.log('Conexi√≥n WebSocket establecida.', e);
      wsStatus.classList.remove('bg-secondary', 'bg-danger');
      wsStatus.classList.add('bg-success');
      wsStatus.textContent = 'Conectado';

      if (!alertsContainer.querySelector('.order-card')) {
        const waiting = alertsContainer.querySelector('.alert-info');
        if (!waiting) {
          alertsContainer.innerHTML = '<div class="alert alert-info text-center" role="alert">Esperando nuevos pedidos...</div>';
        }
      }
    };

    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const message = data.message;
      const orderId = data.order_id;
      const orderData = data.order_data;

      console.log('Mensaje recibido:', message, 'ID:', orderId, 'Datos:', orderData);

      const waiting = alertsContainer.querySelector('.alert-info');
      if (waiting) waiting.remove();

      // Evitar duplicados
      if (document.getElementById(`order-${orderId}`)) return;

      const card = buildOrderCard(orderId, orderData);
      alertsContainer.prepend(card);

      // üîä Sonido y vibraci√≥n en pedido nuevo
      playDing();
    };

    chatSocket.onclose = function(e) {
      console.error('Conexi√≥n WebSocket cerrada inesperadamente.', e);
      wsStatus.classList.remove('bg-success', 'bg-secondary');
      wsStatus.classList.add('bg-danger');
      wsStatus.textContent = 'Desconectado';
      if (!alertsContainer.querySelector('.order-card')) {
        alertsContainer.innerHTML = '<div class="alert alert-danger text-center" role="alert">Conexi√≥n perdida. Recarga la p√°gina.</div>';
      }
    };

    chatSocket.onerror = function(e) {
      console.error('Error WebSocket:', e);
      wsStatus.classList.remove('bg-success', 'bg-secondary');
      wsStatus.classList.add('bg-danger');
      wsStatus.textContent = 'Error';
    };

    // ---- Bot√≥n limpiar (s√≥lo tarjetas) ----
    clearAlertsButton.addEventListener('click', function() {
      alertsContainer.querySelectorAll('.order-card').forEach(el => el.remove());
      alertsContainer.innerHTML = '<div class="alert alert-info text-center" role="alert">Esperando nuevos pedidos...</div>';
    });
  });
</script>

<style>
  .new-order-alert {
    border: 2px solid #0d6efd;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    animation: pulse 1.5s infinite alternate;
  }
  @keyframes pulse {
    from { transform: scale(1); box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2); }
    to   { transform: scale(1.01); box-shadow: 0 6px 16px rgba(13, 110, 253, 0.5); }
  }
</style>
{% endblock %}
