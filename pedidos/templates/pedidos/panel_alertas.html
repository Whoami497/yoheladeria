{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h2 class="section-title text-center mb-4">Panel de Alertas de Pedidos</h2>
  <p class="text-center text-muted">Llegan en tiempo real y quedan visibles aun si recargás la página.</p>
  <hr>

  <div id="alerts-container" class="mt-4">
    {% if pedidos_iniciales %}
      {% for p in pedidos_iniciales %}
        <div class="order-card alert alert-primary alert-dismissible fade show mb-3 p-3" id="order-{{ p.id }}" data-order-id="{{ p.id }}">
          <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <h5 class="mb-0">#{{ p.id }}</h5>
                <span class="badge bg-status-{{ p.estado|lower }}">{{ p.estado }}</span>
                <small class="text-muted">Total: ${{ p.total_pedido|default_if_none:"0.00" }}</small>
              </div>
              <div class="compact-line">
                <span class="fw-semibold">{{ p.cliente_nombre|default:"N/A" }}</span>
                <span class="text-muted">· {{ p.cliente_telefono|default:"—" }}</span>
                <span class="text-muted">· {{ p.cliente_direccion|default:"—" }}</span>
              </div>

              <details class="mt-2">
                <summary class="cursor-pointer">Ver productos</summary>
                <ul class="mb-0 small mt-2">
                  {% for d in p.detalles.all %}
                    <li>
                      {{ d.producto.nombre }}{% if d.opcion_seleccionada %} - {{ d.opcion_seleccionada.nombre_opcion }}{% endif %} (x{{ d.cantidad }})
                      <br><span class="text-muted">Sabores: 
                        {% with sab=d.sabores.all %}{% if sab %}{{ sab|join:", " }}{% else %}Sin especificar{% endif %}{% endwith %}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </details>
            </div>

            <div class="text-end min-btn-col">
              {% if p.estado == 'RECIBIDO' %}
              <button
                class="btn btn-success fw-bold btn-confirm"
                data-confirm-url="{% url 'confirmar_pedido' p.id %}"
                data-order-id="{{ p.id }}">
                <i class="bi bi-check-circle-fill"></i> Confirmar
              </button>
              {% else %}
              <button class="btn btn-outline-secondary" disabled>Confirmado</button>
              {% endif %}
            </div>
          </div>

          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info text-center" role="alert">
        Esperando nuevos pedidos...
      </div>
    {% endif %}
  </div>

  <div class="text-center mt-4 d-flex gap-2 justify-content-center flex-wrap">
    <span id="ws-status" class="badge bg-secondary align-self-center">Conectando…</span>
    <button id="toggle-sound" class="btn btn-outline-primary">🔔 Sonido: ON</button>
    <button id="clear-alerts" class="btn btn-secondary">Limpiar Pedidos Mostrados</button>
  </div>
</div>

<!-- SONIDO: usamos tu mp3 -->
<audio id="orderSound" preload="auto">
  <source src="{% static 'pedidos/sounds/new-order.mp3' %}" type="audio/mpeg">
</audio>

<script>
  // ===== CSRF =====
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2) return parts.pop().split(';').shift();}
  const csrftoken=getCookie('csrftoken');

  // ===== Sonido (archivo mp3) =====
  const soundEl = document.getElementById('orderSound');
  let soundEnabled=(localStorage.getItem('panel_sound') ?? 'on')!=='off';

  function playDing(){
    if(!soundEnabled) return;
    try{
      soundEl.currentTime = 0;
      soundEl.play().catch(()=>{}); // por si el navegador bloquea autoplay
      if(navigator.vibrate){navigator.vibrate([120,40,120]);}
    }catch(e){ console.warn('Audio no disponible', e); }
  }

  // “Desbloquear” el audio en la primera interacción del usuario (política de autoplay)
  function unlockOnFirstInteraction(){
    const once=()=>{
      // reproducimos y pausamos enseguida para otorgar permiso
      soundEl.play().then(()=>{ soundEl.pause(); soundEl.currentTime = 0; }).catch(()=>{});
      document.removeEventListener('click',once);
      document.removeEventListener('keydown',once);
      document.removeEventListener('touchstart',once);
    };
    document.addEventListener('click',once,{once:true});
    document.addEventListener('keydown',once,{once:true});
    document.addEventListener('touchstart',once,{once:true});
  }

  // ===== Helpers UI =====
  const alertsContainer=document.getElementById('alerts-container');
  const wsStatus=document.getElementById('ws-status');
  const toggleSoundBtn=document.getElementById('toggle-sound');
  const clearAlertsButton=document.getElementById('clear-alerts');

  function updateSoundBtn(){
    toggleSoundBtn.textContent = soundEnabled ? '🔔 Sonido: ON' : '🔕 Sonido: OFF';
    toggleSoundBtn.classList.toggle('btn-outline-primary', soundEnabled);
    toggleSoundBtn.classList.toggle('btn-outline-secondary', !soundEnabled);
  }
  toggleSoundBtn.addEventListener('click',()=>{
    soundEnabled=!soundEnabled;
    localStorage.setItem('panel_sound',soundEnabled?'on':'off');
    updateSoundBtn();
    if(soundEnabled) playDing();
  });
  updateSoundBtn(); unlockOnFirstInteraction();

  function orderExists(id){return document.getElementById(`order-${id}`) || document.getElementById(`chip-${id}`);}

  function renderChip(order){
    const chip=document.createElement('div');
    chip.className='order-chip d-flex align-items-center justify-content-between';
    chip.id=`chip-${order.id}`;
    chip.dataset.orderId=order.id;
    chip.innerHTML=`
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="chip-id">#${order.id}</span>
        <span class="badge bg-status-${(order.estado||'RECIBIDO').toLowerCase()}">${order.estado||'RECIBIDO'}</span>
        <span class="text-muted small">$${parseFloat(order.total_pedido||0).toFixed(2)}</span>
        <span class="small text-truncate chip-client">${order.cliente_nombre||'N/A'}</span>
      </div>
      <button class="btn btn-sm btn-outline-secondary" disabled>En curso</button>
    `;
    return chip;
  }

  function collapseToChip(cardEl, estadoNuevo='EN_PREPARACION'){
    const id=cardEl.dataset.orderId;
    cardEl.remove();
    const orderData = {
      id: id,
      estado: estadoNuevo,
      total_pedido: cardEl.querySelector('.text-muted')?.textContent?.replace('Total: $','') || '0',
      cliente_nombre: cardEl.querySelector('.compact-line .fw-semibold')?.textContent || ''
    };
    alertsContainer.prepend(renderChip(orderData));
    if(!alertsContainer.querySelector('.order-card') && !alertsContainer.querySelector('.order-chip')){
      alertsContainer.innerHTML='<div class="alert alert-info text-center" role="alert">Esperando nuevos pedidos...</div>';
    }
  }

  function buildOrderCardFromWS(orderId, orderData){
    if(orderExists(orderId)) return;

    const wrapper=document.createElement('div');
    wrapper.className='order-card alert alert-primary alert-dismissible fade show mb-3 p-3';
    wrapper.id=`order-${orderId}`;
    wrapper.dataset.orderId=orderId;

    const estado = orderData.estado || 'RECIBIDO';
    const total  = parseFloat(orderData.total_pedido||0).toFixed(2);

    let detailsHtml='';
    if(orderData.detalles && orderData.detalles.length){
      detailsHtml = `<ul class="mb-0 small mt-2">` + orderData.detalles.map(d=>{
        const name = d.opcion_nombre ? `${d.producto_nombre} - ${d.opcion_nombre}` : d.producto_nombre;
        const sabores = (d.sabores_nombres && d.sabores_nombres.length) ? d.sabores_nombres.join(', ') : 'Sin especificar';
        return `<li>${name} (x${d.cantidad})<br><span class="text-muted">Sabores: ${sabores}</span></li>`;
      }).join('') + `</ul>`;
    }else{
      detailsHtml = `<div class="small text-muted">Sin productos</div>`;
    }

    const confirmBtn = estado==='RECIBIDO'
      ? `<button class="btn btn-success fw-bold btn-confirm" data-confirm-url="/confirmar-pedido/${orderId}/" data-order-id="${orderId}">
           <i class="bi bi-check-circle-fill"></i> Confirmar
         </button>`
      : `<button class="btn btn-outline-secondary" disabled>Confirmado</button>`;

    wrapper.innerHTML=`
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-2">
            <h5 class="mb-0">#${orderId}</h5>
            <span class="badge bg-status-${estado.toLowerCase()}">${estado}</span>
            <small class="text-muted">Total: $${total}</small>
          </div>
          <div class="compact-line">
            <span class="fw-semibold">${orderData.cliente_nombre || 'N/A'}</span>
            <span class="text-muted">· ${orderData.cliente_telefono || '—'}</span>
            <span class="text-muted">· ${orderData.cliente_direccion || '—'}</span>
          </div>
          <details class="mt-2"><summary>Ver productos</summary>${detailsHtml}</details>
        </div>
        <div class="text-end min-btn-col">
          ${confirmBtn}
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alertsContainer.prepend(wrapper);
  }

  // Delegación: confirmar pedido (AJAX)
  alertsContainer.addEventListener('click', async (ev)=>{
    const btn=ev.target.closest('.btn-confirm'); if(!btn) return;
    ev.preventDefault();
    const url=btn.dataset.confirmUrl;
    const card=btn.closest('.order-card');
    btn.disabled=true; btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Confirmando...';
    try{
      const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        collapseToChip(card,'EN_PREPARACION');
      }else{
        window.location.href=url;
      }
    }catch(e){
      console.error('Error confirmando:',e);
      window.location.href=url;
    }
  });

  // Botón limpiar
  document.getElementById('clear-alerts').addEventListener('click',()=>{
    alertsContainer.innerHTML='<div class="alert alert-info text-center" role="alert">Esperando nuevos pedidos...</div>';
  });

  // ===== WebSocket =====
  const wsProtocol=window.location.protocol==='https:'?'wss://':'ws://';
  const websocketUrl=wsProtocol + window.location.host + '/ws/pedidos/notifications/';
  const chatSocket=new WebSocket(websocketUrl);

  chatSocket.onopen=function(){
    wsStatus.classList.remove('bg-secondary','bg-danger');
    wsStatus.classList.add('bg-success');
    wsStatus.textContent='Conectado';
  };
  chatSocket.onclose=function(){
    wsStatus.classList.remove('bg-success','bg-secondary');
    wsStatus.classList.add('bg-danger');
    wsStatus.textContent='Desconectado';
  };
  chatSocket.onerror=function(){
    wsStatus.classList.remove('bg-success','bg-secondary');
    wsStatus.classList.add('bg-danger');
    wsStatus.textContent='Error';
  };

  chatSocket.onmessage=function(e){
    const data=JSON.parse(e.data);
    const orderId=data.order_id;
    const orderData=data.order_data||{};
    buildOrderCardFromWS(orderId, orderData);
    playDing(); // ahora reproduce tu mp3
  };
</script>

<style>
  .order-chip{
    border:1px solid var(--bs-primary);
    background:rgba(13,110,253,.08);
    border-radius:.75rem;
    padding:.5rem .75rem;
    margin-bottom:.6rem;
  }
  .chip-id{font-weight:700}
  .chip-client{max-width:240px}

  .order-card h5{font-size:1.05rem}
  .compact-line{font-size:.95rem}
  .min-btn-col{min-width:180px}

  .bg-status-recibido{background:#0d6efd !important}
  .bg-status-en_preparacion{background:#0dcaf0 !important}
  .bg-status-asignado{background:#6f42c1 !important}
  .bg-status-en_camino{background:#ffc107 !important; color:#212529 !important}
  .bg-status-entregado{background:#198754 !important}
  .bg-status-cancelado{background:#dc3545 !important}
</style>
{% endblock %}
