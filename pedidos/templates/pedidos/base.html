<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yo Heladerías</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    {% load webpush_notifications %}
    {% webpush_header %}

    <style>
      :root{
        --c-dark:#1a1a1a;--c-dark-2:#2a2a2a;
        --c-azul:#073653;--c-azul-claro:#007bff;--c-azul-hover:#052a42;
        --c-white:#fff;--c-light:#f8f9fa;--c-text:#343a40;--c-muted:#6c757d;--c-br:#dee2e6;
        --s-soft:rgba(0,0,0,.2);--s-med:rgba(0,0,0,.3);--s-strong:rgba(0,0,0,.4);
        --shell: 920px;
      }
      body{padding-top:0;background:var(--c-dark);color:#e0e0e0;font-family:Arial,Helvetica,sans-serif}

      html, body, .main-content-wrapper, .main-content { max-width:100vw; overflow-x:hidden; }
      .main-content .row{ margin-left:0; margin-right:0; }
      img,video{max-width:100%;height:auto}
      .main-content .container,.main-content .container-fluid{max-width:100%}

      .page-wrapper{display:flex;min-height:100vh;background:var(--c-dark)}
      .sidebar-desktop{width:250px;background:var(--c-dark-2);box-shadow:2px 0 10px var(--s-soft);padding-top:20px;position:fixed;height:100%;overflow-y:auto;border-right:1px solid rgba(255,255,255,.05)}
      .sidebar-desktop .sidebar-logo{text-align:center;padding:0 15px 20px}
      .sidebar-desktop .sidebar-logo img{max-width:100%;max-height:100px;object-fit:contain}
      .sidebar-desktop .sidebar-nav .nav-link{color:#fff;padding:15px 20px;font-weight:500;display:flex;align-items:center;border-radius:8px;margin:0 10px}
      .sidebar-desktop .sidebar-nav .nav-link i{margin-right:10px}
      .sidebar-desktop .sidebar-nav .nav-link:hover,.sidebar-desktop .sidebar-nav .nav-link.active{background:var(--c-azul-claro);color:#fff!important;box-shadow:0 2px 5px var(--s-soft)}

      .main-content-wrapper{flex-grow:1;background:var(--c-dark);padding:20px}
      .main-content{background:#fff;border-radius:15px;padding:30px;box-shadow:0 5px 20px var(--s-med);min-height:calc(100vh - 40px);color:var(--c-text)}
      .content-inner{max-width:var(--shell);margin:0 auto;width:100%}

      .alert{border-radius:10px;font-weight:500}
      .alert-success{background:#d1ecf1;border-color:#bee5eb;color:var(--c-azul)}
      .alert-info{background:#e0f7fa;border-color:#b2ebf2;color:var(--c-azul)}
      .alert-warning{background:#ffecb3;border-color:#ffe082;color:#cc9900}
      .alert-danger{background:#ffcdd2;border-color:#ef9a9a;color:#d32f2f}

      .btn-primary{background:var(--c-azul-claro);border-color:var(--c-azul-claro);font-weight:700}
      .btn-primary:hover{background:var(--c-azul);border-color:var(--c-azul);transform:translateY(-2px)}
      .btn-secondary{background:#fff;border-color:#fff;color:var(--c-azul);font-weight:700}
      .btn-secondary:hover{background:var(--c-br);border-color:var(--c-br);color:var(--c-azul-hover)}

      .mobile-tabbar{position:fixed;left:0;right:0;bottom:0;display:none;gap:.25rem;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-top:1px solid rgba(7,54,83,.12);box-shadow:0 -6px 20px rgba(0,0,0,.15);z-index:1030;padding:.2rem .4rem}
      .mobile-tabbar a.mbn-item{flex:1;text-align:center;text-decoration:none;color:var(--c-azul);font-weight:600;font-size:.86rem;padding:.35rem .25rem .5rem;border-radius:12px;display:flex;flex-direction:column;align-items:center}
      .mobile-tabbar a.mbn-item .bi{font-size:1.25rem;margin-bottom:.1rem}
      .mobile-tabbar a.mbn-item.active{color:var(--c-azul-claro);background:rgba(0,123,255,.08)}

      @media (min-width:992px){
        .page-wrapper{flex-direction:row}
        .sidebar-desktop{display:block}
        .main-content-wrapper{margin-left:250px}
      }
      @media (max-width:991.98px){
        body{padding-bottom:64px}
        .sidebar-desktop{display:none}
        .mobile-tabbar{display:flex}
        .main-content{padding:18px;border-radius:14px}
        h1,h2{font-size:clamp(1.25rem,5.6vw,1.75rem)}
        .content-inner{max-width:100%}
        .home-hero,#nuestro-catalogo{max-width:var(--shell);margin-inline:auto}
      }
    </style>
  </head>
  <body>
    {% load static %}

    <div class="page-wrapper">
      <aside class="sidebar-desktop">
        <div class="sidebar-logo">
          <a href="{% url 'index' %}">
            <img src="{% static 'images/logo_yo_heladeria_blanco.png' %}" alt="Yo Heladerías">
          </a>
        </div>

        <nav class="sidebar-nav">
          <ul class="nav flex-column">
            {% if user.is_authenticated and user.cadeteprofile %}
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'panel_cadete' %}active{% endif %}" href="{% url 'panel_cadete' %}">
                  <i class="bi bi-bicycle"></i> Panel del Cadete
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'cadete_historial' %}active{% endif %}" href="{% url 'cadete_historial' %}">
                  <i class="bi bi-clock-history"></i> Historial
                </a>
              </li>
              <li class="nav-item px-3 mt-2 text-white-50">Disponibilidad</li>
              <li class="nav-item px-3">
                <button class="btn btn-sm btn-secondary" id="btn-cadete-dispo-desktop" data-on="0">
                  <i class="bi bi-power"></i> <span>Activar disponible</span>
                </button>
              </li>
              <li class="nav-item mt-2">
                <a class="nav-link" href="{% url 'logout_cadete' %}">
                  <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </a>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}" href="{% url 'index' %}">
                  <i class="bi bi-house-door-fill"></i> Inicio
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'ver_carrito' %}active{% endif %}" href="{% url 'ver_carrito' %}">
                  <i class="bi bi-cart-fill"></i> Carrito
                </a>
              </li>

              {% if categorias %}
                <li class="nav-item px-3 mt-2 text-white-50">Categorías</li>
                {% for categoria in categorias %}
                  <li class="nav-item">
                    <a class="nav-link" href="{% url 'productos_por_categoria' categoria.id %}">
                      <i class="bi bi-dot"></i> {{ categoria.nombre }}
                    </a>
                  </li>
                {% endfor %}
              {% endif %}

              <li class="nav-item px-3 mt-2 text-white-50">Más Opciones</li>
              {% if user.is_authenticated %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'perfil_cliente' %}active{% endif %}" href="{% url 'perfil_cliente' %}"><i class="bi bi-person-fill"></i> Mi Perfil ({{ user.username }})</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'historial_pedidos_cliente' %}active{% endif %}" href="{% url 'historial_pedidos_cliente' %}"><i class="bi bi-clock-history"></i> Historial</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'canjear_puntos' %}active{% endif %}" href="{% url 'canjear_puntos' %}"><i class="bi bi-gift-fill"></i> Canjear Puntos</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'logout_cliente' %}"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
              {% else %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}" href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'register_cliente' %}active{% endif %}" href="{% url 'register_cliente' %}"><i class="bi bi-person-plus-fill"></i> Registrarse</a></li>
              {% endif %}
            {% endif %}
          </ul>
        </nav>
      </aside>

      <div class="main-content-wrapper">
        <div class="main-content">
          <div class="content-inner">
            {% if messages %}
              <div class="messages mt-3">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% block content %}{% endblock %}
          </div>
        </div>
      </div>
    </div>

    {% with url_name=request.resolver_match.url_name %}
      {% if user.is_authenticated and user.cadeteprofile %}
        <nav class="mobile-tabbar" aria-label="Navegación cadete">
          <a class="mbn-item {% if url_name == 'panel_cadete' %}active{% endif %}" href="{% url 'panel_cadete' %}">
            <i class="bi bi-bicycle"></i><span>Panel</span>
          </a>
          <a href="#" class="mbn-item" id="btn-cadete-dispo" data-on="0">
            <i class="bi bi-power"></i><span>Disponible</span>
          </a>
          <a class="mbn-item {% if url_name == 'cadete_historial' %}active{% endif %}" href="{% url 'cadete_historial' %}">
            <i class="bi bi-clock-history"></i><span>Historial</span>
          </a>
          <a class="mbn-item" href="{% url 'logout_cadete' %}">
            <i class="bi bi-box-arrow-right"></i><span>Salir</span>
          </a>
        </nav>
      {% else %}
        <nav class="mobile-tabbar" aria-label="Navegación cliente">
          <a class="mbn-item" data-bs-toggle="modal" data-bs-target="#moreModal">
            <i class="bi bi-three-dots"></i><span>Más</span>
          </a>
          <a class="mbn-item" href="/#nuestro-catalogo">
            <i class="bi bi-list-ul"></i><span>Catálogo</span>
          </a>
          <a class="mbn-item {% if url_name == 'pedido_en_curso' %}active{% endif %}" href="{% url 'pedido_en_curso' %}">
            <i class="bi bi-geo-alt"></i><span>Pedido</span>
          </a>
          <a class="mbn-item {% if url_name == 'ver_carrito' %}active{% endif %}" href="{% url 'ver_carrito' %}">
            <i class="bi bi-cart3"></i><span>Carrito</span>
          </a>
          {% if user.is_authenticated %}
            <a class="mbn-item {% if url_name == 'perfil_cliente' %}active{% endif %}" href="{% url 'perfil_cliente' %}">
              <i class="bi bi-person"></i><span>Perfil</span>
            </a>
          {% else %}
            <a class="mbn-item {% if url_name == 'login' %}active{% endif %}" href="{% url 'login' %}">
              <i class="bi bi-box-arrow-in-right"></i><span>Ingresar</span>
            </a>
          {% endif %}
        </nav>

        <div class="modal fade" id="moreModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Más opciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                  <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'index' %}">
                    <i class="bi bi-house-door me-2"></i> Inicio
                  </a>
                  {% if user.is_authenticated %}
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'canjear_puntos' %}">
                      <i class="bi bi-gift me-2"></i> Canjear Puntos
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'historial_pedidos_cliente' %}">
                      <i class="bi bi-clock-history me-2"></i> Historial
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'perfil_cliente' %}">
                      <i class="bi bi-person me-2"></i> Mi Perfil
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'logout_cliente' %}">
                      <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
                    </a>
                  {% else %}
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'login' %}">
                      <i class="bi bi-box-arrow-in-right me-2"></i> Iniciar Sesión
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'register_cliente' %}">
                      <i class="bi bi-person-plus me-2"></i> Registrarse
                    </a>
                  {% endif %}
                  <a class="list-group-item list-group-item-action d-flex align-items-center" href="/#contacto">
                    <i class="bi bi-geo-alt me-2"></i> Contacto
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endwith %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- ===== JS: disponibilidad + registro de Push para cadete ===== -->
<script>
  (function () {
    // --- CSRF
    function getCookie(name){
      const v = `; ${document.cookie}`.split(`; ${name}=`);
      if (v.length === 2) return v.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // --- Util VAPID
    function urlB64ToUint8Array(base64String){
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    // --- REGISTRO PUSH (guarda el objeto "crudo": endpoint + keys)
    async function ensurePushRegistered(){
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      try{
        // registra (o reusa) el SW de raíz y espera a que quede activo
        await navigator.serviceWorker.register("{% url 'service_worker' %}");
        const readyReg = await navigator.serviceWorker.ready;

        // distintas libs inyectan el nombre de la variable de VAPID de forma distinta
        const vapid =
          (window.vapidPublicKey) ||
          (window.django_webpush_config && window.django_webpush_config.vapidKey) ||
          (window.vapid_key) || '';
        const vapidKey = (vapid || '').trim();
        if (!vapidKey){ console.warn('VAPID public key no disponible'); return; }

        let sub = await readyReg.pushManager.getSubscription();
        if (!sub){
          sub = await readyReg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlB64ToUint8Array(vapidKey)
          });
        }

        // ⚠️ Enviamos el objeto "crudo" (no envuelto en {subscription: ...})
        const payload = sub.toJSON();
        await fetch("{% url 'save_subscription' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With':'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });
      }catch(e){
        console.warn('No se pudo registrar push', e);
      }
    }

    // --- Disponibilidad del cadete (único toggle desde barra)
    function applyDisponibilidadToUI(val){
      const btnM = document.getElementById('btn-cadete-dispo');
      const btnD = document.getElementById('btn-cadete-dispo-desktop');

      if (btnM){
        btnM.dataset.on = val ? '1' : '0';
        btnM.classList.toggle('active', val);
        const spanM = btnM.querySelector('span');
        if (spanM) spanM.textContent = val ? 'Disponible' : 'No disp.';
      }
      if (btnD){
        btnD.dataset.on = val ? '1' : '0';
        btnD.classList.toggle('btn-success', val);
        btnD.classList.toggle('btn-secondary', !val);
        const spanD = btnD.querySelector('span');
        if (spanD) spanD.textContent = val ? 'Disponible' : 'Activar disponible';
      }
    }

    async function setDisponible(turnOn){
      const fd = new FormData();
      fd.append('disponible', turnOn ? '1' : '0');

      try{
        const res = await fetch("{% url 'cadete_toggle_disponible' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
          body: fd
        });

        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (!ct.includes('application/json')) {
          window.location.href = "{% url 'login_cadete' %}";
          return;
        }

        const j = await res.json();
        if (!j.ok){
          if (j.error === 'ocupado'){
            alert('Tenés un pedido en curso. Entregalo antes de cambiar tu disponibilidad.');
          }else{
            alert('No se pudo cambiar la disponibilidad.');
          }
          return;
        }
        applyDisponibilidadToUI(!!j.disponible);
        if (j.disponible) ensurePushRegistered();
      }catch(e){
        console.error('toggle disponible error', e);
        alert('Error de red cambiando disponibilidad.');
      }
    }

    function bindBtn(el){
      if(!el) return;
      el.addEventListener('click', function(ev){
        ev.preventDefault();
        const isOn = (this.dataset.on === '1');
        const turningOn = !isOn;
        if (!turningOn && !confirm('¿Querés desactivar tu disponibilidad?')) return;
        setDisponible(turningOn);
      });
    }

    bindBtn(document.getElementById('btn-cadete-dispo'));
    bindBtn(document.getElementById('btn-cadete-dispo-desktop'));

    // --- Estado inicial: SOLO lo que diga la DB (evitamos activar por sesión)
    function initState(){
      const initial = "{% if user.is_authenticated and user.cadeteprofile and user.cadeteprofile.disponible %}1{% else %}0{% endif %}";
      const val = (initial === '1');
      applyDisponibilidadToUI(val);
      if (val) ensurePushRegistered();
    }
    initState();
  })();
</script>


    <!-- Debug overflow opcional -->
    <script>
      (function(){
        if (!/debug-overflow=1/.test(location.search)) return;
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const sw = Math.max(document.documentElement.scrollWidth, document.body.scrollWidth);
        console.log('[overflow-check] viewport=', vw, 'scrollWidth=', sw);
        if (sw > vw) {
          document.querySelectorAll('body *').forEach(el => {
            const w = el.scrollWidth;
            if (w > vw) { el.style.outline = '1px dashed red'; console.log('Overflow:', el, '->', w); }
          });
        } else {
          console.log('Sin overflow horizontal 👍');
        }
      })();
    </script>
  </body>
</html>
