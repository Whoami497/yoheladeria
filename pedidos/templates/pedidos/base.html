<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yo Heladerías</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- PWA -->
<link rel="manifest" href="{% static 'manifest.json' %}">
<meta name="theme-color" content="#073653">
<link rel="apple-touch-icon" href="{% static 'images/icon-192.png' %}">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Yo Helados">

<!-- Android -->
<meta name="mobile-web-app-capable" content="yes">

    {% load webpush_notifications %}
    {% webpush_header %}

    <style>
      :root{
        --c-dark:#1a1a1a;--c-dark-2:#2a2a2a;
        --c-azul:#073653;--c-azul-claro:#007bff;--c-azul-hover:#052a42;
        --c-white:#fff;--c-light:#f8f9fa;--c-text:#343a40;--c-muted:#6c757d;--c-br:#dee2e6;
        --s-soft:rgba(0,0,0,.2);--s-med:rgba(0,0,0,.3);--s-strong:rgba(0,0,0,.4);
        --shell: 920px;
      }
      body{padding-top:0;background:var(--c-dark);color:#e0e0e0;font-family:Arial,Helvetica,sans-serif}

      html, body, .main-content-wrapper, .main-content { max-width:100vw; overflow-x:hidden; }
      .main-content .row{ margin-left:0; margin-right:0; }
      img,video{max-width:100%;height:auto}
      .main-content .container,.main-content .container-fluid{max-width:100%}

      .page-wrapper{display:flex;min-height:100vh;background:var(--c-dark)}
      .sidebar-desktop{width:250px;background:var(--c-dark-2);box-shadow:2px 0 10px var(--s-soft);padding-top:20px;position:fixed;height:100%;overflow-y:auto;border-right:1px solid rgba(255,255,255,.05)}
      .sidebar-desktop .sidebar-logo{text-align:center;padding:0 15px 20px}
      .sidebar-desktop .sidebar-logo img{max-width:100%;max-height:100px;object-fit:contain}
      .sidebar-desktop .sidebar-nav .nav-link{color:#fff;padding:15px 20px;font-weight:500;display:flex;align-items:center;border-radius:8px;margin:0 10px}
      .sidebar-desktop .sidebar-nav .nav-link i{margin-right:10px}
      .sidebar-desktop .sidebar-nav .nav-link:hover,.sidebar-desktop .sidebar-nav .nav-link.active{background:var(--c-azul-claro);color:#fff!important;box-shadow:0 2px 5px var(--s-soft)}

      .main-content-wrapper{flex-grow:1;background:var(--c-dark);padding:20px}
      .main-content{background:#fff;border-radius:15px;padding:30px;box-shadow:0 5px 20px var(--s-med);min-height:calc(100vh - 40px);color:var(--c-text)}
      .content-inner{max-width:var(--shell);margin:0 auto;width:100%}

      .alert{border-radius:10px;font-weight:500}
      .alert-success{background:#d1ecf1;border-color:#bee5eb;color:var(--c-azul)}
      .alert-info{background:#e0f7fa;border-color:#b2ebf2;color:var(--c-azul)}
      .alert-warning{background:#ffecb3;border-color:#ffe082;color:#cc9900}
      .alert-danger{background:#ffcdd2;border-color:#ef9a9a;color:#d32f2f}

      .btn-primary{background:var(--c-azul-claro);border-color:var(--c-azul-claro);font-weight:700}
      .btn-primary:hover{background:var(--c-azul);border-color:var(--c-azul);transform:translateY(-2px)}
      .btn-secondary{background:#fff;border-color:#fff;color:var(--c-azul);font-weight:700}
      .btn-secondary:hover{background:var(--c-br);border-color:var(--c-br);color:var(--c-azul-hover)}

      .mobile-tabbar{position:fixed;left:0;right:0;bottom:0;display:none;gap:.25rem;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-top:1px solid rgba(7,54,83,.12);box-shadow:0 -6px 20px rgba(0,0,0,.15);z-index:1030;padding:.2rem .4rem}
      .mobile-tabbar a.mbn-item{flex:1;text-align:center;text-decoration:none;color:var(--c-azul);font-weight:600;font-size:.86rem;padding:.35rem .25rem .5rem;border-radius:12px;display:flex;flex-direction:column;align-items:center}
      .mobile-tabbar a.mbn-item .bi{font-size:1.25rem;margin-bottom:.1rem}
      .mobile-tabbar a.mbn-item.active{color:var(--c-azul-claro);background:rgba(0,123,255,.08)}

      @media (min-width:992px){
        .page-wrapper{flex-direction:row}
        .sidebar-desktop{display:block}
        .main-content-wrapper{margin-left:250px}
      }
      @media (max-width:991.98px){
        body{padding-bottom:64px}
        .sidebar-desktop{display:none}
        .mobile-tabbar{display:flex}
        .main-content{padding:18px;border-radius:14px}
        h1,h2{font-size:clamp(1.25rem,5.6vw,1.75rem)}
        .content-inner{max-width:100%}
        .home-hero,#nuestro-catalogo{max-width:var(--shell);margin-inline:auto}
      }

      /* ===== Banner público de estado de tienda ===== */
      .tienda-banner{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:.75rem;padding:.4rem .75rem}
      .tienda-banner .small-help{font-weight:500;opacity:.85}
    </style>
  </head>
  <body>
    {% load static %}

    <div class="page-wrapper">
      <aside class="sidebar-desktop">
        <div class="sidebar-logo">
          <a href="{% url 'index' %}">
            <img src="{% static 'images/logo_yo_heladeria_blanco.png' %}" alt="Yo Heladerías">
          </a>
        </div>

        <nav class="sidebar-nav">
          <ul class="nav flex-column">
            {% if user.is_authenticated and user.cadeteprofile %}
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'panel_cadete' %}active{% endif %}" href="{% url 'panel_cadete' %}">
                  <i class="bi bi-bicycle"></i> Panel del Cadete
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'cadete_historial' %}active{% endif %}" href="{% url 'cadete_historial' %}">
                  <i class="bi bi-clock-history"></i> Historial
                </a>
              </li>
              <li class="nav-item px-3 mt-2 text-white-50">Disponibilidad</li>
              <li class="nav-item px-3">
                <button class="btn btn-sm btn-secondary" id="btn-cadete-dispo-desktop" data-on="0">
                  <i class="bi bi-power"></i> <span>Activar disponible</span>
                </button>
              </li>
              <li class="nav-item mt-2">
                <a class="nav-link" href="{% url 'logout_cadete' %}">
                  <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                </a>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}" href="{% url 'index' %}">
                  <i class="bi bi-house-door-fill"></i> Inicio
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if request.resolver_match.url_name == 'ver_carrito' %}active{% endif %}" href="{% url 'ver_carrito' %}">
                  <i class="bi bi-cart-fill"></i> Carrito
                </a>
              </li>

              {% if categorias %}
                <li class="nav-item px-3 mt-2 text-white-50">Categorías</li>
                {% for categoria in categorias %}
                  <li class="nav-item">
                    <a class="nav-link" href="{% url 'productos_por_categoria' categoria.id %}">
                      <i class="bi bi-dot"></i> {{ categoria.nombre }}
                    </a>
                  </li>
                {% endfor %}
              {% endif %}

              <li class="nav-item px-3 mt-2 text-white-50">Más Opciones</li>
              {% if user.is_authenticated %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'perfil_cliente' %}active{% endif %}" href="{% url 'perfil_cliente' %}"><i class="bi bi-person-fill"></i> Mi Perfil ({{ user.username }})</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'historial_pedidos_cliente' %}active{% endif %}" href="{% url 'historial_pedidos_cliente' %}"><i class="bi bi-clock-history"></i> Historial</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'canjear_puntos' %}active{% endif %}" href="{% url 'canjear_puntos' %}"><i class="bi bi-gift-fill"></i> Canjear Puntos</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'logout_cliente' %}"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</a></li>
              {% else %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}" href="{% url 'login' %}"><i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'register_cliente' %}active{% endif %}" href="{% url 'register_cliente' %}"><i class="bi bi-person-plus-fill"></i> Registrarse</a></li>
              {% endif %}
            {% endif %}
          </ul>
        </nav>
      </aside>

      <div class="main-content-wrapper">
        <div class="main-content">
          <div class="content-inner">
            {% if messages %}
              <div class="messages mt-3">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {# ===== Banner público de estado de tienda (informativo) ===== #}
            <div id="tienda-banner"
                 class="tienda-banner alert {% if TIENDA_ABIERTA %}alert-success{% else %}alert-warning{% endif %} py-2"
                 data-open="{% if TIENDA_ABIERTA %}1{% else %}0{% endif %}">
              <div id="tienda-banner-text">
                {% if TIENDA_ABIERTA %}
                  <strong>🟢 Estamos tomando pedidos online ahora.</strong>
                {% else %}
                  <strong>🔴 No estamos tomando pedidos online en este momento.</strong>
                {% endif %}
              </div>
              <div class="small-help text-muted">
                Podés ver el catálogo y armar el carrito.
                {% if not TIENDA_ABIERTA %}
                  El checkout se habilita cuando abrimos de 13 a 16 hs y de 21 a 00hs.
                {% endif %}
              </div>
            </div>
            <!-- Config de geocerca para JS -->
            <div id="geo-config"
               data-store-lat="{{ STORE_COORDS.lat }}"
               data-store-lng="{{ STORE_COORDS.lng }}"
               data-delivery-radius-km="{{ DELIVERY_RADIUS_KM }}"
               data-reask-threshold-m="{{ REASK_THRESHOLD_METERS }}">
            </div>

            {% block content %}{% endblock %}
          </div>
        </div>
      </div>
    </div>

    {% with url_name=request.resolver_match.url_name %}
      {% if user.is_authenticated and user.cadeteprofile %}
        <nav class="mobile-tabbar" aria-label="Navegación cadete">
          <a class="mbn-item {% if url_name == 'panel_cadete' %}active{% endif %}" href="{% url 'panel_cadete' %}">
            <i class="bi bi-bicycle"></i><span>Panel</span>
          </a>
          <a href="#" class="mbn-item" id="btn-cadete-dispo" data-on="0">
            <i class="bi bi-power"></i><span>Disponible</span>
          </a>
          <a class="mbn-item {% if url_name == 'cadete_historial' %}active{% endif %}" href="{% url 'cadete_historial' %}">
            <i class="bi bi-clock-history"></i><span>Historial</span>
          </a>
          <a class="mbn-item" href="{% url 'logout_cadete' %}">
            <i class="bi bi-box-arrow-right"></i><span>Salir</span>
          </a>
        </nav>
      {% else %}
        <nav class="mobile-tabbar" aria-label="Navegación cliente">
          <a class="mbn-item" data-bs-toggle="modal" data-bs-target="#moreModal">
            <i class="bi bi-three-dots"></i><span>Más</span>
          </a>
          <a class="mbn-item" href="/#nuestro-catalogo">
            <i class="bi bi-list-ul"></i><span>Catálogo</span>
          </a>
          <a class="mbn-item {% if url_name == 'pedido_en_curso' %}active{% endif %}" href="{% url 'pedido_en_curso' %}">
            <i class="bi bi-geo-alt"></i><span>Pedido</span>
          </a>
          <a class="mbn-item {% if url_name == 'ver_carrito' %}active{% endif %}" href="{% url 'ver_carrito' %}">
            <i class="bi bi-cart3"></i><span>Carrito</span>
          </a>
          {% if user.is_authenticated %}
            <a class="mbn-item {% if url_name == 'perfil_cliente' %}active{% endif %}" href="{% url 'perfil_cliente' %}">
              <i class="bi bi-person"></i><span>Perfil</span>
            </a>
          {% else %}
            <a class="mbn-item {% if url_name == 'login' %}active{% endif %}" href="{% url 'login' %}">
              <i class="bi bi-box-arrow-in-right"></i><span>Ingresar</span>
            </a>
          {% endif %}
        </nav>

        <div class="modal fade" id="moreModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Más opciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                  <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'index' %}">
                    <i class="bi bi-house-door me-2"></i> Inicio
                  </a>
                  {% if user.is_authenticated %}
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'canjear_puntos' %}">
                      <i class="bi bi-gift me-2"></i> Canjear Puntos
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'historial_pedidos_cliente' %}">
                      <i class="bi bi-clock-history me-2"></i> Historial
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'perfil_cliente' %}">
                      <i class="bi bi-person me-2"></i> Mi Perfil
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'logout_cliente' %}">
                      <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
                    </a>
                  {% else %}
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'login' %}">
                      <i class="bi bi-box-arrow-in-right me-2"></i> Iniciar Sesión
                    </a>
                    <a class="list-group-item list-group-item-action d-flex align-items-center" href="{% url 'register_cliente' %}">
                      <i class="bi bi-person-plus me-2"></i> Registrarse
                    </a>
                  {% endif %}
                  <a class="list-group-item list-group-item-action d-flex align-items-center" href="/#contacto">
                    <i class="bi bi-geo-alt me-2"></i> Contacto
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endwith %}

    <!-- Modal NO bloqueante para fuera de cobertura -->
    <div class="modal fade" id="geoOutModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Fuera de cobertura</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning mb-0">
              <span id="geo-out-msg">Estás fuera del radio permitido.</span>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- ===== JS: disponibilidad + registro de Push para cadete ===== -->
<script>
  (function () {
    // --- CSRF
    function getCookie(name){
      const v = `; ${document.cookie}`.split(`; ${name}=`);
      if (v.length === 2) return v.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // --- Util VAPID
    function urlB64ToUint8Array(base64String){
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    // --- REGISTRO PUSH (guarda el objeto "crudo": endpoint + keys)
    async function ensurePushRegistered(){
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      try{
        await navigator.serviceWorker.register("{% url 'service_worker' %}");
        const readyReg = await navigator.serviceWorker.ready;

        const vapid =
          (window.vapidPublicKey) ||
          (window.django_webpush_config && window.django_webpush_config.vapidKey) ||
          (window.vapid_key) || '';
        const vapidKey = (vapid || '').trim();
        if (!vapidKey){ console.warn('VAPID public key no disponible'); return; }

        let sub = await readyReg.pushManager.getSubscription();
        if (!sub){
          sub = await readyReg.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlB64ToUint8Array(vapidKey)
          });
        }

        const payload = sub.toJSON();
        await fetch("{% url 'save_subscription' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With':'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });
      }catch(e){
        console.warn('No se pudo registrar push', e);
      }
    }

    // --- Disponibilidad del cadete
    function applyDisponibilidadToUI(val){
      const btnM = document.getElementById('btn-cadete-dispo');
      const btnD = document.getElementById('btn-cadete-dispo-desktop');

      if (btnM){
        btnM.dataset.on = val ? '1' : '0';
        btnM.classList.toggle('active', val);
        const spanM = btnM.querySelector('span');
        if (spanM) spanM.textContent = val ? 'Disponible' : 'No disp.';
      }
      if (btnD){
        btnD.dataset.on = val ? '1' : '0';
        btnD.classList.toggle('btn-success', val);
        btnD.classList.toggle('btn-secondary', !val);
        const spanD = btnD.querySelector('span');
        if (spanD) spanD.textContent = val ? 'Disponible' : 'Activar disponible';
      }
    }

    async function setDisponible(turnOn){
      const fd = new FormData();
      fd.append('disponible', turnOn ? '1' : '0');

      try{
        const res = await fetch("{% url 'cadete_toggle_disponible' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
          body: fd
        });

        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (!ct.includes('application/json')) {
          window.location.href = "{% url 'login_cadete' %}";
          return;
        }

        const j = await res.json();
        if (!j.ok){
          if (j.error === 'ocupado'){
            alert('Tenés un pedido en curso. Entregalo antes de cambiar tu disponibilidad.');
          }else{
            alert('No se pudo cambiar la disponibilidad.');
          }
          return;
        }
        applyDisponibilidadToUI(!!j.disponible);
        if (j.disponible) ensurePushRegistered();
      }catch(e){
        console.error('toggle disponible error', e);
        alert('Error de red cambiando disponibilidad.');
      }
    }

    function bindBtn(el){
      if(!el) return;
      el.addEventListener('click', function(ev){
        ev.preventDefault();
        const isOn = (this.dataset.on === '1');
        const turningOn = !isOn;
        if (!turningOn && !confirm('¿Querés desactivar tu disponibilidad?')) return;
        setDisponible(turningOn);
      });
    }

    bindBtn(document.getElementById('btn-cadete-dispo'));
    bindBtn(document.getElementById('btn-cadete-dispo-desktop'));

    function initState(){
      const initial = "{% if user.is_authenticated and user.cadeteprofile and user.cadeteprofile.disponible %}1{% else %}0{% endif %}";
      const val = (initial === '1');
      applyDisponibilidadToUI(val);
      if (val) ensurePushRegistered();
    }
    initState();
  })();
</script>

    <!-- Debug overflow opcional -->
    <script>
      (function(){
        if (!/debug-overflow=1/.test(location.search)) return;
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const sw = Math.max(document.documentElement.scrollWidth, document.body.scrollWidth);
        console.log('[overflow-check] viewport=', vw, 'scrollWidth=', sw);
        if (sw > vw) {
          document.querySelectorAll('body *').forEach(el => {
            const w = el.scrollWidth;
            if (w > vw) { el.style.outline = '1px dashed red'; console.log('Overflow:', el, '->', w); }
          });
        } else {
          console.log('Sin overflow horizontal 👍');
        }
      })();
    </script>

    {# ===== WS: actualiza el banner de tienda en vivo ===== #}
    {# ===== WS: actualiza el banner de tienda en vivo + fallback polling ===== #}
<script>
  (function(){
    const banner = document.getElementById('tienda-banner');
    if(!banner) return;

    const textEl = document.getElementById('tienda-banner-text');
    const URL_ESTADO = "{% url 'tienda_estado_json' %}";
    const HORARIO_TXT = "13–16 hs y 21–00 hs";
    //const THRESH = "{{ FREE_SHIPPING_THRESHOLD|floatformat:0 }}";

    function shippingHTML(){
  return "";  // ← Envío gratis DESACTIVADO
}

    function applyBannerState(isOpen){
      banner.dataset.open = isOpen ? "1" : "0";
      banner.classList.toggle("alert-success", !!isOpen);
      banner.classList.toggle("alert-warning", !isOpen);

      textEl.innerHTML = isOpen
        ? "<strong>🟢 Estamos tomando pedidos online ahora.</strong>"
        : "<strong>🔴 No estamos tomando pedidos online en este momento.</strong>";

      const help = banner.querySelector(".small-help");
      if (help){
        help.innerHTML = isOpen
          ? `Podés ver el catálogo y armar el carrito.${shippingHTML()}`
          : `Podés ver el catálogo y armar el carrito. El checkout se habilita cuando abrimos: <strong>${HORARIO_TXT}</strong>.${shippingHTML()}`;
      }
    }

    // Estado inicial de lo que vino del server
    applyBannerState(banner.dataset.open === "1");

    // ---- Polling seguro (sin romper nada si no hay WS)
    async function fetchEstado(){
      try{
        const r = await fetch(URL_ESTADO, {cache: "no-store", headers: {"X-Requested-With":"XMLHttpRequest"}});
        if(!r.ok) return;
        const j = await r.json();
        if (j && typeof j.abierta === "boolean"){
          applyBannerState(j.abierta);
        }
      }catch(_){}
    }

    // Arranca sincronizado y refresca cada 30s
    fetchEstado();
    const pollTimer = setInterval(fetchEstado, 30000);
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) fetchEstado(); });

    // ---- WebSocket (si está disponible llega “en vivo”)
    try{
      const wsProtocol = (location.protocol === "https:") ? "wss://" : "ws://";
      const websocketUrl = wsProtocol + location.host + "/ws/pedidos/notifications/";
      const sock = new WebSocket(websocketUrl);

      sock.onmessage = function(e){
        try{
          const data = JSON.parse(e.data || "{}");
          if (data && data.message === "tienda_estado" && data.order_data){
            applyBannerState(!!data.order_data.abierta);
          }
        }catch(_){}
      };

      // si el WS se cierra, el polling ya queda cubriendo el estado
      sock.onclose = function(){ /* noop */ };
    }catch(_){ /* si falla WS, queda el polling */ }

    // Limpieza si el usuario cierra el banner manualmente
    banner.addEventListener("closed.bs.alert", ()=> clearInterval(pollTimer));
  })();
</script>


    <!-- ===== GEO: versión NO bloqueante con guardas de config ===== -->
    <script>
      (function(){
        // --- Tomar config del DOM
        const cfg = document.getElementById('geo-config');
        const STORE = cfg ? {
          lat: Number(cfg.dataset.storeLat),
          lng: Number(cfg.dataset.storeLng)
        } : null;
        const RADIUS_KM = cfg ? Number(cfg.dataset.deliveryRadiusKm) : 0;

        // ⚠️ SI NO HAY RADIO o COORDS → NO BLOQUEES NADA
        if (!cfg || !STORE || isNaN(STORE.lat) || isNaN(STORE.lng) || !RADIUS_KM) {
          console.warn('[geo] Config incompleta. Saltando geocerca (no se bloquea UI).');
          return;
        }

        // --- CSRF (scope propio)
        function getCookieGeo(name){
          const v = `; ${document.cookie}`.split(`; ${name}=`);
          if (v.length === 2) return v.pop().split(';').shift();
        }
        const csrftoken = getCookieGeo('csrftoken');

        const API_SET = "{% url 'api_set_location' %}";
        const API_CAN = "{% url 'api_can_order' %}";
        const LS_KEY = 'geo_last_v1';

        // Modal NO bloqueante
        function showOutOfRangeModal(distKm){
          const msg = document.getElementById('geo-out-msg');
          if (msg) {
            const txt = (typeof distKm === 'number' && !isNaN(distKm))
              ? `Estás a ${distKm.toFixed(2)} km del local (radio ${RADIUS_KM} km).`
              : `Estás fuera del radio permitido (radio ${RADIUS_KM} km).`;
            msg.textContent = txt;
          }
          const modalEl = document.getElementById('geoOutModal');
          if (!modalEl) return;
          const modal = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true });
          modal.show();
        }

        async function postJSON(url, data){
          const r = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type':'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With':'XMLHttpRequest'
            },
            body: JSON.stringify(data)
          });
          return r.json();
        }

        async function checkCoverage(){
          const r = await fetch(API_CAN, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          return r.json();
        }

        async function sendPosition(lat,lng){
          const j = await postJSON(API_SET, {lat, lng});
          localStorage.setItem(LS_KEY, JSON.stringify({lat, lng, ts: Date.now()}));
          if (j && j.ok && j.can_order === false) {
            const km = (j.distance_km != null) ? Number(j.distance_km) : NaN;
            showOutOfRangeModal(km);
          }
        }

        // No bloquear si hay error/permiso denegado
        function onGeoError(err){
          console.warn('[geo] error/denied', err);
        }

        async function initGeo(){
          // Estado inicial por si ya conoce la ubicación en server
          try {
            const c0 = await checkCoverage();
            if (c0 && c0.can_order === false) {
              const km = (c0.distance_km != null) ? Number(c0.distance_km) : NaN;
              showOutOfRangeModal(km);
            }
          } catch (_){}

          if (!navigator.geolocation) return;

          const last = JSON.parse(localStorage.getItem(LS_KEY) || 'null');

          navigator.geolocation.getCurrentPosition(async pos=>{
            const { latitude, longitude } = pos.coords;
            if (last && Math.abs(last.lat - latitude) < 0.0008 && Math.abs(last.lng - longitude) < 0.0008) {
              try {
                const c1 = await checkCoverage();
                if (c1 && c1.can_order === false) {
                  const km = (c1.distance_km != null) ? Number(c1.distance_km) : NaN;
                  showOutOfRangeModal(km);
                }
              } catch (_){}
              return;
            }
            await sendPosition(latitude, longitude);
          }, onGeoError, { enableHighAccuracy:false, timeout:7000, maximumAge:120000 });
        }

        document.addEventListener('DOMContentLoaded', initGeo);
      })();
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
